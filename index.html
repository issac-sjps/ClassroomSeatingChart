<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å®¤åº§ä½ç³»çµ± - æ•™å¸«ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
            from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } 
            from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBAbSddZ6VsHjw-NjW77kxS8iuC5-cW_wY",
            authDomain: "sjps-classroomseatchart.firebaseapp.com",
            projectId: "sjps-classroomseatchart",
            storageBucket: "sjps-classroomseatchart.firebasestorage.app",
            messagingSenderId: "812781751431",
            appId: "1:812781751431:web:3cad939d2c29fbbde67c22",
            measurementId: "G-Q74G95W8P8"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // è®“å…¨åŸŸå¯ä»¥å­˜å–
        window._firebaseAuth = auth;
        window._firebaseDb = db;
        window._GoogleAuthProvider = GoogleAuthProvider;
        window._signInWithPopup = signInWithPopup;
        window._signOut = signOut;
        window._onAuthStateChanged = onAuthStateChanged;
        window._firestoreDoc = doc;
        window._firestoreSetDoc = setDoc;
        window._firestoreGetDoc = getDoc;
        window._firestoreCollection = collection;

        // é€šçŸ¥ Firebase å·²æº–å‚™å¥½
        window.dispatchEvent(new Event('firebaseReady'));
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Space+Mono:wght@400;700&display=swap');

        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d27;
            --bg-card: #20243a;
            --accent-blue: #4f8ef7;
            --accent-teal: #2dd4bf;
            --accent-pink: #f472b6;
            --accent-yellow: #fbbf24;
            --text-primary: #e8eaf6;
            --text-secondary: #8892b0;
            --border: rgba(79, 142, 247, 0.2);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            margin: 0;
        }

        /* â”€â”€ ç™»å…¥ç•«é¢ â”€â”€ */
        #loginScreen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: 
                radial-gradient(ellipse 80% 60% at 20% 40%, rgba(79,142,247,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 60% 50% at 80% 80%, rgba(45,212,191,0.08) 0%, transparent 60%),
                var(--bg-primary);
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 3rem 2.5rem;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 0 60px rgba(79,142,247,0.08), 0 20px 60px rgba(0,0,0,0.4);
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-teal), var(--accent-pink));
        }

        .login-logo {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .login-title {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            letter-spacing: 0.05em;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: white;
            color: #333;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .google-btn:active { transform: translateY(0); }

        .setup-notice {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(251,191,36,0.1);
            border: 1px solid rgba(251,191,36,0.3);
            border-radius: 10px;
            font-size: 0.8rem;
            color: var(--accent-yellow);
            text-align: left;
        }

        .setup-notice code {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
        }

        /* â”€â”€ ä¸»ç•«é¢ Header â”€â”€ */
        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0.875rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .brand-name {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 2px solid var(--accent-teal);
            object-fit: cover;
        }

        .user-name {
            font-size: 0.875rem;
            color: var(--text-secondary);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .signout-btn {
            padding: 0.4rem 0.875rem;
            background: rgba(244,114,182,0.15);
            border: 1px solid rgba(244,114,182,0.3);
            color: var(--accent-pink);
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .signout-btn:hover {
            background: rgba(244,114,182,0.25);
        }

        /* â”€â”€ ç­ç´šé¸æ“‡ â”€â”€ */
        .class-selector-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .class-tab {
            padding: 0.5rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            color: var(--text-secondary);
            background: transparent;
        }

        .class-tab:hover {
            border-color: var(--border);
            color: var(--text-primary);
        }

        .class-tab.active {
            background: rgba(79,142,247,0.15);
            border-color: rgba(79,142,247,0.4);
            color: var(--accent-blue);
        }

        .add-class-btn {
            padding: 0.5rem 1rem;
            background: rgba(45,212,191,0.1);
            border: 1px dashed rgba(45,212,191,0.4);
            color: var(--accent-teal);
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-class-btn:hover {
            background: rgba(45,212,191,0.2);
        }

        .sync-status {
            margin-left: auto;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .sync-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .sync-dot.syncing {
            background: var(--accent-yellow);
            animation: pulse-yellow 0.8s infinite;
        }

        @keyframes pulse-yellow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* â”€â”€ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« â”€â”€ */
        .control-panel {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0.875rem 1.5rem;
        }

        .btn {
            padding: 0.45rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-blue {
            background: rgba(79,142,247,0.15);
            border-color: rgba(79,142,247,0.35);
            color: var(--accent-blue);
        }

        .btn-blue:hover, .btn-blue.active {
            background: rgba(79,142,247,0.3);
            border-color: var(--accent-blue);
        }

        .btn-teal {
            background: rgba(45,212,191,0.1);
            border-color: rgba(45,212,191,0.3);
            color: var(--accent-teal);
        }

        .btn-teal:hover {
            background: rgba(45,212,191,0.2);
        }

        .btn-pink {
            background: rgba(244,114,182,0.1);
            border-color: rgba(244,114,182,0.3);
            color: var(--accent-pink);
        }

        .btn-pink:hover {
            background: rgba(244,114,182,0.2);
        }

        .btn-yellow {
            background: rgba(251,191,36,0.1);
            border-color: rgba(251,191,36,0.3);
            color: var(--accent-yellow);
        }

        .btn-yellow:hover {
            background: rgba(251,191,36,0.2);
        }

        .btn-gray {
            background: rgba(136,146,176,0.1);
            border-color: rgba(136,146,176,0.2);
            color: var(--text-secondary);
        }

        .btn-gray:hover {
            background: rgba(136,146,176,0.2);
            color: var(--text-primary);
        }

        /* â”€â”€ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â”€â”€ */
        .main-content {
            display: flex;
            height: calc(100vh - 170px);
            overflow: hidden;
        }

        /* â”€â”€ å­¦ç”Ÿãƒªã‚¹ãƒˆ â”€â”€ */
        .student-panel {
            width: 260px;
            flex-shrink: 0;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        #studentList {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            align-content: start;
        }

        #studentList::-webkit-scrollbar { width: 4px; }
        #studentList::-webkit-scrollbar-track { background: transparent; }
        #studentList::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .student-chip {
            aspect-ratio: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            cursor: move;
            transition: all 0.2s;
            padding: 4px;
            text-align: center;
        }

        .student-chip:hover {
            border-color: var(--accent-blue);
            background: rgba(79,142,247,0.1);
            transform: scale(1.05);
        }

        .student-chip .num {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .student-chip .name {
            color: var(--text-primary);
            font-size: 0.6rem;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .student-chip .gender-dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            margin-top: 2px;
        }

        .gender-male { background: #60a5fa; }
        .gender-female { background: var(--accent-pink); }

        .student-chip.empty-slot {
            border-style: dashed;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .student-chip.empty-slot:hover {
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        /* â”€â”€ åº§å¸­ã‚¨ãƒªã‚¢ â”€â”€ */
        .classroom-panel {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .classroom-toolbar {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        #seatingArea {
            flex: 1;
            overflow: auto;
            padding: 1.5rem;
        }

        /* â”€â”€ åº§å¸­ â”€â”€ */
        .seat {
            width: 90px;
            height: 64px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }

        .seat:hover {
            border-color: var(--accent-blue);
            background: rgba(79,142,247,0.08);
        }

        .seat.occupied {
            background: rgba(79,142,247,0.08);
            border-color: rgba(79,142,247,0.35);
        }

        .seat.occupied:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 0 12px rgba(79,142,247,0.2);
        }

        .seat .seat-num {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            color: var(--accent-blue);
            font-weight: 700;
        }

        .seat .seat-name {
            color: var(--text-primary);
            font-size: 0.7rem;
            font-weight: 500;
        }

        .seat.drop-zone {
            border-color: var(--accent-teal) !important;
            background: rgba(45,212,191,0.12) !important;
            transform: scale(1.05);
        }

        .seat.dragging { opacity: 0.5; transform: rotate(3deg) scale(1.1); }

        /* â”€â”€ è¬›å° â”€â”€ */
        .podium {
            text-align: center;
            padding: 0.75rem;
            background: rgba(79,142,247,0.08);
            border: 1px solid rgba(79,142,247,0.25);
            border-radius: 10px;
            margin: 0.5rem 0 1.25rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-blue);
            letter-spacing: 0.15em;
            font-family: 'Space Mono', monospace;
        }

        /* â”€â”€ é€šå¸¸åº§å¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€ */
        .normal-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 1rem;
        }

        .seat-group {
            display: flex;
            gap: 8px;
        }

        /* â”€â”€ ã‚°ãƒ«ãƒ¼ãƒ—åº§å¸­ â”€â”€ */
        .group-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .group-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            position: relative;
        }

        .group-label-btn {
            position: absolute;
            top: -12px; left: 12px;
            background: var(--bg-secondary);
            border: 1px solid rgba(45,212,191,0.4);
            color: var(--accent-teal);
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
        }

        .group-label-btn:hover {
            background: rgba(45,212,191,0.1);
        }

        /* â”€â”€ æŠ½ç±¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â”€â”€ */
        .lottery-flash {
            animation: lotteryFlash 0.3s ease-in-out infinite alternate;
        }

        @keyframes lotteryFlash {
            0% { background: rgba(251,191,36,0.2); border-color: var(--accent-yellow); }
            100% { background: rgba(251,191,36,0.4); border-color: #f59e0b; }
        }

        .lottery-selected {
            background: rgba(244,114,182,0.2) !important;
            border-color: var(--accent-pink) !important;
            box-shadow: 0 0 16px rgba(244,114,182,0.3) !important;
            animation: pulse-selected 2s ease-in-out infinite;
        }

        @keyframes pulse-selected {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.04); }
        }

        /* â”€â”€ ã‚¿ã‚¤ãƒãƒ¼ â”€â”€ */
        .timer-display {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent-teal);
            min-width: 70px;
            text-align: center;
        }

        .timer-display.urgent {
            color: var(--accent-pink);
            animation: pulse-urgent 0.5s ease-in-out infinite;
        }

        @keyframes pulse-urgent {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* â”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .modal-overlay.show { display: flex; }

        .modal-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.75rem;
            width: 100%;
            max-width: 440px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            position: relative;
        }

        .modal-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-teal));
            border-radius: 16px 16px 0 0;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }

        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: 'Noto Sans TC', sans-serif;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .form-select:focus { outline: none; border-color: var(--accent-blue); }

        /* â”€â”€ ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ â”€â”€ */
        .score-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.625rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .rank-badge {
            width: 26px; height: 26px;
            border-radius: 50%;
            background: rgba(79,142,247,0.2);
            border: 1px solid rgba(79,142,247,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--accent-blue);
            flex-shrink: 0;
        }

        .rank-1 { background: rgba(251,191,36,0.2); border-color: var(--accent-yellow); color: var(--accent-yellow); }
        .rank-2 { background: rgba(156,163,175,0.2); border-color: #9ca3af; color: #9ca3af; }
        .rank-3 { background: rgba(180,83,9,0.2); border-color: #d97706; color: #d97706; }

        .score-value {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            color: var(--accent-teal);
            font-size: 0.95rem;
        }

        /* â”€â”€ ä½œæ¥­ã‚¹ã‚¿ãƒ¼ â”€â”€ */
        .homework-stars {
            font-size: 0.55rem;
            line-height: 1;
        }

        /* â”€â”€ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° â”€â”€ */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .student-panel { width: 200px; }
            .seat { width: 72px; height: 52px; }
            #studentList { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" style="display:none;">
        <div class="login-card">
            <div class="login-logo">ğŸ“š ClassRoom</div>
            <div class="login-title">æ•™å¸«å°ˆç”¨åº§ä½ç®¡ç†ç³»çµ±</div>
            
            <button class="google-btn" id="googleLoginBtn">
                <svg width="20" height="20" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.6 20H24v8h11.3C33.9 32.4 29.4 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.8 1.1 7.9 3l5.7-5.7C34 6.2 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 19.7-8 19.7-20 0-1.3-.1-2.7-.1-4z"/>
                    <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 15.7 19 13 24 13c3 0 5.8 1.1 7.9 3l5.7-5.7C34 6.2 29.3 4 24 4 16.3 4 9.7 8.3 6.3 14.7z"/>
                    <path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.8 13.5-4.7L31 33.8C28.9 35.2 26.6 36 24 36c-5.3 0-9.8-3.6-11.3-8.5L6 32.3C9.4 38.8 16.2 44 24 44z"/>
                    <path fill="#1976D2" d="M43.6 20H24v8h11.3c-.7 2-2 3.8-3.7 5l6.5 5.5C41.7 34.9 44 29.9 44 24c0-1.3-.2-2.7-.4-4z"/>
                </svg>
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>

            <div class="setup-notice">
                âš™ï¸ <strong>é¦–æ¬¡ä½¿ç”¨è«‹å…ˆè¨­å®š Firebaseï¼š</strong><br>
                1. å‰å¾€ <a href="https://console.firebase.google.com/" target="_blank" style="color:inherit">console.firebase.google.com</a><br>
                2. å»ºç«‹æ–°å°ˆæ¡ˆ â†’ æ–°å¢ç¶²é æ‡‰ç”¨ç¨‹å¼<br>
                3. å•Ÿç”¨ Authenticationï¼ˆGoogle ç™»å…¥ï¼‰<br>
                4. å•Ÿç”¨ Firestore Database<br>
                5. å°‡è¨­å®šè²¼å…¥ <code>firebaseConfig</code>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
    <div id="appScreen" style="display:none;">

        <!-- Header -->
        <header class="app-header">
            <div class="header-brand">
                <div class="brand-icon">ğŸ“š</div>
                <div>
                    <div class="brand-name">ClassRoom</div>
                </div>
            </div>
            <div class="header-user">
                <img id="userAvatar" class="user-avatar" src="" alt="">
                <span id="userName" class="user-name"></span>
                <button class="signout-btn" id="signoutBtn">ç™»å‡º</button>
            </div>
        </header>

        <!-- ç­ç´šã‚¿ãƒ–ãƒãƒ¼ -->
        <div class="class-selector-bar">
            <div id="classTabs" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
            <button class="add-class-btn" id="addClassBtn">ï¼‹ æ–°å¢ç­ç´š</button>
            <div class="sync-status">
                <div class="sync-dot" id="syncDot"></div>
                <span id="syncText" style="color:var(--text-secondary); font-size:0.75rem;">å·²åŒæ­¥</span>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="control-panel">
            <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                <!-- åº§å¸­ãƒ¢ãƒ¼ãƒ‰ -->
                <div style="display:flex; gap:6px;">
                    <button class="btn btn-blue active" id="normalMode">ä¸€èˆ¬åº§ä½</button>
                    <button class="btn btn-gray" id="groupMode">å°çµ„åº§ä½</button>
                    <button class="btn btn-gray" id="examMode">è€ƒè©¦åº§ä½</button>
                </div>

                <div style="width:1px; height:24px; background:var(--border); margin:0 4px;"></div>

                <!-- æ©Ÿèƒ½ãƒœã‚¿ãƒ³ -->
                <button class="btn btn-teal" id="studentViewBtn">å­¸ç”Ÿè¦–è§’</button>
                <button class="btn btn-blue" id="showScoresBtn">å€‹äººç©åˆ†</button>
                <button class="btn btn-blue" id="showGroupScoresBtn">å°çµ„ç©åˆ†</button>

                <div style="width:1px; height:24px; background:var(--border); margin:0 4px;"></div>

                <!-- ã‚¿ã‚¤ãƒãƒ¼ -->
                <button class="btn btn-teal" id="timerBtn">â± è¨ˆæ™‚å™¨</button>
                <span class="timer-display hidden" id="timerDisplay">00:00</span>
                <button class="btn btn-yellow hidden" id="pauseTimer">æš«åœ</button>
                <button class="btn btn-pink hidden" id="stopTimer">åœæ­¢</button>

                <div style="width:1px; height:24px; background:var(--border); margin:0 4px;"></div>

                <!-- æŠ½ç±¤ -->
                <span style="font-size:0.78rem; color:var(--text-secondary);">æŠ½</span>
                <input type="number" id="lotteryCount" value="1" min="1" max="10"
                    style="width:44px; padding:4px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); text-align:center; font-size:0.8rem;">
                <span style="font-size:0.78rem; color:var(--text-secondary);">äºº</span>
                <button class="btn btn-yellow" id="lotteryAll">å…¨éƒ¨æŠ½ç±¤</button>
                <button class="btn btn-blue" id="lotteryBoys">ç”·ç”ŸæŠ½ç±¤</button>
                <button class="btn btn-pink" id="lotteryGirls">å¥³ç”ŸæŠ½ç±¤</button>
                <button class="btn btn-gray hidden" id="clearSelection">å–æ¶ˆæ¨™è¨˜</button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">

            <!-- å­¦ç”Ÿãƒ‘ãƒãƒ« -->
            <div class="student-panel">
                <div class="panel-header">
                    <span class="panel-title">å­¸ç”Ÿåå–®</span>
                    <div style="display:flex; gap:6px;">
                        <button class="btn btn-teal" id="editStudentsBtn" style="padding:3px 8px; font-size:0.7rem;">ç·¨è¼¯</button>
                        <button class="btn btn-blue" id="exportBtn" style="padding:3px 8px; font-size:0.7rem;">åŒ¯å‡º</button>
                    </div>
                </div>
                <div id="studentList"></div>
            </div>

            <!-- æ•™å®¤ãƒ‘ãƒãƒ« -->
            <div class="classroom-panel">
                <div class="classroom-toolbar">
                    <span style="font-size:0.8rem; color:var(--text-secondary); font-family:'Space Mono',monospace;" id="currentModeLabel">ä¸€èˆ¬åº§ä½æ¨¡å¼</span>
                    <button class="btn btn-teal" id="randomSeatingBtn" style="margin-left:auto;">ğŸ”€ éš¨æ©Ÿå…¥åº§</button>
                    <button class="btn btn-pink" id="resetSeatsBtn">é‡ç½®åº§ä½</button>
                </div>
                <div id="seatingArea"></div>
            </div>

        </div>
    </div>

    <!-- â•â•â• ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ â•â•â• -->

    <!-- ç­ç´šè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="addClassModal">
        <div class="modal-box" style="max-width:360px;">
            <div class="modal-title">æ–°å¢ç­ç´š</div>
            <div style="margin-bottom:1rem;">
                <label class="form-label">ç­ç´šåç¨±</label>
                <input type="text" id="newClassName" class="form-input" placeholder="ä¾‹ï¼šä¸‰å¹´ä¸€ç­ã€301">
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-blue" id="confirmAddClass" style="flex:1; padding:0.625rem;">ç¢ºèªæ–°å¢</button>
                <button class="btn btn-gray" id="cancelAddClass" style="padding:0.625rem 1rem;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- í•™ìƒ í¸ì§‘ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="editStudentModal">
        <div class="modal-box" style="max-width:380px;">
            <div class="modal-title" id="editModalTitle">ç·¨è¼¯å­¸ç”Ÿ</div>
            <div style="display:flex; flex-direction:column; gap:0.875rem; margin-bottom:1.25rem;">
                <div>
                    <label class="form-label">åº§è™Ÿ</label>
                    <input type="number" id="editSeatNum" class="form-input">
                </div>
                <div>
                    <label class="form-label">å§“å</label>
                    <input type="text" id="editName" class="form-input">
                </div>
                <div>
                    <label class="form-label">æ€§åˆ¥</label>
                    <select id="editGender" class="form-select">
                        <option value="male">ç”·ç”Ÿ ğŸ”µ</option>
                        <option value="female">å¥³ç”Ÿ ğŸ”´</option>
                    </select>
                </div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-blue" id="saveStudentBtn" style="flex:1; padding:0.625rem;">å„²å­˜</button>
                <button class="btn btn-pink" id="deleteStudentBtn" style="padding:0.625rem 1rem;">åˆªé™¤</button>
                <button class="btn btn-gray" id="cancelEditStudent" style="padding:0.625rem 1rem;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼‰ -->
    <div class="modal-overlay" id="studentSettingsModal">
        <div class="modal-box">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:1.25rem;">
                <div>
                    <div class="modal-title" style="margin-bottom:2px;" id="settingsName"></div>
                    <div style="font-family:'Space Mono',monospace; font-size:1.1rem; color:var(--accent-teal);" id="settingsScore"></div>
                </div>
            </div>

            <!-- ç©åˆ†èª¿æ•´ -->
            <div style="background:var(--bg-secondary); border-radius:10px; padding:1rem; margin-bottom:1rem;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:0.75rem; justify-content:center;">
                    <input type="number" id="settingsScoreAmt" value="1" min="1" max="10"
                        style="width:48px; text-align:center; background:var(--bg-card); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); padding:4px;">
                    <span style="color:var(--text-secondary); font-size:0.8rem;">åˆ†</span>
                </div>
                <div style="display:flex; gap:6px; justify-content:center; margin-bottom:0.625rem;">
                    <button class="btn btn-gray settings-qs" data-s="1" style="padding:3px 8px; font-size:0.7rem;">1åˆ†</button>
                    <button class="btn btn-gray settings-qs" data-s="2" style="padding:3px 8px; font-size:0.7rem;">2åˆ†</button>
                    <button class="btn btn-gray settings-qs" data-s="3" style="padding:3px 8px; font-size:0.7rem;">3åˆ†</button>
                    <button class="btn btn-gray settings-qs" data-s="5" style="padding:3px 8px; font-size:0.7rem;">5åˆ†</button>
                </div>
                <div style="display:flex; gap:8px; justify-content:center; margin-bottom:0.75rem;">
                    <button class="btn btn-teal" id="settingsAddBtn" style="padding:0.5rem 1.25rem; font-size:0.9rem;">ï¼‹åŠ åˆ†</button>
                    <button class="btn btn-pink" id="settingsSubBtn" style="padding:0.5rem 1.25rem; font-size:0.9rem;">ï¼æ‰£åˆ†</button>
                </div>
                <!-- å¿«é€ŸåŸå›  -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:0.625rem;">
                    <button class="btn btn-teal settings-reason" data-r="å›ç­”å•é¡Œ" style="padding:4px 8px; font-size:0.72rem;">å›ç­”å•é¡Œ</button>
                    <button class="btn btn-teal settings-reason" data-r="å¹«è€å¸«å¿™" style="padding:4px 8px; font-size:0.72rem;">å¹«è€å¸«å¿™</button>
                    <button class="btn btn-pink settings-reason" data-r="ä¸Šèª²èŠå¤©" style="padding:4px 8px; font-size:0.72rem;">ä¸Šèª²èŠå¤©</button>
                    <button class="btn btn-pink settings-reason" data-r="ä½œæ¥­æ²’å¯«" style="padding:4px 8px; font-size:0.72rem;">ä½œæ¥­æ²’å¯«</button>
                </div>
                <textarea id="settingsReason" class="form-input" rows="2" placeholder="åŸå› èªªæ˜..." style="resize:none; font-size:0.82rem;"></textarea>
                <button class="btn btn-blue" id="settingsConfirmScore" style="width:100%; padding:0.5rem; margin-top:0.625rem;">ç¢ºèªç©åˆ†èª¿æ•´</button>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:1rem;">
                <button class="btn btn-blue" id="settingsHistoryBtn" style="font-size:0.75rem; padding:0.5rem;">çæ‡²è¨˜éŒ„</button>
                <button class="btn btn-gray" id="settingsEditBtn" style="font-size:0.75rem; padding:0.5rem;">ç·¨è¼¯è³‡æ–™</button>
                <button class="btn btn-yellow" id="settingsHomeworkBtn" style="font-size:0.75rem; padding:0.5rem;">ä½œæ¥­ç®¡ç†</button>
            </div>

            <button class="btn btn-gray" id="closeSettingsModal" style="width:100%; padding:0.5rem;">é—œé–‰</button>
        </div>
    </div>

    <!-- å€‹äººç©åˆ†æ’è¡Œ -->
    <div class="modal-overlay" id="scoresModal">
        <div class="modal-box">
            <div class="modal-title">å€‹äººç©åˆ†æ’è¡Œæ¦œ</div>
            <div id="scoresList" style="max-height:360px; overflow-y:auto;"></div>
            <div style="display:flex; gap:8px; margin-top:1rem;">
                <button class="btn btn-pink" id="resetAllScoresBtn" style="padding:0.5rem 1rem;">é‡ç½®å…¨éƒ¨ç©åˆ†</button>
                <button class="btn btn-gray" id="closeScoresModal" style="flex:1; padding:0.5rem;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- å°çµ„ç©åˆ† -->
    <div class="modal-overlay" id="groupScoresModal">
        <div class="modal-box">
            <div class="modal-title">å°çµ„ç©åˆ†æ’è¡Œæ¦œ</div>
            <div id="groupScoresList" style="max-height:360px; overflow-y:auto;"></div>
            <div style="display:flex; gap:8px; margin-top:1rem;">
                <button class="btn btn-pink" id="resetGroupScoresBtn" style="padding:0.5rem 1rem;">é‡ç½®å°çµ„ç©åˆ†</button>
                <button class="btn btn-gray" id="closeGroupScoresModal" style="flex:1; padding:0.5rem;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- å°çµ„åŠ åˆ†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="groupScoreModal">
        <div class="modal-box" style="max-width:380px;">
            <div class="modal-title" id="groupModalTitle">ç¬¬1çµ„ ç©åˆ†èª¿æ•´</div>
            <div style="display:flex; align-items:center; gap:8px; justify-content:center; margin-bottom:0.75rem;">
                <input type="number" id="groupScoreAmt" value="1" min="1" max="10"
                    style="width:48px; text-align:center; background:var(--bg-secondary); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); padding:4px;">
                <span style="color:var(--text-secondary); font-size:0.8rem;">åˆ†</span>
            </div>
            <div style="display:flex; gap:8px; justify-content:center; margin-bottom:0.875rem;">
                <button class="btn btn-teal" id="addGroupScoreBtn" style="padding:0.5rem 1.5rem;">ï¼‹åŠ åˆ†</button>
                <button class="btn btn-pink" id="subtractGroupScoreBtn" style="padding:0.5rem 1.5rem;">ï¼æ‰£åˆ†</button>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:0.625rem;">
                <button class="btn btn-teal group-reason-btn" data-r="è¨è«–ç©æ¥µ" style="font-size:0.72rem; padding:5px;">è¨è«–ç©æ¥µ</button>
                <button class="btn btn-teal group-reason-btn" data-r="åˆä½œè‰¯å¥½" style="font-size:0.72rem; padding:5px;">åˆä½œè‰¯å¥½</button>
                <button class="btn btn-pink group-reason-btn" data-r="è¨è«–åµé¬§" style="font-size:0.72rem; padding:5px;">è¨è«–åµé¬§</button>
                <button class="btn btn-pink group-reason-btn" data-r="ä¸åƒèˆ‡è¨è«–" style="font-size:0.72rem; padding:5px;">ä¸åƒèˆ‡è¨è«–</button>
            </div>
            <textarea id="groupScoreReason" class="form-input" rows="2" placeholder="åŸå› èªªæ˜..." style="resize:none; margin-bottom:0.875rem;"></textarea>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-blue" id="confirmGroupScore" style="flex:1; padding:0.5rem;">ç¢ºèª</button>
                <button class="btn btn-gray" id="cancelGroupScore" style="padding:0.5rem 1rem;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ã‚¿ã‚¤ãƒãƒ¼è¨­å®š -->
    <div class="modal-overlay" id="timerModal">
        <div class="modal-box" style="max-width:360px;">
            <div class="modal-title">è¨­å®šå€’æ•¸è¨ˆæ™‚å™¨</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:1rem;">
                <div>
                    <label class="form-label">æ™‚</label>
                    <input type="number" id="timerH" value="0" min="0" max="23" class="form-input" style="text-align:center;">
                </div>
                <div>
                    <label class="form-label">åˆ†</label>
                    <input type="number" id="timerM" value="5" min="0" max="59" class="form-input" style="text-align:center;">
                </div>
                <div>
                    <label class="form-label">ç§’</label>
                    <input type="number" id="timerS" value="0" min="0" max="59" class="form-input" style="text-align:center;">
                </div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:1rem;">
                <button class="btn btn-gray quick-time" data-m="1" style="font-size:0.75rem;">1åˆ†é˜</button>
                <button class="btn btn-gray quick-time" data-m="5" style="font-size:0.75rem;">5åˆ†é˜</button>
                <button class="btn btn-gray quick-time" data-m="10" style="font-size:0.75rem;">10åˆ†é˜</button>
                <button class="btn btn-gray quick-time" data-m="15" style="font-size:0.75rem;">15åˆ†é˜</button>
                <button class="btn btn-gray quick-time" data-m="30" style="font-size:0.75rem;">30åˆ†é˜</button>
                <button class="btn btn-gray quick-time" data-m="45" style="font-size:0.75rem;">45åˆ†é˜</button>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-teal" id="startTimerBtn" style="flex:1; padding:0.625rem;">é–‹å§‹è¨ˆæ™‚</button>
                <button class="btn btn-gray" id="cancelTimerBtn" style="padding:0.625rem 1rem;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ™‚é–“åˆ°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="timeUpModal">
        <div class="modal-box" style="text-align:center; max-width:320px;">
            <div style="font-size:3.5rem; margin-bottom:0.75rem;">â°</div>
            <div class="modal-title" style="color:var(--accent-pink); font-size:1.4rem;">æ™‚é–“åˆ°å›‰ï¼</div>
            <button class="btn btn-pink" id="closeTimeUpBtn" style="width:100%; padding:0.75rem; margin-top:1rem; font-size:1rem;">ç¢ºèª</button>
        </div>
    </div>

    <!-- ç©åˆ†æ­´å²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-box">
            <div class="modal-title" id="historyTitle"></div>
            <div id="historyList" style="max-height:360px; overflow-y:auto;"></div>
            <button class="btn btn-gray" id="closeHistoryBtn" style="width:100%; padding:0.5rem; margin-top:1rem;">é—œé–‰</button>
        </div>
    </div>

    <!-- ä½œæ¥­ç®¡ç† -->
    <div class="modal-overlay" id="homeworkModal">
        <div class="modal-box">
            <div class="modal-title" id="homeworkTitle">ä½œæ¥­ç®¡ç†</div>
            <div id="homeworkList" style="max-height:200px; overflow-y:auto; margin-bottom:1rem; background:var(--bg-secondary); border-radius:8px; padding:0.75rem;"></div>
            <div style="display:flex; gap:8px; margin-bottom:1rem;">
                <input type="text" id="newHomeworkInput" class="form-input" placeholder="ä½œæ¥­åç¨±ï¼ˆä¾‹ï¼šæ•¸å­¸p.25ï¼‰" style="flex:1;">
                <button class="btn btn-blue" id="addHomeworkBtn" style="padding:0.5rem 0.875rem;">æ–°å¢</button>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-teal" id="saveHomeworkBtn" style="flex:1; padding:0.5rem;">å„²å­˜</button>
                <button class="btn btn-gray" id="closeHomeworkBtn" style="padding:0.5rem 1rem;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- å…¨å“¡ç·¨è¼¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="bulkEditModal">
        <div class="modal-box" style="max-width:500px;">
            <div class="modal-title">ç·¨è¼¯å­¸ç”Ÿåå–®</div>
            <div style="font-size:0.78rem; color:var(--text-secondary); margin-bottom:0.75rem;">
                é»æ“Šå­¸ç”Ÿå¯ç·¨è¼¯ï¼Œç©ºç™½æ ¼å¯æ–°å¢å­¸ç”Ÿ
            </div>
            <div id="bulkEditList" style="max-height:400px; overflow-y:auto; display:grid; grid-template-columns:repeat(5,1fr); gap:8px;"></div>
            <button class="btn btn-gray" id="closeBulkEdit" style="width:100%; padding:0.5rem; margin-top:1rem;">é—œé–‰</button>
        </div>
    </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ClassRoom System - Multi-teacher Firebase Version
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class ClassroomApp {
    constructor() {
        this.auth = null;
        this.db = null;
        this.currentUser = null;
        this.currentClassId = null;
        this.classes = {};            // { classId: { name, students, seats, scores, ... } }
        this.currentMode = 'normal';
        this.isStudentView = false;
        this.isSaving = false;
        this.saveTimer = null;
        this.editingStudentId = null;
        this.currentSettingsStudentId = null;
        this.currentGroupNumber = null;
        this.selectedSettingsScoreType = null;
        this.selectedGroupScoreType = null;
        this.isLotteryRunning = false;
        this.flashIntervals = [];
        this.selectedStudents = [];
        this.timerInterval = null;
        this.timerRemaining = 0;
        this.timerRunning = false;
        this.timerPaused = false;
        this.homeworkNotes = {};      // { studentId: [{name, date}] }

        this._waitForFirebase();
    }

    _waitForFirebase() {
        if (window._firebaseAuth) {
            this._init();
        } else {
            window.addEventListener('firebaseReady', () => this._init());
        }
    }

    async _init() {
        this.auth = window._firebaseAuth;
        this.db = window._firebaseDb;

        window._onAuthStateChanged(this.auth, async (user) => {
            document.getElementById('loadingScreen').style.display = 'none';
            if (user) {
                this.currentUser = user;
                this._showApp(user);
                await this._loadUserData();
            } else {
                this.currentUser = null;
                this._showLogin();
            }
        });

        this._bindGlobalEvents();
    }

    _showLogin() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('appScreen').style.display = 'none';
    }

    _showApp(user) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'block';
        document.getElementById('userAvatar').src = user.photoURL || '';
        document.getElementById('userName').textContent = user.displayName || user.email;
    }

    // â”€â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async _loadUserData() {
        try {
            const ref = window._firestoreDoc(this.db, 'teachers', this.currentUser.uid);
            const snap = await window._firestoreGetDoc(ref);

            if (snap.exists()) {
                const data = snap.data();
                this.classes = data.classes || {};
                this.homeworkNotes = data.homeworkNotes || {};
            } else {
                // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ
                this.classes = {
                    'class_default': this._createDefaultClass('æˆ‘çš„ç­ç´š')
                };
                this.homeworkNotes = {};
                await this._saveToFirebase();
            }

            // æœ€åˆã®ã‚¯ãƒ©ã‚¹ã‚’é¸æŠ
            const classIds = Object.keys(this.classes);
            this.currentClassId = classIds[0] || null;

            this._renderClassTabs();
            this._renderAll();
        } catch (err) {
            console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', err);
            this._showOfflineMode();
        }
    }

    _createDefaultClass(name) {
        const students = {};
        for (let i = 1; i <= 15; i++) {
            students[`s${i}`] = { id: `s${i}`, seatNumber: i, name: `å­¸ç”Ÿ${i}`, gender: 'male' };
        }
        for (let i = 21; i <= 35; i++) {
            students[`s${i}`] = { id: `s${i}`, seatNumber: i, name: `å­¸ç”Ÿ${i}`, gender: 'female' };
        }
        return {
            name,
            students,
            normalSeats: {},
            groupSeats: {},
            examSeats: {},
            scores: {},
            scoreHistory: {},
            groupScores: {},
            groupScoreHistory: {},
            createdAt: Date.now()
        };
    }

    async _saveToFirebase() {
        if (!this.currentUser || !this.db) return;
        
        this._setSyncStatus('syncing');
        try {
            const ref = window._firestoreDoc(this.db, 'teachers', this.currentUser.uid);
            await window._firestoreSetDoc(ref, {
                email: this.currentUser.email,
                displayName: this.currentUser.displayName,
                classes: this.classes,
                homeworkNotes: this.homeworkNotes,
                updatedAt: Date.now()
            });
            this._setSyncStatus('synced');
        } catch (err) {
            console.error('å„²å­˜å¤±æ•—:', err);
            this._setSyncStatus('error');
        }
    }

    _scheduleSave() {
        clearTimeout(this.saveTimer);
        this.saveTimer = setTimeout(() => this._saveToFirebase(), 1500);
    }

    _setSyncStatus(status) {
        const dot = document.getElementById('syncDot');
        const text = document.getElementById('syncText');
        if (status === 'syncing') {
            dot.className = 'sync-dot syncing';
            text.textContent = 'åŒæ­¥ä¸­...';
        } else if (status === 'synced') {
            dot.className = 'sync-dot';
            text.textContent = 'å·²åŒæ­¥';
        } else {
            dot.className = 'sync-dot';
            dot.style.background = '#ef4444';
            text.textContent = 'åŒæ­¥å¤±æ•—';
        }
    }

    _showOfflineMode() {
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const saved = localStorage.getItem('classroom_offline_data');
        if (saved) {
            const data = JSON.parse(saved);
            this.classes = data.classes || {};
            this.homeworkNotes = data.homeworkNotes || {};
        } else {
            this.classes = { 'class_default': this._createDefaultClass('æˆ‘çš„ç­ç´š') };
            this.homeworkNotes = {};
        }
        const classIds = Object.keys(this.classes);
        this.currentClassId = classIds[0] || null;
        this._renderClassTabs();
        this._renderAll();
        document.getElementById('syncText').textContent = 'é›¢ç·šæ¨¡å¼';
    }

    // â”€â”€â”€ ç¾åœ¨ã®ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    get _cls() { return this.classes[this.currentClassId] || {}; }
    get _students() { return this._cls.students || {}; }
    get _seats() {
        const c = this._cls;
        if (this.currentMode === 'normal') return c.normalSeats || {};
        if (this.currentMode === 'group') return c.groupSeats || {};
        if (this.currentMode === 'exam') return c.examSeats || {};
        return {};
    }
    get _scores() { return this._cls.scores || {}; }
    get _groupScores() { return this._cls.groupScores || {}; }

    _setSeats(seats) {
        const c = this.classes[this.currentClassId];
        if (this.currentMode === 'normal') c.normalSeats = seats;
        else if (this.currentMode === 'group') c.groupSeats = seats;
        else if (this.currentMode === 'exam') c.examSeats = seats;
    }

    // â”€â”€â”€ ã‚¯ãƒ©ã‚¹ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _renderClassTabs() {
        const container = document.getElementById('classTabs');
        container.innerHTML = '';
        Object.entries(this.classes).forEach(([id, cls]) => {
            const btn = document.createElement('button');
            btn.className = 'class-tab' + (id === this.currentClassId ? ' active' : '');
            btn.textContent = cls.name;
            btn.onclick = () => { this.currentClassId = id; this._renderClassTabs(); this._renderAll(); };
            container.appendChild(btn);
        });
    }

    _renderAll() {
        this._renderStudentList();
        this._renderSeats();
    }

    // â”€â”€â”€ å­¦ç”Ÿãƒªã‚¹ãƒˆæç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _renderStudentList() {
        const container = document.getElementById('studentList');
        container.innerHTML = '';
        for (let i = 1; i <= 40; i++) {
            const student = Object.values(this._students).find(s => s.seatNumber === i);
            const chip = document.createElement('div');
            if (student) {
                chip.className = 'student-chip';
                chip.draggable = true;
                chip.dataset.studentId = student.id;
                const hw = (this.homeworkNotes[student.id] || []).length;
                chip.innerHTML = `
                    <div class="num">${student.seatNumber}</div>
                    <div class="name">${student.name.length > 3 ? student.name.slice(0,3) : student.name}</div>
                    <div class="gender-dot ${student.gender === 'male' ? 'gender-male' : 'gender-female'}"></div>
                    ${hw > 0 ? `<div style="font-size:0.5rem; color:var(--accent-yellow);">${'â˜…'.repeat(Math.min(hw,3))}</div>` : ''}
                `;
                chip.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', `student:${student.id}`);
                    chip.classList.add('dragging');
                });
                chip.addEventListener('dragend', () => chip.classList.remove('dragging'));
                let tt = 0;
                chip.addEventListener('dblclick', () => this._showStudentSettings(student.id));
                chip.addEventListener('touchend', e => {
                    const now = Date.now(); const d = now - tt;
                    if (d < 400 && d > 0) { e.preventDefault(); this._showStudentSettings(student.id); }
                    tt = now;
                });
            } else {
                chip.className = 'student-chip empty-slot';
                chip.innerHTML = `<div class="num" style="color:var(--text-secondary)">${i}</div><div style="color:var(--text-secondary);font-size:0.6rem;">ç©º</div>`;
                chip.onclick = () => this._showEditStudent(null, i);
            }
            container.appendChild(chip);
        }
    }

    // â”€â”€â”€ åº§å¸­æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _renderSeats() {
        const area = document.getElementById('seatingArea');
        area.innerHTML = '';

        if (this.isStudentView) {
            const podTop = document.createElement('div');
            podTop.className = 'podium';
            podTop.textContent = 'è¬› å°';
            area.appendChild(podTop);
        }

        if (this.currentMode === 'normal') this._renderNormal(area);
        else if (this.currentMode === 'group') this._renderGroup(area);
        else if (this.currentMode === 'exam') this._renderExam(area);

        if (!this.isStudentView) {
            const podBottom = document.createElement('div');
            podBottom.className = 'podium';
            podBottom.style.marginTop = '1.25rem';
            podBottom.style.marginBottom = '0';
            podBottom.textContent = 'è¬› å°';
            area.appendChild(podBottom);
        }
    }

    _renderNormal(container) {
        const rows = this.isStudentView ? [4,3,2,1,0] : [0,1,2,3,4];
        rows.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'normal-row';
            const order = this.isStudentView ? [5,4,3,2,1,0] : [0,1,2,3,4,5];
            for (let g = 0; g < 3; g++) {
                const grp = document.createElement('div');
                grp.className = 'seat-group';
                for (let k = 0; k < 2; k++) {
                    const col = order[g*2+k];
                    grp.appendChild(this._createSeat(row*6+col));
                }
                rowDiv.appendChild(grp);
            }
            container.appendChild(rowDiv);
        });
    }

    _renderGroup(container) {
        const gc = document.createElement('div');
        gc.className = 'group-container';
        const order = this.isStudentView ? [3,4,5,0,1,2] : [3,4,5,0,1,2];
        order.forEach(g => {
            const box = document.createElement('div');
            box.className = 'group-box';
            const lbl = document.createElement('button');
            lbl.className = 'group-label-btn';
            lbl.textContent = `ç¬¬${g+1}çµ„`;
            lbl.onclick = () => this._showGroupScoreModal(g+1);
            box.appendChild(lbl);
            const inner = document.createElement('div');
            inner.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:8px;padding-top:8px;';
            const seatRows = this.isStudentView ? [[3,4],[1,2],[0]] : [[0],[1,2],[3,4]];
            seatRows.forEach(sr => {
                const rDiv = document.createElement('div');
                rDiv.style.cssText = 'display:flex;gap:8px;';
                sr.forEach(s => rDiv.appendChild(this._createSeat(g*5+s)));
                inner.appendChild(rDiv);
            });
            box.appendChild(inner);
            gc.appendChild(box);
        });
        container.appendChild(gc);
    }

    _renderExam(container) {
        const rows = this.isStudentView ? [5,4,3,2,1,0] : [0,1,2,3,4,5];
        rows.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'normal-row';
            const order = this.isStudentView ? [5,4,3,2,1,0] : [0,1,2,3,4,5];
            order.forEach(col => rowDiv.appendChild(this._createSeat(row*6+col)));
            container.appendChild(rowDiv);
        });
    }

    _createSeat(position) {
        const el = document.createElement('div');
        el.className = 'seat';
        el.dataset.position = position;
        const seats = this._seats;
        const studentId = seats[position];
        if (studentId) {
            const st = this._students[studentId];
            if (st) {
                el.classList.add('occupied');
                const hw = (this.homeworkNotes[st.id] || []).length;
                const score = this._scores[st.id] || 0;
                el.innerHTML = `
                    <div class="seat-num">${st.seatNumber}</div>
                    <div class="seat-name">${st.name.length > 3 ? st.name.slice(0,3) : st.name}</div>
                    ${hw > 0 ? `<div class="homework-stars">${'â­'.repeat(Math.min(hw,4))}${hw>4?'+':''}</div>` : ''}
                `;
                let tt = 0;
                el.addEventListener('dblclick', () => { if (!this.isLotteryRunning) this._showStudentSettings(st.id); });
                el.addEventListener('touchend', e => {
                    const now = Date.now(); const d = now - tt;
                    if (d < 400 && d > 0) { e.preventDefault(); this._showStudentSettings(st.id); }
                    tt = now;
                });
            }
        } else {
            el.innerHTML = `<div style="color:var(--text-secondary);font-size:0.72rem;">ç©ºä½</div>`;
        }
        this._makeDraggable(el);
        this._makeDroppable(el);
        return el;
    }

    // â”€â”€â”€ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _makeDraggable(el) {
        el.draggable = true;
        el.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', `seat:${el.dataset.position}`);
            el.classList.add('dragging');
        });
        el.addEventListener('dragend', () => el.classList.remove('dragging'));
    }

    _makeDroppable(el) {
        el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drop-zone'); });
        el.addEventListener('dragleave', () => el.classList.remove('drop-zone'));
        el.addEventListener('drop', e => {
            e.preventDefault();
            el.classList.remove('drop-zone');
            const data = e.dataTransfer.getData('text/plain');
            const toPos = parseInt(el.dataset.position);
            const seats = { ...this._seats };

            if (data.startsWith('student:')) {
                const sid = data.replace('student:', '');
                Object.keys(seats).forEach(p => { if (seats[p] === sid) delete seats[p]; });
                seats[toPos] = sid;
            } else if (data.startsWith('seat:')) {
                const fromPos = parseInt(data.replace('seat:', ''));
                const temp = seats[fromPos];
                seats[fromPos] = seats[toPos];
                seats[toPos] = temp;
                if (seats[fromPos] === undefined) delete seats[fromPos];
                if (seats[toPos] === undefined) delete seats[toPos];
            }
            this._setSeats(seats);
            this._scheduleSave();
            this._renderAll();
        });
    }

    // â”€â”€â”€ å­¸ç”Ÿè¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _showStudentSettings(studentId) {
        const st = this._students[studentId];
        if (!st) return;
        this.currentSettingsStudentId = studentId;
        this.selectedSettingsScoreType = null;
        document.getElementById('settingsName').textContent = `${st.seatNumber}è™Ÿ ${st.name}`;
        document.getElementById('settingsScore').textContent = `${this._scores[studentId] || 0} åˆ†`;
        document.getElementById('settingsReason').value = '';
        document.getElementById('settingsScoreAmt').value = 1;
        this._showModal('studentSettingsModal');
    }

    _adjustStudentScore(type) {
        const amt = parseInt(document.getElementById('settingsScoreAmt').value) || 1;
        const reason = document.getElementById('settingsReason').value.trim();
        if (!reason) { alert('è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› '); return; }

        const studentId = this.currentSettingsStudentId;
        const cls = this.classes[this.currentClassId];
        if (!cls.scores) cls.scores = {};
        if (!cls.scoreHistory) cls.scoreHistory = {};
        if (!cls.scoreHistory[studentId]) cls.scoreHistory[studentId] = [];

        const change = type * amt;
        cls.scores[studentId] = (cls.scores[studentId] || 0) + change;
        cls.scoreHistory[studentId].push({
            date: new Date().toLocaleString('zh-TW'),
            change, reason, total: cls.scores[studentId]
        });

        document.getElementById('settingsScore').textContent = `${cls.scores[studentId]} åˆ†`;
        this._scheduleSave();
        this._renderAll();
    }

    // â”€â”€â”€ ã‚°ãƒ«ãƒ¼ãƒ—ã‚¹ã‚³ã‚¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _showGroupScoreModal(groupNum) {
        this.currentGroupNumber = groupNum;
        this.selectedGroupScoreType = null;
        document.getElementById('groupModalTitle').textContent = `ç¬¬${groupNum}çµ„ ç©åˆ†èª¿æ•´`;
        document.getElementById('groupScoreReason').value = '';
        document.getElementById('groupScoreAmt').value = 1;
        this._showModal('groupScoreModal');
    }

    _adjustGroupScore(type) {
        const amt = parseInt(document.getElementById('groupScoreAmt').value) || 1;
        const reason = document.getElementById('groupScoreReason').value.trim();
        if (!reason) { alert('è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› '); return; }

        const cls = this.classes[this.currentClassId];
        if (!cls.groupScores) cls.groupScores = {};
        if (!cls.groupScoreHistory) cls.groupScoreHistory = {};

        const g = this.currentGroupNumber;
        const change = type * amt;
        cls.groupScores[g] = (cls.groupScores[g] || 0) + change;
        if (!cls.groupScoreHistory[g]) cls.groupScoreHistory[g] = [];
        cls.groupScoreHistory[g].push({
            date: new Date().toLocaleString('zh-TW'), change, reason, total: cls.groupScores[g]
        });

        this._scheduleSave();
        this._hideModal('groupScoreModal');
        alert(`ç¬¬${g}çµ„ç©åˆ†ï¼š${change > 0 ? '+' : ''}${change}åˆ†\nç›®å‰ï¼š${cls.groupScores[g]}åˆ†`);
    }

    // â”€â”€â”€ æŠ½ç±¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _startLottery(type) {
        if (this.isLotteryRunning) return;
        this._clearSelection();
        const seats = this._seats;
        const eligible = [];
        Object.entries(seats).forEach(([pos, sid]) => {
            const st = this._students[sid];
            if (st && (type === 'all' || st.gender === type)) eligible.push({ pos, st });
        });
        const count = parseInt(document.getElementById('lotteryCount').value) || 1;
        if (!eligible.length) { alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿï¼'); return; }
        if (count > eligible.length) { alert(`å­¸ç”Ÿä¸è¶³${count}äºº`); return; }

        this.isLotteryRunning = true;
        this.flashIntervals = [];
        eligible.forEach(({ pos }) => {
            const el = document.querySelector(`[data-position="${pos}"]`);
            if (!el) return;
            const iv = setInterval(() => el.classList.toggle('lottery-flash'), 200 + Math.random() * 300);
            this.flashIntervals.push(iv);
        });

        setTimeout(() => {
            this.flashIntervals.forEach(iv => clearInterval(iv));
            this.flashIntervals = [];
            eligible.forEach(({ pos }) => {
                const el = document.querySelector(`[data-position="${pos}"]`);
                if (el) el.classList.remove('lottery-flash');
            });

            const shuffled = [...eligible].sort(() => Math.random() - 0.5);
            const winners = shuffled.slice(0, count);
            this.selectedStudents = winners;
            winners.forEach(({ pos }) => {
                const el = document.querySelector(`[data-position="${pos}"]`);
                if (el) el.classList.add('lottery-selected');
            });

            const nums = winners.map(w => w.st.seatNumber);
            this._speak(nums.length === 1 ? `æ­å–œ${nums[0]}è™Ÿ` : `æ­å–œ${nums.join('è™Ÿã€')}è™Ÿ`);
            document.getElementById('clearSelection').classList.remove('hidden');
            this.isLotteryRunning = false;
        }, 3000);
    }

    _clearSelection() {
        this.flashIntervals.forEach(iv => clearInterval(iv));
        this.flashIntervals = [];
        document.querySelectorAll('.lottery-selected,.lottery-flash').forEach(el => {
            el.classList.remove('lottery-selected', 'lottery-flash');
        });
        this.selectedStudents = [];
        document.getElementById('clearSelection').classList.add('hidden');
    }

    _speak(text) {
        if (!('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW'; u.rate = 0.9; u.pitch = 1.1;
        const voices = speechSynthesis.getVoices();
        const v = voices.find(v => v.name.includes('Google') && v.lang.includes('zh'));
        if (v) u.voice = v;
        speechSynthesis.speak(u);
    }

    // â”€â”€â”€ ã‚¿ã‚¤ãƒãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _startTimer() {
        const h = parseInt(document.getElementById('timerH').value) || 0;
        const m = parseInt(document.getElementById('timerM').value) || 0;
        const s = parseInt(document.getElementById('timerS').value) || 0;
        const total = h * 3600 + m * 60 + s;
        if (!total) { alert('è«‹è¨­å®šæœ‰æ•ˆæ™‚é–“'); return; }

        this.timerRemaining = total;
        this.timerRunning = true;
        this.timerPaused = false;
        this._hideModal('timerModal');

        const disp = document.getElementById('timerDisplay');
        const pauseBtn = document.getElementById('pauseTimer');
        const stopBtn = document.getElementById('stopTimer');
        disp.classList.remove('hidden');
        pauseBtn.classList.remove('hidden');
        stopBtn.classList.remove('hidden');

        const update = () => {
            const h2 = Math.floor(this.timerRemaining / 3600);
            const m2 = Math.floor((this.timerRemaining % 3600) / 60);
            const s2 = this.timerRemaining % 60;
            disp.textContent = h2 > 0
                ? `${String(h2).padStart(2,'0')}:${String(m2).padStart(2,'0')}:${String(s2).padStart(2,'0')}`
                : `${String(m2).padStart(2,'0')}:${String(s2).padStart(2,'0')}`;
            disp.className = 'timer-display' + (this.timerRemaining <= 10 && this.timerRemaining > 0 ? ' urgent' : '');
        };

        update();
        this.timerInterval = setInterval(() => {
            if (!this.timerPaused) {
                this.timerRemaining--;
                update();
                if (this.timerRemaining <= 0) {
                    clearInterval(this.timerInterval);
                    this.timerRunning = false;
                    disp.classList.add('hidden');
                    pauseBtn.classList.add('hidden');
                    stopBtn.classList.add('hidden');
                    this._playAlarm();
                    this._speak('æ™‚é–“åˆ°å›‰');
                    this._showModal('timeUpModal');
                }
            }
        }, 1000);
    }

    _playAlarm() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.setValueAtTime(880, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.3);
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    osc.start(); osc.stop(ctx.currentTime + 0.5);
                }, i * 600);
            }
        } catch(e) {}
    }

    // â”€â”€â”€ å­¸ç”Ÿç·¨è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _showEditStudent(studentId, defaultSeat = null) {
        this.editingStudentId = studentId;
        const st = studentId ? this._students[studentId] : null;
        document.getElementById('editModalTitle').textContent = st ? 'ç·¨è¼¯å­¸ç”Ÿ' : 'æ–°å¢å­¸ç”Ÿ';
        document.getElementById('editSeatNum').value = st ? st.seatNumber : (defaultSeat || '');
        document.getElementById('editName').value = st ? st.name : '';
        document.getElementById('editGender').value = st ? st.gender : 'male';
        document.getElementById('deleteStudentBtn').style.display = st ? 'inline' : 'none';
        this._showModal('editStudentModal');
    }

    _saveStudent() {
        const seatNumber = parseInt(document.getElementById('editSeatNum').value);
        const name = document.getElementById('editName').value.trim();
        const gender = document.getElementById('editGender').value;
        if (!name) { alert('è«‹è¼¸å…¥å§“å'); return; }

        const cls = this.classes[this.currentClassId];
        if (!cls.students) cls.students = {};

        if (this.editingStudentId) {
            const st = cls.students[this.editingStudentId];
            if (st) { st.seatNumber = seatNumber; st.name = name; st.gender = gender; }
        } else {
            const newId = `s${Date.now()}`;
            cls.students[newId] = { id: newId, seatNumber, name, gender };
        }

        this._scheduleSave();
        this._renderAll();
        this._hideModal('editStudentModal');
    }

    _deleteStudent() {
        if (!this.editingStudentId || !confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
        const cls = this.classes[this.currentClassId];
        const sid = this.editingStudentId;
        delete cls.students[sid];
        ['normalSeats','groupSeats','examSeats'].forEach(key => {
            const seats = cls[key] || {};
            Object.keys(seats).forEach(p => { if (seats[p] === sid) delete seats[p]; });
        });
        delete (cls.scores || {})[sid];
        delete (cls.scoreHistory || {})[sid];
        delete this.homeworkNotes[sid];
        this._scheduleSave();
        this._renderAll();
        this._hideModal('editStudentModal');
    }

    // â”€â”€â”€ ç©åˆ†ãƒ©ãƒ³ã‚­ãƒ³ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _showScores() {
        const students = Object.values(this._students)
            .map(st => ({ ...st, score: this._scores[st.id] || 0 }))
            .sort((a, b) => b.score - a.score);

        const list = document.getElementById('scoresList');
        list.innerHTML = '';
        students.forEach((st, i) => {
            const row = document.createElement('div');
            row.className = 'score-row';
            row.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;">
                    <div class="rank-badge ${i<3?'rank-'+(i+1):''}">${i+1}</div>
                    <span style="font-size:0.875rem;">${st.seatNumber}è™Ÿ ${st.name}</span>
                </div>
                <span class="score-value">${st.score} åˆ†</span>
            `;
            list.appendChild(row);
        });
        this._showModal('scoresModal');
    }

    _showGroupScores() {
        const gs = this._groupScores;
        const groups = Array.from({length:6}, (_,i) => ({ g: i+1, score: gs[i+1] || 0 }))
            .sort((a,b) => b.score - a.score);
        const list = document.getElementById('groupScoresList');
        list.innerHTML = '';
        groups.forEach((g, i) => {
            const row = document.createElement('div');
            row.className = 'score-row';
            row.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;">
                    <div class="rank-badge ${i<3?'rank-'+(i+1):''}">${i+1}</div>
                    <span style="font-size:0.875rem;">ç¬¬${g.g}çµ„</span>
                </div>
                <span class="score-value" style="color:var(--accent-teal);">${g.score} åˆ†</span>
            `;
            list.appendChild(row);
        });
        this._showModal('groupScoresModal');
    }

    // â”€â”€â”€ ç©åˆ†æ­´å² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _showHistory(studentId) {
        const st = this._students[studentId];
        if (!st) return;
        const cls = this.classes[this.currentClassId];
        const history = (cls.scoreHistory || {})[studentId] || [];
        document.getElementById('historyTitle').textContent = `${st.seatNumber}è™Ÿ ${st.name} çš„ç©åˆ†è¨˜éŒ„`;
        const list = document.getElementById('historyList');
        list.innerHTML = history.length ? '' : '<div style="color:var(--text-secondary);padding:1rem;text-align:center;">æš«ç„¡è¨˜éŒ„</div>';
        [...history].reverse().forEach(r => {
            const div = document.createElement('div');
            div.style.cssText = `padding:0.625rem;background:var(--bg-secondary);border-radius:8px;margin-bottom:6px;border-left:3px solid ${r.change>0?'var(--accent-teal)':'var(--accent-pink)'};`;
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                    <span style="font-size:0.72rem;color:var(--text-secondary);">${r.date}</span>
                    <span style="font-family:'Space Mono',monospace;font-weight:700;color:${r.change>0?'var(--accent-teal)':'var(--accent-pink)'};">${r.change>0?'+':''}${r.change}åˆ†</span>
                </div>
                <div style="font-size:0.82rem;">${r.reason}</div>
                <div style="font-size:0.72rem;color:var(--text-secondary);margin-top:2px;">ç´¯ç©ï¼š${r.total}åˆ†</div>
            `;
            list.appendChild(div);
        });
        this._showModal('historyModal');
    }

    // â”€â”€â”€ ä½œæ¥­ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _showHomework() {
        const sid = this.currentSettingsStudentId;
        const st = this._students[sid];
        if (!st) return;
        document.getElementById('homeworkTitle').textContent = `ä½œæ¥­ç®¡ç† - ${st.name}`;
        document.getElementById('newHomeworkInput').value = '';
        this._renderHomeworkList();
        this._showModal('homeworkModal');
    }

    _renderHomeworkList() {
        const sid = this.currentSettingsStudentId;
        const list = this.homeworkNotes[sid] || [];
        const container = document.getElementById('homeworkList');
        container.innerHTML = list.length ? '' : '<div style="color:var(--text-secondary);font-size:0.8rem;">æ²’æœ‰æœªäº¤ä½œæ¥­</div>';
        list.forEach((hw, idx) => {
            const div = document.createElement('div');
            div.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:0.82rem;';
            div.innerHTML = `<span>â­ ${hw.name} <span style="color:var(--text-secondary);font-size:0.7rem;">${hw.date}</span></span>`;
            const rmBtn = document.createElement('button');
            rmBtn.className = 'btn btn-teal';
            rmBtn.style.cssText = 'padding:2px 8px;font-size:0.7rem;';
            rmBtn.textContent = 'å·²äº¤';
            rmBtn.onclick = () => {
                list.splice(idx, 1);
                if (!list.length) delete this.homeworkNotes[sid];
                this._renderHomeworkList();
            };
            div.appendChild(rmBtn);
            container.appendChild(div);
        });
    }

    // â”€â”€â”€ ãƒ©ãƒ³ãƒ€ãƒ ç€å¸­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _randomSeating() {
        if (!confirm('ç¢ºå®šéš¨æ©Ÿå®‰æ’åº§ä½ï¼Ÿé€™æœƒæ¸…é™¤ç›®å‰å®‰æ’ã€‚')) return;
        const maxPos = this.currentMode === 'exam' ? 36 : 30;
        const positions = Array.from({length: maxPos}, (_, i) => i).sort(() => Math.random() - 0.5);
        const students = Object.values(this._students).sort(() => Math.random() - 0.5);
        const seats = {};
        students.forEach((st, i) => { if (i < positions.length) seats[positions[i]] = st.id; });
        this._setSeats(seats);
        this._scheduleSave();
        this._renderSeats();
    }

    // â”€â”€â”€ åŒ¯å‡ºCSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _exportCSV() {
        const rows = [['åº§è™Ÿ','å§“å','æ€§åˆ¥','ç©åˆ†']];
        Object.values(this._students)
            .sort((a,b) => a.seatNumber - b.seatNumber)
            .forEach(st => rows.push([
                st.seatNumber, st.name,
                st.gender === 'male' ? 'ç”·' : 'å¥³',
                this._scores[st.id] || 0
            ]));
        const csv = '\uFEFF' + rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
        a.download = `${this._cls.name || 'ç­ç´š'}_${new Date().toLocaleDateString('zh-TW').replace(/\//g,'')}.csv`;
        a.click();
    }

    // â”€â”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _showModal(id) { document.getElementById(id).classList.add('show'); }
    _hideModal(id) { document.getElementById(id).classList.remove('show'); }

    // â”€â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    _bindGlobalEvents() {
        // Google ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('googleLoginBtn')?.addEventListener('click', async () => {
            try {
                const provider = new window._GoogleAuthProvider();
                await window._signInWithPopup(window._firebaseAuth, provider);
            } catch(e) {
                alert('ç™»å…¥å¤±æ•—ï¼š' + e.message);
            }
        });

        // ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
        document.getElementById('signoutBtn')?.addEventListener('click', async () => {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) await window._signOut(window._firebaseAuth);
        });

        // ç­ç´šè¿½åŠ 
        document.getElementById('addClassBtn')?.addEventListener('click', () => this._showModal('addClassModal'));
        document.getElementById('confirmAddClass')?.addEventListener('click', () => {
            const name = document.getElementById('newClassName').value.trim();
            if (!name) { alert('è«‹è¼¸å…¥ç­ç´šåç¨±'); return; }
            const id = `class_${Date.now()}`;
            this.classes[id] = this._createDefaultClass(name);
            this.currentClassId = id;
            document.getElementById('newClassName').value = '';
            this._hideModal('addClassModal');
            this._renderClassTabs();
            this._renderAll();
            this._scheduleSave();
        });
        document.getElementById('cancelAddClass')?.addEventListener('click', () => this._hideModal('addClassModal'));

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        ['normalMode','groupMode','examMode'].forEach(id => {
            document.getElementById(id)?.addEventListener('click', () => {
                this.currentMode = id.replace('Mode', '');
                ['normalMode','groupMode','examMode'].forEach(b => {
                    const el = document.getElementById(b);
                    if (el) el.className = b === id ? 'btn btn-blue active' : 'btn btn-gray';
                });
                const labels = {normalMode:'ä¸€èˆ¬åº§ä½æ¨¡å¼', groupMode:'å°çµ„åº§ä½æ¨¡å¼', examMode:'è€ƒè©¦åº§ä½æ¨¡å¼'};
                document.getElementById('currentModeLabel').textContent = labels[id];
                this._renderSeats();
            });
        });

        // å­¦ç”Ÿè¦–è§’
        document.getElementById('studentViewBtn')?.addEventListener('click', () => {
            this.isStudentView = !this.isStudentView;
            const btn = document.getElementById('studentViewBtn');
            if (this.isStudentView) {
                btn.textContent = 'è€å¸«è¦–è§’';
                btn.className = 'btn btn-yellow';
            } else {
                btn.textContent = 'å­¸ç”Ÿè¦–è§’';
                btn.className = 'btn btn-teal';
            }
            this._renderSeats();
        });

        // ç©åˆ†
        document.getElementById('showScoresBtn')?.addEventListener('click', () => this._showScores());
        document.getElementById('closeScoresModal')?.addEventListener('click', () => this._hideModal('scoresModal'));
        document.getElementById('resetAllScoresBtn')?.addEventListener('click', () => {
            if (!confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')) return;
            const cls = this.classes[this.currentClassId];
            cls.scores = {}; cls.scoreHistory = {};
            this._scheduleSave();
            this._hideModal('scoresModal');
        });

        // å°çµ„ç©åˆ†
        document.getElementById('showGroupScoresBtn')?.addEventListener('click', () => this._showGroupScores());
        document.getElementById('closeGroupScoresModal')?.addEventListener('click', () => this._hideModal('groupScoresModal'));
        document.getElementById('resetGroupScoresBtn')?.addEventListener('click', () => {
            if (!confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')) return;
            const cls = this.classes[this.currentClassId];
            cls.groupScores = {}; cls.groupScoreHistory = {};
            this._scheduleSave();
            this._hideModal('groupScoresModal');
        });

        // å°çµ„ã‚¹ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ«
        document.getElementById('addGroupScoreBtn')?.addEventListener('click', () => this._adjustGroupScore(1));
        document.getElementById('subtractGroupScoreBtn')?.addEventListener('click', () => this._adjustGroupScore(-1));
        document.getElementById('cancelGroupScore')?.addEventListener('click', () => this._hideModal('groupScoreModal'));
        document.getElementById('confirmGroupScore')?.addEventListener('click', () => {
            // addGroupScoreBtn / subtractGroupScoreBtn ã§å‡¦ç†æ¸ˆã¿
        });
        document.querySelectorAll('.group-reason-btn').forEach(btn => {
            btn.addEventListener('click', () => { document.getElementById('groupScoreReason').value = btn.dataset.r; });
        });

        // æŠ½ç±¤
        document.getElementById('lotteryAll')?.addEventListener('click', () => this._startLottery('all'));
        document.getElementById('lotteryBoys')?.addEventListener('click', () => this._startLottery('male'));
        document.getElementById('lotteryGirls')?.addEventListener('click', () => this._startLottery('female'));
        document.getElementById('clearSelection')?.addEventListener('click', () => this._clearSelection());

        // ã‚¿ã‚¤ãƒãƒ¼
        document.getElementById('timerBtn')?.addEventListener('click', () => this._showModal('timerModal'));
        document.getElementById('startTimerBtn')?.addEventListener('click', () => this._startTimer());
        document.getElementById('cancelTimerBtn')?.addEventListener('click', () => this._hideModal('timerModal'));
        document.getElementById('pauseTimer')?.addEventListener('click', () => {
            this.timerPaused = !this.timerPaused;
            document.getElementById('pauseTimer').textContent = this.timerPaused ? 'ç¹¼çºŒ' : 'æš«åœ';
        });
        document.getElementById('stopTimer')?.addEventListener('click', () => {
            if (!confirm('ç¢ºå®šåœæ­¢ï¼Ÿ')) return;
            clearInterval(this.timerInterval); this.timerRunning = false;
            ['timerDisplay','pauseTimer','stopTimer'].forEach(id => document.getElementById(id).classList.add('hidden'));
        });
        document.querySelectorAll('.quick-time').forEach(btn => {
            btn.addEventListener('click', () => {
                const m = parseInt(btn.dataset.m);
                document.getElementById('timerH').value = Math.floor(m/60);
                document.getElementById('timerM').value = m % 60;
                document.getElementById('timerS').value = 0;
            });
        });
        document.getElementById('closeTimeUpBtn')?.addEventListener('click', () => this._hideModal('timeUpModal'));

        // å­¦ç”Ÿè¨­å®š
        document.getElementById('settingsAddBtn')?.addEventListener('click', () => this._adjustStudentScore(1));
        document.getElementById('settingsSubBtn')?.addEventListener('click', () => this._adjustStudentScore(-1));
        document.getElementById('settingsConfirmScore')?.addEventListener('click', () => {
            // settingsAddBtn / settingsSubBtn ã§å‡¦ç†æ¸ˆã¿
        });
        document.querySelectorAll('.settings-qs').forEach(btn => {
            btn.addEventListener('click', () => { document.getElementById('settingsScoreAmt').value = btn.dataset.s; });
        });
        document.querySelectorAll('.settings-reason').forEach(btn => {
            btn.addEventListener('click', () => { document.getElementById('settingsReason').value = btn.dataset.r; });
        });
        document.getElementById('settingsHistoryBtn')?.addEventListener('click', () => {
            const sid = this.currentSettingsStudentId;
            this._hideModal('studentSettingsModal');
            this._showHistory(sid);
        });
        document.getElementById('settingsEditBtn')?.addEventListener('click', () => {
            const sid = this.currentSettingsStudentId;
            this._hideModal('studentSettingsModal');
            this._showEditStudent(sid);
        });
        document.getElementById('settingsHomeworkBtn')?.addEventListener('click', () => this._showHomework());
        document.getElementById('closeSettingsModal')?.addEventListener('click', () => this._hideModal('studentSettingsModal'));

        // æ­´å²
        document.getElementById('closeHistoryBtn')?.addEventListener('click', () => this._hideModal('historyModal'));

        // ä½œæ¥­
        document.getElementById('addHomeworkBtn')?.addEventListener('click', () => {
            const name = document.getElementById('newHomeworkInput').value.trim();
            if (!name) { alert('è«‹è¼¸å…¥ä½œæ¥­åç¨±'); return; }
            const sid = this.currentSettingsStudentId;
            if (!this.homeworkNotes[sid]) this.homeworkNotes[sid] = [];
            this.homeworkNotes[sid].push({ name, date: new Date().toLocaleDateString('zh-TW') });
            document.getElementById('newHomeworkInput').value = '';
            this._renderHomeworkList();
        });
        document.getElementById('saveHomeworkBtn')?.addEventListener('click', () => {
            this._scheduleSave();
            this._renderAll();
            this._hideModal('homeworkModal');
        });
        document.getElementById('closeHomeworkBtn')?.addEventListener('click', () => this._hideModal('homeworkModal'));

        // å­¦ç”Ÿç·¨é›†
        document.getElementById('editStudentsBtn')?.addEventListener('click', () => this._showBulkEdit());
        document.getElementById('saveStudentBtn')?.addEventListener('click', () => this._saveStudent());
        document.getElementById('deleteStudentBtn')?.addEventListener('click', () => this._deleteStudent());
        document.getElementById('cancelEditStudent')?.addEventListener('click', () => this._hideModal('editStudentModal'));
        document.getElementById('closeBulkEdit')?.addEventListener('click', () => this._hideModal('bulkEditModal'));

        // ãƒ©ãƒ³ãƒ€ãƒ ç€å¸­
        document.getElementById('randomSeatingBtn')?.addEventListener('click', () => this._randomSeating());
        document.getElementById('resetSeatsBtn')?.addEventListener('click', () => {
            if (!confirm('ç¢ºå®šé‡ç½®åº§ä½ï¼Ÿ')) return;
            this._setSeats({});
            this._scheduleSave();
            this._renderSeats();
        });

        // åŒ¯å‡º
        document.getElementById('exportBtn')?.addEventListener('click', () => this._exportCSV());

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => {
                if (e.target === overlay) overlay.classList.remove('show');
            });
        });
    }

    _showBulkEdit() {
        const container = document.getElementById('bulkEditList');
        container.innerHTML = '';
        for (let i = 1; i <= 40; i++) {
            const st = Object.values(this._students).find(s => s.seatNumber === i);
            const chip = document.createElement('div');
            chip.style.cssText = 'aspect-ratio:1;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:0.65rem;cursor:pointer;padding:4px;text-align:center;transition:all 0.2s;';
            if (st) {
                chip.innerHTML = `<div style="font-family:'Space Mono',monospace;color:var(--accent-blue);font-weight:700;">${i}</div><div style="color:var(--text-primary);">${st.name.slice(0,3)}</div>`;
                chip.addEventListener('mouseenter', () => chip.style.borderColor = 'var(--accent-blue)');
                chip.addEventListener('mouseleave', () => chip.style.borderColor = 'var(--border)');
                chip.addEventListener('click', () => { this._hideModal('bulkEditModal'); this._showEditStudent(st.id); });
            } else {
                chip.innerHTML = `<div style="color:var(--text-secondary);">${i}</div><div style="color:var(--text-secondary);font-size:0.55rem;">ç©º</div>`;
                chip.style.borderStyle = 'dashed';
                chip.addEventListener('click', () => { this._hideModal('bulkEditModal'); this._showEditStudent(null, i); });
            }
            container.appendChild(chip);
        }
        this._showModal('bulkEditModal');
    }
}

// èµ·å‹•
const app = new ClassroomApp();
</script>
</body>
</html>
