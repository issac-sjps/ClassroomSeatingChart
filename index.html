<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ•™å®¤åº§ä½ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc }
    from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBAbSddZ6VsHjw-NjW77kxS8iuC5-cW_wY",
    authDomain: "sjps-classroomseatchart.firebaseapp.com",
    projectId: "sjps-classroomseatchart",
    storageBucket: "sjps-classroomseatchart.firebasestorage.app",
    messagingSenderId: "812781751431",
    appId: "1:812781751431:web:3cad939d2c29fbbde67c22",
    measurementId: "G-Q74G95W8P8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window._auth = auth;
  window._db = db;
  window._GoogleAuthProvider = GoogleAuthProvider;
  window._signInWithPopup = signInWithPopup;
  window._signOut = signOut;
  window._onAuthStateChanged = onAuthStateChanged;
  window._fsDoc = doc;
  window._fsSetDoc = setDoc;
  window._fsGetDoc = getDoc;
  window._firebaseReady = true;
  // çµ¦å·²ç¶“åœ¨ç­‰å¾…çš„ ClassroomApp è§¸ç™¼
  window.dispatchEvent(new Event('firebaseReady'));
  // ä¹Ÿçµ¦é‚„æ²’è·‘åˆ°çš„ ClassroomApp ä¸€å€‹ callback slot
  if (typeof window._onFirebaseReady === 'function') window._onFirebaseReady();
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');

*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans TC',sans-serif;background:#f0f4f8;color:#1e293b;height:100vh;overflow:hidden;}

/* â”€â”€ ç™»å…¥ â”€â”€ */
#loginScreen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#e0f2fe 0%,#f0fdf4 50%,#fefce8 100%);}
.login-card{background:white;border-radius:20px;padding:3rem 2.5rem;max-width:420px;width:100%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.12);}
.login-logo{font-size:3rem;margin-bottom:0.5rem;}
.login-title{font-size:1.4rem;font-weight:700;color:#1e293b;margin-bottom:0.4rem;}
.login-sub{font-size:0.9rem;color:#64748b;margin-bottom:2rem;}
.google-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:0.875rem;background:white;border:2px solid #e2e8f0;border-radius:12px;font-size:0.95rem;font-weight:600;color:#374151;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.google-btn:hover{border-color:#93c5fd;box-shadow:0 4px 16px rgba(59,130,246,0.15);transform:translateY(-1px);}

/* â”€â”€ Loading â”€â”€ */
#loadingScreen{position:fixed;inset:0;background:white;display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:1rem;}
.spinner{width:36px;height:36px;border:3px solid #e2e8f0;border-top-color:#3b82f6;border-radius:50%;animation:spin 0.7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ App Layout â”€â”€ */
#appScreen{display:none;height:100vh;flex-direction:column;}
.app-header{background:linear-gradient(135deg,#1e40af 0%,#1d4ed8 100%);border-bottom:none;padding:0.6rem 1.25rem;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 2px 8px rgba(30,64,175,0.3);}
.header-left{display:flex;align-items:center;gap:0.75rem;}
.logo-icon{font-size:1.4rem;}
.logo-text{font-size:1rem;font-weight:700;color:white;}

/* â”€â”€ ç­ç´š Tab Bar â”€â”€ */
.class-bar{background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border-bottom:2px solid #bfdbfe;padding:0 1.25rem;display:flex;align-items:center;gap:0;overflow-x:auto;flex-shrink:0;}
.class-bar::-webkit-scrollbar{height:3px;}
.class-bar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:2px;}
#classTabs{display:flex;align-items:stretch;gap:0;}
.class-tab{display:flex;align-items:center;gap:5px;padding:0.6rem 0.875rem;font-size:0.85rem;font-weight:500;color:#1e40af;cursor:pointer;border-bottom:3px solid transparent;border-radius:6px 6px 0 0;transition:background 0.15s,color 0.15s;white-space:nowrap;flex-shrink:0;user-select:none;position:relative;}
.class-tab:hover{color:#1d4ed8;background:rgba(255,255,255,0.7);}
.class-tab.active{color:#1d4ed8;border-bottom-color:#1d4ed8;font-weight:700;background:white;}
.class-tab.tab-dragging{opacity:0.35;background:rgba(255,255,255,0.5);}
.class-tab.tab-drag-over-left::before{content:'';position:absolute;left:0;top:4px;bottom:4px;width:3px;background:#3b82f6;border-radius:2px;}
.class-tab.tab-drag-over-right::after{content:'';position:absolute;right:0;top:4px;bottom:4px;width:3px;background:#3b82f6;border-radius:2px;}
.drag-handle{font-size:0.7rem;color:#93c5fd;cursor:grab;line-height:1;letter-spacing:-1px;}
.class-tab:hover .drag-handle{color:#3b82f6;}
.class-tab-rename{font-size:0.7rem;opacity:0;padding:1px 5px;border-radius:4px;background:#f1f5f9;border:1px solid #e2e8f0;cursor:pointer;transition:opacity 0.15s;line-height:1.5;}
.class-tab:hover .class-tab-rename,.class-tab.active .class-tab-rename{opacity:1;}
.class-tab-rename:hover{background:#dbeafe;border-color:#93c5fd;}
.add-class-btn{padding:0.45rem 0.875rem;font-size:0.8rem;font-weight:500;color:#1e40af;background:rgba(255,255,255,0.8);border:1px dashed #93c5fd;border-radius:8px;cursor:pointer;margin-left:0.5rem;white-space:nowrap;flex-shrink:0;transition:all 0.15s;}
.add-class-btn:hover{background:white;border-color:#3b82f6;}
.sort-class-btn{padding:0.4rem 0.75rem;font-size:0.75rem;color:#1e40af;background:rgba(255,255,255,0.8);border:1px solid #93c5fd;border-radius:7px;cursor:pointer;margin-left:6px;white-space:nowrap;flex-shrink:0;transition:all 0.15s;}
.sort-class-btn:hover{background:white;color:#1d4ed8;border-color:#3b82f6;}
.sync-badge{margin-left:auto;padding-left:0.75rem;display:flex;align-items:center;gap:6px;font-size:0.75rem;color:#3b82f6;flex-shrink:0;}
.sync-dot{width:6px;height:6px;border-radius:50%;background:#22c55e;}
.sync-dot.syncing{background:#f59e0b;animation:blink 0.6s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
@keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-5px);}40%,80%{transform:translateX(5px);}}

/* â”€â”€ Control Panel â”€â”€ */
.ctrl-panel{background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);border-bottom:2px solid #bbf7d0;padding:0.6rem 1.25rem;display:flex;flex-wrap:wrap;gap:6px;align-items:center;flex-shrink:0;}
.divider{width:1px;height:22px;background:rgba(0,0,0,0.15);margin:0 2px;}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:0.35rem 0.875rem;border-radius:8px;font-size:0.8rem;font-weight:500;cursor:pointer;transition:all 0.15s;border:1px solid transparent;white-space:nowrap;}
.btn-primary{background:#3b82f6;color:white;border-color:#3b82f6;}
.btn-primary:hover{background:#2563eb;}
.btn-primary.active{background:#1d4ed8;box-shadow:inset 0 2px 4px rgba(0,0,0,0.15);}
.btn-outline{background:white;color:#374151;border-color:#d1d5db;}
.btn-outline:hover{border-color:#93c5fd;color:#3b82f6;background:#f8fafc;}
.btn-outline.active{background:#eff6ff;border-color:#3b82f6;color:#3b82f6;}
.btn-green{background:#10b981;color:white;border-color:#10b981;}
.btn-green:hover{background:#059669;}
.btn-amber{background:#f59e0b;color:white;border-color:#f59e0b;}
.btn-amber:hover{background:#d97706;}
.btn-red{background:#ef4444;color:white;border-color:#ef4444;}
.btn-red:hover{background:#dc2626;}
.btn-gray{background:#f1f5f9;color:#475569;border-color:#e2e8f0;}
.btn-gray:hover{background:#e2e8f0;}
.btn-sm{padding:0.25rem 0.625rem;font-size:0.75rem;}
.btn-view{background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border-color:#b45309;font-weight:600;}
.btn-view:hover{background:linear-gradient(135deg,#d97706,#b45309);transform:translateY(-1px);}
.btn-view-active{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white;border-color:#5b21b6;font-weight:600;}
.btn-view-active:hover{background:linear-gradient(135deg,#6d28d9,#5b21b6);transform:translateY(-1px);}
.btn-score-add{background:linear-gradient(135deg,#22c55e,#16a34a);color:white;border:none;border-radius:10px;padding:0.65rem;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.15s;box-shadow:0 3px 10px rgba(22,163,74,0.3);}
.btn-score-add:hover{background:linear-gradient(135deg,#16a34a,#15803d);transform:translateY(-2px);box-shadow:0 5px 16px rgba(22,163,74,0.4);}
.btn-score-sub{background:linear-gradient(135deg,#ef4444,#dc2626);color:white;border:none;border-radius:10px;padding:0.65rem;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.15s;box-shadow:0 3px 10px rgba(220,38,38,0.3);}
.btn-score-sub:hover{background:linear-gradient(135deg,#dc2626,#b91c1c);transform:translateY(-2px);box-shadow:0 5px 16px rgba(220,38,38,0.4);}

/* â”€â”€ Main Content â”€â”€ */
.main-content{display:flex;flex:1;overflow:hidden;}

/* â”€â”€ Student Panel â”€â”€ */
.student-panel{width:240px;flex-shrink:0;background:linear-gradient(180deg,#faf5ff 0%,#f3e8ff 100%);border-right:2px solid #d8b4fe;display:flex;flex-direction:column;overflow:hidden;}
.panel-hdr{padding:0.75rem 0.875rem;border-bottom:2px solid #d8b4fe;background:linear-gradient(135deg,#7c3aed,#6d28d9);display:flex;align-items:center;justify-content:space-between;}
.panel-title{font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:white;}
#studentList{flex:1;overflow-y:auto;padding:0.625rem;display:grid;grid-template-columns:repeat(4,1fr);gap:5px;align-content:start;}
#studentList::-webkit-scrollbar{width:4px;}
#studentList::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:2px;}

.s-chip{border-radius:8px;border:1.5px solid #e2e8f0;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:5px 2px;cursor:move;transition:all 0.15s;aspect-ratio:1;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.07);}
.s-chip.dragging{opacity:0.5;transform:rotate(4deg) scale(1.08);}
/* ç”·ç”Ÿ chip */
.s-chip-male{background:linear-gradient(150deg,#dbeafe,#bfdbfe);border-color:#93c5fd;}
.s-chip-male:hover{border-color:#3b82f6;transform:scale(1.06);box-shadow:0 3px 8px rgba(59,130,246,0.2);}
.s-chip-male .sn{font-size:0.7rem;font-weight:700;color:#1e40af;line-height:1;}
.s-chip-male .nm{font-size:0.6rem;color:#1e3a8a;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;}
/* å¥³ç”Ÿ chip */
.s-chip-female{background:linear-gradient(150deg,#fee2e2,#fecaca);border-color:#fca5a5;}
.s-chip-female:hover{border-color:#ef4444;transform:scale(1.06);box-shadow:0 3px 8px rgba(239,68,68,0.2);}
.s-chip-female .sn{font-size:0.7rem;font-weight:700;color:#991b1b;line-height:1;}
.s-chip-female .nm{font-size:0.6rem;color:#7f1d1d;line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;}
/* ç©ºæ ¼ */
.s-chip.empty{border-style:dashed;border-color:#d8b4fe;cursor:pointer;}
.s-chip.empty:hover{border-color:#a78bfa;background:#f5f3ff;}

/* â”€â”€ Classroom Panel â”€â”€ */
.classroom-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#fefce8;}
.classroom-toolbar{padding:0.625rem 1.25rem;background:linear-gradient(135deg,#fffbeb 0%,#fef3c7 100%);border-bottom:2px solid #fde68a;display:flex;align-items:center;gap:8px;}
.mode-label{font-size:0.78rem;color:#92400e;font-weight:600;margin-right:auto;}

/* â”€â”€ Seat Area â”€â”€ */
#seatingArea{flex:1;overflow:auto;padding:1.5rem 2rem;background:linear-gradient(180deg,#fefce8 0%,#fef9c3 100%);}
#seatingArea::-webkit-scrollbar{width:6px;height:6px;}
#seatingArea::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px;}

.podium{text-align:center;padding:0.625rem 2rem;background:linear-gradient(135deg,#1e40af,#1d4ed8);color:white;border-radius:10px;margin-bottom:1.25rem;font-size:0.85rem;font-weight:700;letter-spacing:0.2em;box-shadow:0 3px 10px rgba(30,64,175,0.3);display:inline-block;min-width:160px;position:relative;left:50%;transform:translateX(-50%);}

/* â”€â”€ Normal/Exam Seat â”€â”€ */
.seat{background:white;border:1.5px solid #e2e8f0;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;position:relative;flex-shrink:0;box-shadow:0 1px 4px rgba(0,0,0,0.06);}
.seat:hover{box-shadow:0 3px 10px rgba(0,0,0,0.14);transform:translateY(-1px);}
/* ç©ºä½ */
.seat.empty-seat{background:white;border-color:#e2e8f0;}
/* ç”·ç”Ÿåº§ä½ - è—è‰²ç³» */
.seat.seat-male{background:linear-gradient(160deg,#dbeafe 0%,#bfdbfe 100%);border-color:#93c5fd;}
.seat.seat-male:hover{border-color:#3b82f6;box-shadow:0 3px 12px rgba(59,130,246,0.25);}
.seat.seat-male .seat-no{color:#1e40af;}
.seat.seat-male .seat-nm{color:#1e3a8a;}
/* å¥³ç”Ÿåº§ä½ - ç´…/ç«ç‘°è‰²ç³» */
.seat.seat-female{background:linear-gradient(160deg,#fee2e2 0%,#fecaca 100%);border-color:#fca5a5;}
.seat.seat-female:hover{border-color:#ef4444;box-shadow:0 3px 12px rgba(239,68,68,0.25);}
.seat.seat-female .seat-no{color:#991b1b;}
.seat.seat-female .seat-nm{color:#7f1d1d;}
.seat .seat-hw{font-size:0.55rem;color:#f59e0b;line-height:1;}
.seat.drop-zone{border-color:#10b981!important;background:#f0fdf4!important;transform:scale(1.05);}

/* â”€â”€ Normal layout rows â”€â”€ */
.normal-row{display:flex;justify-content:center;align-items:center;margin-bottom:10px;gap:28px;}
.seat-group{display:flex;gap:8px;}
/* èµ°é“è¦–è¦ºæ¨™ç¤ºï¼šè®“ä¸­é–“èµ°é“æœ‰èƒŒæ™¯æš—ç¤º */
.aisle-marker{width:28px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.aisle-line{width:2px;height:100%;background:linear-gradient(180deg,transparent,#bfdbfe 30%,#bfdbfe 70%,transparent);opacity:0.5;border-radius:1px;}

/* â”€â”€ Group layout â”€â”€ */
.group-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;}
.group-box{background:white;border:1.5px solid #e2e8f0;border-radius:12px;padding:1rem;position:relative;}
.group-lbl-btn{position:absolute;top:-12px;left:12px;background:white;border:1.5px solid #bfdbfe;color:#3b82f6;padding:2px 10px;border-radius:6px;font-size:0.75rem;font-weight:700;cursor:pointer;}
.group-lbl-btn:hover{background:#eff6ff;}
.group-inner{display:flex;flex-direction:column;align-items:center;gap:8px;padding-top:6px;}
.group-row{display:flex;gap:8px;}

/* â”€â”€ Sci Lab layout â”€â”€ */
.scilab-grid{display:grid;grid-template-columns:1fr 1fr;gap:2rem;max-width:900px;margin:0 auto;}
.scilab-section{display:flex;flex-direction:column;gap:1.5rem;}
.scilab-table{background:white;border:2px solid #d1fae5;border-radius:14px;padding:1rem;position:relative;box-shadow:0 2px 8px rgba(16,185,129,0.1);}
.scilab-table-lbl{position:absolute;top:-12px;left:12px;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:2px 12px;border-radius:6px;font-size:0.75rem;font-weight:700;cursor:pointer;}
.scilab-table-lbl:hover{background:linear-gradient(135deg,#059669,#047857);}
/* é•·é‚Š3åº§ï¼ˆé¢å‘è¬›å°ï¼‰+ çŸ­é‚Š2åº§ */
.scilab-long-row{display:flex;gap:8px;justify-content:center;margin-bottom:8px;}
.scilab-short-row{display:flex;gap:32px;justify-content:center;}
.scilab-divider{width:100%;height:2px;background:linear-gradient(90deg,transparent,#a7f3d0,transparent);margin:6px 0;}

/* â”€â”€ Computer Room layout â”€â”€ */
.computer-area{display:flex;flex-direction:column;gap:1rem;}
.computer-row-wrap{display:flex;align-items:center;gap:10px;}
.computer-row-label{font-size:0.75rem;font-weight:700;color:#7c3aed;writing-mode:horizontal-tb;min-width:36px;text-align:center;background:#f3e8ff;border:1px solid #ddd6fe;border-radius:6px;padding:4px;}
.computer-row{display:flex;gap:6px;flex-wrap:nowrap;}

/* â”€â”€ Free Seat (è‡ªç”±é…ç½®) â”€â”€ */
#freeArea{flex:1;position:relative;background:
  radial-gradient(circle at 1px 1px, #e2e8f0 1px, transparent 0);
background-size:28px 28px;min-height:500px;}
.free-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#94a3b8;font-size:0.9rem;text-align:center;pointer-events:none;user-select:none;}
.free-seat{position:absolute;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:move;user-select:none;transition:box-shadow 0.15s,transform 0.1s;}
.free-seat:hover{transform:translateY(-2px);}
.free-seat.dragging-free{opacity:0.7;box-shadow:0 8px 24px rgba(0,0,0,0.15);}
.free-seat-male{background:linear-gradient(160deg,#dbeafe,#bfdbfe);border:1.5px solid #93c5fd;}
.free-seat-male:hover{border-color:#3b82f6;box-shadow:0 4px 14px rgba(59,130,246,0.3);}
.free-seat-male .seat-no{font-size:0.65rem;font-weight:700;color:#1e40af;}
.free-seat-male .seat-nm{font-size:0.78rem;font-weight:600;color:#1e3a8a;}
.free-seat-female{background:linear-gradient(160deg,#fee2e2,#fecaca);border:1.5px solid #fca5a5;}
.free-seat-female:hover{border-color:#ef4444;box-shadow:0 4px 14px rgba(239,68,68,0.3);}
.free-seat-female .seat-no{font-size:0.65rem;font-weight:700;color:#991b1b;}
.free-seat-female .seat-nm{font-size:0.78rem;font-weight:600;color:#7f1d1d;}
.free-seat .seat-hw{font-size:0.55rem;color:#f59e0b;}
#freeArea.drop-active{background-color:rgba(139,92,246,0.04);}

/* â”€â”€ Lottery animations â”€â”€ */
.lottery-flash,.free-seat.lottery-flash{animation:lflash 0.3s ease-in-out infinite alternate!important;}
@keyframes lflash{0%{background:#fef3c7!important;border-color:#f59e0b!important;}100%{background:#fde68a!important;border-color:#d97706!important;}}
.lottery-selected,.free-seat.lottery-selected{background:#fee2e2!important;border-color:#ef4444!important;box-shadow:0 0 16px rgba(239,68,68,0.5)!important;animation:lpulse 1.5s ease-in-out infinite!important;}
@keyframes lpulse{0%,100%{transform:scale(1);}50%{transform:scale(1.06);}}

/* â”€â”€ Timer â”€â”€ */
.timer-display{font-size:1rem;font-weight:700;color:#1e293b;min-width:64px;text-align:center;font-variant-numeric:tabular-nums;}
.timer-display.urgent{color:#ef4444;animation:tpulse 0.5s ease-in-out infinite;}
@keyframes tpulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

/* â”€â”€ Modals â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:500;padding:1rem;}
.modal-overlay.show{display:flex;}
.modal-box{background:white;border-radius:16px;padding:1.75rem;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.2);}
.modal-box::-webkit-scrollbar{width:4px;}
.modal-box::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:2px;}
.modal-title{font-size:1.05rem;font-weight:700;color:#1e293b;margin-bottom:1.25rem;}
.form-label{display:block;font-size:0.75rem;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.35rem;}
.form-input{width:100%;padding:0.6rem 0.875rem;border:1.5px solid #e2e8f0;border-radius:8px;font-size:0.9rem;color:#1e293b;font-family:'Noto Sans TC',sans-serif;transition:border-color 0.15s;}
.form-input:focus{outline:none;border-color:#3b82f6;}
.form-select{width:100%;padding:0.6rem 0.875rem;border:1.5px solid #e2e8f0;border-radius:8px;font-size:0.9rem;color:#1e293b;cursor:pointer;}
.form-select:focus{outline:none;border-color:#3b82f6;}
.score-row{display:flex;align-items:center;justify-content:space-between;padding:0.625rem 0.75rem;background:#f8fafc;border-radius:8px;margin-bottom:5px;}
.rank-badge{width:26px;height:26px;border-radius:50%;background:#dbeafe;color:#3b82f6;display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;flex-shrink:0;}
.rank-1{background:#fef3c7;color:#d97706;}
.rank-2{background:#f1f5f9;color:#64748b;}
.rank-3{background:#fff7ed;color:#ea580c;}
.history-entry{padding:0.625rem 0.75rem;background:#f8fafc;border-radius:8px;margin-bottom:5px;border-left:3px solid #e2e8f0;}
.history-entry.pos{border-left-color:#10b981;}
.history-entry.neg{border-left-color:#ef4444;}

/* â”€â”€ User info â”€â”€ */
.user-avatar{width:30px;height:30px;border-radius:50%;border:2px solid rgba(255,255,255,0.6);}
.user-name{font-size:0.8rem;color:rgba(255,255,255,0.85);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.signout-btn{padding:0.3rem 0.75rem;background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.35);border-radius:7px;font-size:0.78rem;cursor:pointer;}
.signout-btn:hover{background:rgba(255,255,255,0.25);}

/* â”€â”€ Quick reason buttons â”€â”€ */
.qr-btn{padding:4px 8px;font-size:0.72rem;border-radius:6px;cursor:pointer;border:1px solid;transition:all 0.15s;}
.score-bubble{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,#e0f2fe,#bae6fd);border:2px solid #7dd3fc;color:#0369a1;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;}
.score-bubble:hover{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border-color:#1d4ed8;transform:scale(1.15);box-shadow:0 4px 12px rgba(59,130,246,0.35);}
.score-bubble.active{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border-color:#1d4ed8;box-shadow:0 2px 8px rgba(59,130,246,0.4);}
.qr-pos{background:#f0fdf4;color:#059669;border-color:#a7f3d0;}
.qr-pos:hover{background:#dcfce7;}
.qr-neg{background:#fef2f2;color:#dc2626;border-color:#fecaca;}
.qr-neg:hover{background:#fee2e2;}
.qr-neutral{background:#f1f5f9;color:#475569;border-color:#e2e8f0;}
.qr-neutral:hover{background:#e2e8f0;}

/* â”€â”€ Homework â”€â”€ */
.hw-item{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:#fefce8;border:1px solid #fef08a;border-radius:7px;margin-bottom:5px;font-size:0.82rem;}

/* â”€â”€ Seat size slider â”€â”€ */
.size-slider{-webkit-appearance:none;appearance:none;height:4px;border-radius:2px;background:#e2e8f0;outline:none;cursor:pointer;}
.size-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#3b82f6;cursor:pointer;}
.size-preset-btn{padding:2px 7px;font-size:0.7rem;font-weight:700;border-radius:5px;border:1.5px solid #d1fae5;background:#f0fdf4;color:#065f46;cursor:pointer;transition:all 0.12s;}
.size-preset-btn:hover{background:#d1fae5;border-color:#10b981;}
.size-preset-btn.active{background:linear-gradient(135deg,#10b981,#059669);color:white;border-color:#059669;box-shadow:0 2px 6px rgba(16,185,129,0.35);}

/* â”€â”€ Rename inline input â”€â”€ */
.rename-input{border:1.5px solid #93c5fd;border-radius:6px;padding:2px 6px;font-size:0.82rem;font-family:'Noto Sans TC',sans-serif;outline:none;max-width:120px;}
.tab-switch{padding:0.3rem 0.875rem;font-size:0.78rem;font-weight:600;border:1.5px solid #e2e8f0;border-radius:7px;background:#f8fafc;color:#64748b;cursor:pointer;transition:all 0.15s;}
.tab-switch.active{background:#3b82f6;color:white;border-color:#3b82f6;}
.tab-switch:hover:not(.active){background:#eff6ff;border-color:#93c5fd;color:#3b82f6;}
</style>
</head>
<body>

<!-- Loading -->
<div id="loadingScreen">
  <div class="spinner"></div>
  <div style="font-size:0.875rem;color:#94a3b8;">è¼‰å…¥ä¸­...</div>
</div>

<!-- Login -->
<div id="loginScreen" style="display:none;">
  <div class="login-card">
    <div class="login-logo">ğŸ“š</div>
    <div class="login-title">æ•™å®¤åº§ä½ç®¡ç†ç³»çµ±</div>
    <div class="login-sub">æ•™å¸«å°ˆç”¨ç‰ˆ Â· é›²ç«¯åŒæ­¥</div>
    <button class="google-btn" id="googleLoginBtn">
      <svg width="20" height="20" viewBox="0 0 48 48">
        <path fill="#FFC107" d="M43.6 20H24v8h11.3C33.9 32.4 29.4 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.8 1.1 7.9 3l5.7-5.7C34 6.2 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 19.7-8 19.7-20 0-1.3-.1-2.7-.1-4z"/>
        <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 15.7 19 13 24 13c3 0 5.8 1.1 7.9 3l5.7-5.7C34 6.2 29.3 4 24 4 16.3 4 9.7 8.3 6.3 14.7z"/>
        <path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.8 13.5-4.7L31 33.8C28.9 35.2 26.6 36 24 36c-5.3 0-9.8-3.6-11.3-8.5L6 32.3C9.4 38.8 16.2 44 24 44z"/>
        <path fill="#1976D2" d="M43.6 20H24v8h11.3c-.7 2-2 3.8-3.7 5l6.5 5.5C41.7 34.9 44 29.9 44 24c0-1.3-.2-2.7-.4-4z"/>
      </svg>
      ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
    </button>
  </div>
</div>

<!-- App -->
<div id="appScreen" style="display:none;height:100vh;display:none;flex-direction:column;">

  <!-- Header -->
  <header class="app-header">
    <div class="header-left">
      <span class="logo-icon">ğŸ“š</span>
      <span class="logo-text">æ•™å®¤åº§ä½ç³»çµ±</span>
    </div>
    <div style="display:flex;align-items:center;gap:0.75rem;">
      <img id="userAvatar" class="user-avatar" src="" alt="">
      <span id="userName" class="user-name"></span>
      <button class="signout-btn" id="signoutBtn">ç™»å‡º</button>
    </div>
  </header>

  <!-- Class Tab Bar -->
  <div class="class-bar" id="classBar">
    <div id="classTabs" style="display:flex;align-items:stretch;gap:0;"></div>
    <button class="add-class-btn" id="addClassBtn">ï¼‹ æ–°å¢ç­ç´š</button>
    <button class="sort-class-btn" id="sortClassBtn" title="ä¾åç¨±æ’åºç­ç´š">AZ æ’åº</button>
    <div class="sync-badge">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncText">å·²åŒæ­¥</span>
    </div>
  </div>

  <!-- Control Panel -->
  <div class="ctrl-panel">
    <!-- Modes -->
    <button class="btn btn-primary active" id="modeNormal">ä¸€èˆ¬åº§ä½</button>
    <button class="btn btn-outline" id="modeGroup">å°çµ„åº§ä½</button>
    <button class="btn btn-outline" id="modeExam">è€ƒè©¦åº§ä½</button>
    <button class="btn btn-outline" id="modeFree">è‡ªç”±åº§ä½</button>
    <button class="btn btn-outline" id="modeSciLab">è‡ªç„¶æ•™å®¤</button>
    <button class="btn btn-outline" id="modeComputer">é›»è…¦æ•™å®¤</button>
    <div class="divider"></div>
    <!-- Views & Scores -->
    <button class="btn btn-view" id="studentViewBtn">ğŸ‘¤ å­¸ç”Ÿè¦–è§’</button>
    <button class="btn btn-outline" id="showScoresBtn">å€‹äººç©åˆ†</button>
    <button class="btn btn-outline" id="showGroupScoresBtn">å°çµ„ç©åˆ†</button>
    <span id="viewIndicator" style="font-size:0.78rem;font-weight:600;padding:3px 10px;border-radius:20px;background:#fef3c7;color:#92400e;border:1px solid #fde68a;">ğŸ“ è€å¸«è¦–è§’</span>
    <div class="divider"></div>
    <!-- å³å´å€å¡Šï¼šæŠ½ç±¤ + è¨ˆæ™‚å™¨ -->
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;flex-wrap:nowrap;">
      <!-- Lottery -->
      <span style="font-size:0.78rem;color:#374151;">æŠ½</span>
      <input type="number" id="lotteryCount" value="1" min="1" max="10"
        style="width:40px;padding:3px 5px;border:1.5px solid #e2e8f0;border-radius:6px;text-align:center;font-size:0.8rem;color:#1e293b;background:white;">
      <span style="font-size:0.78rem;color:#374151;">äºº</span>
      <button class="btn btn-amber" id="lotteryAllBtn">å…¨éƒ¨æŠ½ç±¤</button>
      <button class="btn btn-primary" id="lotteryBoysBtn">ç”·ç”ŸæŠ½ç±¤</button>
      <button class="btn btn-red" id="lotteryGirlsBtn">å¥³ç”ŸæŠ½ç±¤</button>
      <button class="btn btn-gray" id="clearSelBtn" style="display:none;">å–æ¶ˆæ¨™è¨˜</button>
      <div class="divider"></div>
      <!-- Timer -->
      <button class="btn btn-green" id="timerBtn">â± è¨ˆæ™‚å™¨</button>
      <span class="timer-display" id="timerDisplay" style="display:none;">00:00</span>
      <button class="btn btn-outline btn-sm" id="pauseTimerBtn" style="display:none;">æš«åœ</button>
      <button class="btn btn-gray btn-sm" id="stopTimerBtn" style="display:none;">åœæ­¢</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main-content">

    <!-- Student Panel -->
    <div class="student-panel">
      <div class="panel-hdr">
        <span class="panel-title">å­¸ç”Ÿåå–®</span>
        <div style="display:flex;gap:5px;">
          <button class="btn btn-outline btn-sm" id="editStudentsBtn">ç·¨è¼¯</button>
          <button class="btn btn-outline btn-sm" id="exportBtn">åŒ¯å‡º</button>
        </div>
      </div>
      <div id="studentList"></div>
    </div>

    <!-- Classroom -->
    <div class="classroom-panel">
      <div class="classroom-toolbar">
        <span class="mode-label" id="modeLabel">ä¸€èˆ¬åº§ä½æ¨¡å¼</span>
        <!-- Seat Size Buttons -->
        <span style="font-size:0.72rem;color:#92400e;font-weight:600;">åº§ä½å¤§å°</span>
        <div style="display:flex;gap:3px;">
          <button class="size-preset-btn" data-sz="72" title="è¶…å°">XS</button>
          <button class="size-preset-btn" data-sz="88" title="å°">S</button>
          <button class="size-preset-btn active" data-sz="100" title="ä¸­">M</button>
          <button class="size-preset-btn" data-sz="120" title="å¤§">L</button>
          <button class="size-preset-btn" data-sz="148" title="è¶…å¤§">XL</button>
          <button class="size-preset-btn" data-sz="180" title="è¶…è¶…å¤§">2XL</button>
        </div>
        <input type="range" class="size-slider" id="seatSizeSlider" min="70" max="190" value="100" style="width:70px;">
        <button class="btn btn-primary btn-sm" id="randomBtn">ğŸ”€ éš¨æ©Ÿå…¥åº§</button>
        <button class="btn btn-gray btn-sm" id="resetBtn">é‡ç½®åº§ä½</button>
      </div>
      <div id="seatingArea">
        <!-- dynamically rendered -->
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Add Class -->
<div class="modal-overlay" id="addClassModal">
  <div class="modal-box" style="max-width:360px;">
    <div class="modal-title">æ–°å¢ç­ç´š</div>
    <div style="margin-bottom:1rem;">
      <label class="form-label">ç­ç´šåç¨±</label>
      <input type="text" class="form-input" id="newClassName" placeholder="ä¾‹ï¼šä¸‰å¹´ä¸€ç­ã€501">
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" id="confirmAddClass" style="flex:1;padding:0.6rem;">ç¢ºèªæ–°å¢</button>
      <button class="btn btn-gray" id="cancelAddClass" style="padding:0.6rem 1rem;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- Rename Class -->
<div class="modal-overlay" id="renameClassModal">
  <div class="modal-box" style="max-width:360px;">
    <div class="modal-title">ä¿®æ”¹ç­ç´šåç¨±</div>
    <div style="margin-bottom:1rem;">
      <label class="form-label">æ–°åç¨±</label>
      <input type="text" class="form-input" id="renameClassInput" placeholder="è¼¸å…¥æ–°ç­ç´šåç¨±">
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" id="confirmRename" style="flex:1;padding:0.6rem;">ç¢ºèª</button>
      <button class="btn btn-red" id="deleteClassBtn" style="padding:0.6rem 1rem;">åˆªé™¤ç­ç´š</button>
      <button class="btn btn-gray" id="cancelRename" style="padding:0.6rem 1rem;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- Edit Student -->
<div class="modal-overlay" id="editStudentModal">
  <div class="modal-box" style="max-width:380px;">
    <div class="modal-title" id="editStudentTitle">ç·¨è¼¯å­¸ç”Ÿ</div>
    <div style="display:flex;flex-direction:column;gap:0.875rem;margin-bottom:1.25rem;">
      <div><label class="form-label">åº§è™Ÿ</label><input type="number" class="form-input" id="editSeatNum"></div>
      <div><label class="form-label">å§“å</label><input type="text" class="form-input" id="editName"></div>
      <div>
        <label class="form-label">æ€§åˆ¥</label>
        <select class="form-select" id="editGender">
          <option value="male">ç”·ç”Ÿ ğŸ”µ</option>
          <option value="female">å¥³ç”Ÿ ğŸ”´</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" id="saveStudentBtn" style="flex:1;padding:0.6rem;">å„²å­˜</button>
      <button class="btn btn-red" id="deleteStudentBtn" style="padding:0.6rem 1rem;">åˆªé™¤</button>
      <button class="btn btn-gray" id="cancelEditStudent" style="padding:0.6rem 1rem;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- Bulk Edit -->
<div class="modal-overlay" id="bulkEditModal">
  <div class="modal-box" style="max-width:540px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
      <div class="modal-title" style="margin-bottom:0;">ç·¨è¼¯å­¸ç”Ÿåå–®</div>
      <div style="display:flex;gap:6px;">
        <button class="tab-switch active" id="switchGrid" onclick="app._switchBulkTab('grid')">æ ¼å­ç·¨è¼¯</button>
        <button class="tab-switch" id="switchImport" onclick="app._switchBulkTab('import')">ğŸ“¥ å¿«é€ŸåŒ¯å…¥</button>
      </div>
    </div>
    <!-- æ ¼å­æ¨¡å¼ -->
    <div id="bulkGridView">
      <div style="font-size:0.78rem;color:#94a3b8;margin-bottom:0.875rem;">é»æ“Šå­¸ç”Ÿå¯ç·¨è¼¯ Â· ç©ºæ ¼å¯æ–°å¢</div>
      <div id="bulkEditList" style="max-height:380px;overflow-y:auto;display:grid;grid-template-columns:repeat(5,1fr);gap:8px;"></div>
    </div>
    <!-- å¿«é€ŸåŒ¯å…¥æ¨¡å¼ -->
    <div id="bulkImportView" style="display:none;">
      <div style="font-size:0.82rem;color:#64748b;margin-bottom:0.75rem;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:0.75rem;">
        ğŸ“ æ¯è¡Œä¸€å€‹å­¸ç”Ÿï¼Œæ ¼å¼ï¼š<code style="background:#fef3c7;padding:1px 5px;border-radius:4px;">åº§è™Ÿ å§“å</code>ï¼ˆæ€§åˆ¥é¸å¡«ï¼‰<br>
        <span style="font-size:0.75rem;color:#92400e;">åº§è™Ÿ 1â€“20 é è¨­ç”·ç”Ÿï¼Œ21â€“40 é è¨­å¥³ç”Ÿ<br>éœ€è¦è¦†è“‹æ™‚åŠ  m æˆ– fï¼š&nbsp;<code style="background:#fef3c7;padding:1px 4px;border-radius:3px;">5 ç‹å°æ˜ f</code></span>
      </div>
      <textarea id="importText" class="form-input" rows="12"
        placeholder="1 ç‹æ›‰æ˜ m&#10;2 é™³å°èŠ³ f&#10;3 æå¤§æ˜&#10;..."
        style="font-family:monospace;font-size:0.9rem;resize:vertical;"></textarea>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:0.875rem;">
        <button class="btn btn-primary" id="confirmImportBtn" style="padding:0.6rem;">âœ… ç¢ºèªåŒ¯å…¥</button>
        <div style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="importOverwrite" style="cursor:pointer;">
          <label for="importOverwrite" style="font-size:0.8rem;color:#64748b;cursor:pointer;">è¦†è“‹ç¾æœ‰è³‡æ–™</label>
        </div>
      </div>
    </div>
    <button class="btn btn-gray" id="closeBulkEdit" style="width:100%;padding:0.6rem;margin-top:1rem;">é—œé–‰</button>
  </div>
</div>

<!-- Student Settings -->
<div class="modal-overlay" id="studentSettingsModal">
  <div class="modal-box" style="max-width:440px;">
    <div style="display:flex;align-items:baseline;gap:10px;margin-bottom:1.25rem;">
      <div class="modal-title" style="margin-bottom:0;" id="settingsName"></div>
      <div style="font-size:1.1rem;font-weight:700;color:#3b82f6;" id="settingsScore"></div>
    </div>
    <!-- Score adjust -->
    <div style="background:#f8fafc;border-radius:10px;padding:1rem;margin-bottom:0.875rem;">
      <div style="display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:0.6rem;">
        <input type="number" id="settingsAmt" value="1" min="1" max="10"
          style="width:46px;text-align:center;border:1.5px solid #e2e8f0;border-radius:7px;padding:4px;font-size:0.9rem;color:#1e293b;">
        <span style="color:#64748b;font-size:0.8rem;">åˆ†</span>
      </div>
      <div style="display:flex;gap:8px;justify-content:center;margin-bottom:0.75rem;">
        <button class="score-bubble settings-qs" data-s="1">1</button>
        <button class="score-bubble settings-qs" data-s="2">2</button>
        <button class="score-bubble settings-qs" data-s="3">3</button>
        <button class="score-bubble settings-qs" data-s="4">4</button>
        <button class="score-bubble settings-qs" data-s="5">5</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:0.625rem;">
        <button class="qr-btn qr-pos settings-reason" data-r="å›ç­”å•é¡Œ">ğŸ™‹ å›ç­”å•é¡Œ</button>
        <button class="qr-btn qr-pos settings-reason" data-r="å¹«è€å¸«å¿™">ğŸ¤ å¹«è€å¸«å¿™</button>
        <button class="qr-btn qr-neg settings-reason" data-r="ä¸Šèª²èŠå¤©">ğŸ’¬ ä¸Šèª²èŠå¤©</button>
        <button class="qr-btn qr-neg settings-reason" data-r="ä½œæ¥­æ²’å¯«">ğŸ“‹ ä½œæ¥­æ²’å¯«</button>
      </div>
      <div style="position:relative;margin-bottom:0.75rem;">
        <textarea id="settingsReason" class="form-input" rows="2" placeholder="âš ï¸ å¿…å¡«ï¼šè«‹è¼¸å…¥åŸå› æ‰èƒ½åŠ æ¸›åˆ†" style="resize:none;font-size:0.82rem;border-color:#fbbf24;"></textarea>
        <span style="position:absolute;top:-8px;right:8px;background:#ef4444;color:white;font-size:0.6rem;font-weight:700;padding:1px 6px;border-radius:10px;">å¿…å¡«</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <button class="btn btn-score-add" id="settingsAddBtn">ï¼‹ åŠ åˆ†</button>
        <button class="btn btn-score-sub" id="settingsSubBtn">ï¼ æ‰£åˆ†</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:0.875rem;">
      <button class="btn btn-outline btn-sm" id="settingsHistoryBtn">çæ‡²è¨˜éŒ„</button>
      <button class="btn btn-outline btn-sm" id="settingsEditBtn">ç·¨è¼¯è³‡æ–™</button>
      <button class="btn btn-amber btn-sm" id="settingsHomeworkBtn">ä½œæ¥­ç®¡ç†</button>
    </div>
    <button class="btn btn-gray" id="closeSettingsBtn" style="width:100%;padding:0.5rem;">é—œé–‰</button>
  </div>
</div>

<!-- Scores -->
<div class="modal-overlay" id="scoresModal">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-title">å€‹äººç©åˆ†æ’è¡Œæ¦œ</div>
    <div id="scoresList" style="max-height:380px;overflow-y:auto;"></div>
    <div style="display:flex;gap:8px;margin-top:1rem;">
      <button class="btn btn-red" id="resetAllScoresBtn" style="padding:0.5rem 0.875rem;">é‡ç½®å…¨éƒ¨</button>
      <button class="btn btn-gray" id="closeScoresBtn" style="flex:1;padding:0.5rem;">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- Group Scores -->
<div class="modal-overlay" id="groupScoresModal">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-title">å°çµ„ç©åˆ†æ’è¡Œæ¦œ</div>
    <div id="groupScoresList" style="max-height:380px;overflow-y:auto;"></div>
    <div style="display:flex;gap:8px;margin-top:1rem;">
      <button class="btn btn-red" id="resetGroupScoresBtn" style="padding:0.5rem 0.875rem;">é‡ç½®å…¨éƒ¨</button>
      <button class="btn btn-gray" id="closeGroupScoresBtn" style="flex:1;padding:0.5rem;">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- Group Score Adjust -->
<div class="modal-overlay" id="groupScoreModal">
  <div class="modal-box" style="max-width:380px;">
    <div class="modal-title" id="groupModalTitle">ç¬¬1çµ„ ç©åˆ†èª¿æ•´</div>
    <div style="display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:0.75rem;">
      <input type="number" id="groupScoreAmt" value="1" min="1" max="10"
        style="width:46px;text-align:center;border:1.5px solid #e2e8f0;border-radius:7px;padding:4px;font-size:0.9rem;">
      <span style="color:#64748b;font-size:0.8rem;">åˆ†</span>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:0.75rem;">
      <button class="btn btn-green" id="addGroupBtn" style="padding:0.5rem 1.5rem;">ï¼‹ åŠ åˆ†</button>
      <button class="btn btn-red" id="subGroupBtn" style="padding:0.5rem 1.5rem;">ï¼ æ‰£åˆ†</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:0.625rem;">
      <button class="qr-btn qr-pos group-reason" data-r="è¨è«–ç©æ¥µ">è¨è«–ç©æ¥µ</button>
      <button class="qr-btn qr-pos group-reason" data-r="åˆä½œè‰¯å¥½">åˆä½œè‰¯å¥½</button>
      <button class="qr-btn qr-neg group-reason" data-r="è¨è«–åµé¬§">è¨è«–åµé¬§</button>
      <button class="qr-btn qr-neg group-reason" data-r="ä¸åƒèˆ‡è¨è«–">ä¸åƒèˆ‡è¨è«–</button>
    </div>
    <textarea id="groupReason" class="form-input" rows="2" placeholder="åŸå› èªªæ˜..." style="resize:none;margin-bottom:0.875rem;"></textarea>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" id="confirmGroupScore" style="flex:1;padding:0.6rem;">ç¢ºèª</button>
      <button class="btn btn-gray" id="cancelGroupScore" style="padding:0.6rem 1rem;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- Lottery Result Modal -->
<div class="modal-overlay" id="lotteryResultModal">
  <div class="modal-box" style="max-width:420px;text-align:center;">
    <div style="font-size:2.5rem;margin-bottom:0.5rem;">ğŸ‰</div>
    <div class="modal-title" style="justify-content:center;display:flex;font-size:1.2rem;" id="lotteryResultTitle">æŠ½ç±¤çµæœ</div>
    <div id="lotteryResultList" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:1rem 0;"></div>
    <button class="btn btn-primary" id="closeLotteryResult" style="width:100%;padding:0.65rem;margin-top:0.5rem;">ç¢ºèª</button>
  </div>
</div>

<!-- Timer Modal -->
<div class="modal-overlay" id="timerModal">
  <div class="modal-box" style="max-width:360px;">
    <div class="modal-title">è¨­å®šå€’æ•¸è¨ˆæ™‚å™¨</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:0.875rem;">
      <div><label class="form-label">æ™‚</label><input type="number" class="form-input" id="timerH" value="0" min="0" max="23" style="text-align:center;"></div>
      <div><label class="form-label">åˆ†</label><input type="number" class="form-input" id="timerM" value="5" min="0" max="59" style="text-align:center;"></div>
      <div><label class="form-label">ç§’</label><input type="number" class="form-input" id="timerS" value="0" min="0" max="59" style="text-align:center;"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:0.875rem;">
      <button class="qr-btn qr-neutral quick-time" data-m="1">1åˆ†é˜</button>
      <button class="qr-btn qr-neutral quick-time" data-m="5">5åˆ†é˜</button>
      <button class="qr-btn qr-neutral quick-time" data-m="10">10åˆ†é˜</button>
      <button class="qr-btn qr-neutral quick-time" data-m="15">15åˆ†é˜</button>
      <button class="qr-btn qr-neutral quick-time" data-m="30">30åˆ†é˜</button>
      <button class="qr-btn qr-neutral quick-time" data-m="45">45åˆ†é˜</button>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-green" id="startTimerBtn" style="flex:1;padding:0.6rem;">é–‹å§‹è¨ˆæ™‚</button>
      <button class="btn btn-gray" id="cancelTimerBtn" style="padding:0.6rem 1rem;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- Time Up -->
<div class="modal-overlay" id="timeUpModal">
  <div class="modal-box" style="max-width:300px;text-align:center;">
    <div style="font-size:3rem;margin-bottom:0.75rem;">â°</div>
    <div class="modal-title" style="color:#ef4444;justify-content:center;display:flex;">æ™‚é–“åˆ°å›‰ï¼</div>
    <button class="btn btn-red" id="closeTimeUpBtn" style="width:100%;padding:0.75rem;margin-top:1rem;">ç¢ºèª</button>
  </div>
</div>

<!-- History -->
<div class="modal-overlay" id="historyModal">
  <div class="modal-box" style="max-width:440px;">
    <div class="modal-title" id="historyTitle"></div>
    <div id="historyList" style="max-height:380px;overflow-y:auto;"></div>
    <button class="btn btn-gray" id="closeHistoryBtn" style="width:100%;padding:0.5rem;margin-top:1rem;">é—œé–‰</button>
  </div>
</div>

<!-- Homework -->
<div class="modal-overlay" id="homeworkModal">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-title" id="homeworkTitle"></div>
    <div id="homeworkList" style="max-height:200px;overflow-y:auto;margin-bottom:0.875rem;min-height:48px;"></div>
    <div style="display:flex;gap:8px;margin-bottom:1rem;">
      <input type="text" class="form-input" id="newHwInput" placeholder="ä½œæ¥­åç¨±ï¼ˆä¾‹ï¼šæ•¸å­¸p.25ï¼‰" style="flex:1;">
      <button class="btn btn-primary" id="addHwBtn" style="padding:0.5rem 0.875rem;">æ–°å¢</button>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-green" id="saveHwBtn" style="flex:1;padding:0.5rem;">å„²å­˜</button>
      <button class="btn btn-gray" id="closeHwBtn" style="padding:0.5rem 1rem;">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ClassroomApp  Â·  Multi-class Â· Firebase Â· White Theme
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class ClassroomApp {
  constructor() {
    this.user = null;
    this.data = null;          // { classes:{}, homeworkNotes:{} }
    this.currentClassId = null;
    this.currentMode = 'normal'; // normal | group | exam | free
    this.isStudentView = false;
    this.seatSize = 100;       // px  (å‹•æ…‹èª¿æ•´)
    this.editingStudentId = null;
    this.currentSettingsSid = null;
    this.currentGroupNum = null;
    this.renamingClassId = null;
    this.flashIntervals = [];
    this.selectedStudents = [];
    this.isLotteryRunning = false;
    this.timerInterval = null;
    this.timerRemaining = 0;
    this.timerPaused = false;
    this.saveTimer = null;

    // Free seat drag state
    this.freeDrag = null;

    this._tryInit();
  }

  _tryInit() {
    if (window._firebaseReady && window._auth) {
      this._init();
    } else {
      // é‚„æ²’å¥½ï¼Œç”¨å…©ç¨®æ–¹å¼ç­‰
      window.addEventListener('firebaseReady', () => this._init(), { once: true });
      window._onFirebaseReady = () => this._init();
      // æœ€å¾Œä¿éšªï¼š3ç§’å¾Œé‚„æ²’å¥½å°±é¡¯ç¤ºéŒ¯èª¤
      setTimeout(() => {
        if (!this.user && !document.getElementById('loginScreen').style.display.includes('flex')) {
          if (!window._firebaseReady) {
            document.getElementById('loadingScreen').innerHTML =
              '<div style="text-align:center;padding:2rem;">' +
              '<div style="font-size:2rem;margin-bottom:1rem;">âš ï¸</div>' +
              '<div style="font-weight:600;color:#1e293b;margin-bottom:0.5rem;">Firebase è¼‰å…¥å¤±æ•—</div>' +
              '<div style="font-size:0.85rem;color:#64748b;margin-bottom:1.5rem;">è«‹ç¢ºèªç¶²è·¯é€£ç·šï¼Œæˆ–é‡æ–°æ•´ç†é é¢</div>' +
              '<button onclick="location.reload()" style="padding:0.6rem 1.5rem;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.9rem;">ğŸ”„ é‡æ–°æ•´ç†</button>' +
              '</div>';
          }
        }
      }, 8000);
    }
  }

  _init() {
    // è‹¥å·²å‘¼å«è¶…éä¸€æ¬¡ï¼Œç›´æ¥å¿½ç•¥
    if (this._initCalled) return;
    this._initCalled = true;

    window._onAuthStateChanged(window._auth, async user => {
      document.getElementById('loadingScreen').style.display = 'none';
      if (user) {
        this.user = user;
        document.getElementById('loginScreen').style.display = 'none';
        const app = document.getElementById('appScreen');
        app.style.display = 'flex';
        document.getElementById('userAvatar').src = user.photoURL || '';
        document.getElementById('userName').textContent = user.displayName || user.email;
        await this._load();
      } else {
        this.user = null;
        document.getElementById('appScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
      }
    });
    this._bindEvents();
  }

  // â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async _load() {
    try {
      const ref = window._fsDoc(window._db, 'teachers', this.user.uid);
      const snap = await window._fsGetDoc(ref);
      if (snap.exists()) {
        this.data = snap.data();
        if (!this.data.classes) this.data.classes = {};
        if (!this.data.homeworkNotes) this.data.homeworkNotes = {};
        // è£œé½Š classOrderï¼ˆèˆŠè³‡æ–™ç›¸å®¹ï¼‰
        // è£œé½Šæ–°æ¨¡å¼åº§ä½å’Œæ¬„ä½
        Object.values(this.data.classes).forEach(cls => {
          if (!cls.scilabSeats)   cls.scilabSeats   = {};
          if (!cls.computerSeats) cls.computerSeats = {};
          if (!cls.groupNames)    cls.groupNames     = {};
        });
        if (!this.data.classOrder || !Array.isArray(this.data.classOrder)) {
          this.data.classOrder = Object.keys(this.data.classes);
        } else {
          const existing = new Set(Object.keys(this.data.classes));
          this.data.classOrder = this.data.classOrder.filter(id => existing.has(id));
          Object.keys(this.data.classes).forEach(id => {
            if (!this.data.classOrder.includes(id)) this.data.classOrder.push(id);
          });
        }
      } else {
        this.data = {
          classes: { class1: this._newClass('æˆ‘çš„ç­ç´š') },
          classOrder: ['class1'],
          homeworkNotes: {}
        };
        await this._save();
      }
      this.currentClassId = this.data.classOrder[0] || Object.keys(this.data.classes)[0] || null;
      this._renderTabs();
      this._renderAll();
    } catch(e) {
      console.error(e);
      this._setSyncStatus('error');
    }
  }

  _scheduleSave() {
    clearTimeout(this.saveTimer);
    this.saveTimer = setTimeout(() => this._save(), 1500);
  }

  async _save() {
    if (!this.user) return;
    this._setSyncStatus('syncing');
    try {
      const ref = window._fsDoc(window._db, 'teachers', this.user.uid);
      await window._fsSetDoc(ref, { ...this.data, uid: this.user.uid, updatedAt: Date.now() });
      this._setSyncStatus('synced');
    } catch(e) { this._setSyncStatus('error'); }
  }

  _setSyncStatus(s) {
    const dot = document.getElementById('syncDot');
    const txt = document.getElementById('syncText');
    dot.className = 'sync-dot' + (s==='syncing'?' syncing':'');
    if (s==='syncing') { dot.style.background=''; txt.textContent='åŒæ­¥ä¸­...'; }
    else if (s==='synced') { dot.style.background='#22c55e'; txt.textContent='å·²åŒæ­¥'; }
    else { dot.style.background='#ef4444'; txt.textContent='åŒæ­¥å¤±æ•—'; }
  }

  // â”€â”€ Data helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _newClass(name) {
    const students = {};
    for (let i=1;i<=15;i++) students[`s${i}`]={id:`s${i}`,seatNumber:i,name:`å­¸ç”Ÿ${i}`,gender:'male'};
    for (let i=21;i<=35;i++) students[`s${i}`]={id:`s${i}`,seatNumber:i,name:`å­¸ç”Ÿ${i}`,gender:'female'};
    return { name, students, normalSeats:{}, groupSeats:{}, examSeats:{}, freeSeats:{},
             scilabSeats:{}, computerSeats:{},
             groupNames:{},
             scores:{}, scoreHistory:{}, groupScores:{}, groupScoreHistory:{} };
  }

  get _cls() { return this.data.classes[this.currentClassId] || {}; }
  get _students() { return this._cls.students || {}; }
  get _seats() {
    const c = this._cls;
    if (this.currentMode==='normal')   return c.normalSeats||{};
    if (this.currentMode==='group')    return c.groupSeats||{};
    if (this.currentMode==='exam')     return c.examSeats||{};
    if (this.currentMode==='free')     return c.freeSeats||{};
    if (this.currentMode==='scilab')   return c.scilabSeats||{};
    if (this.currentMode==='computer') return c.computerSeats||{};
    return {};
  }
  _setSeats(s) {
    const c = this.data.classes[this.currentClassId];
    if (this.currentMode==='normal')   c.normalSeats=s;
    else if (this.currentMode==='group')    c.groupSeats=s;
    else if (this.currentMode==='exam')     c.examSeats=s;
    else if (this.currentMode==='free')     c.freeSeats=s;
    else if (this.currentMode==='scilab')   c.scilabSeats=s;
    else if (this.currentMode==='computer') c.computerSeats=s;
  }
  get _scores() { return this._cls.scores||{}; }
  get _hw() { return this.data.homeworkNotes||{}; }
  _hwCount(sid) { return (this._hw[sid]||[]).length; }

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _renderAll() { this._renderStudentList(); this._renderSeats(); }

  _renderTabs() {
    const container = document.getElementById('classTabs');
    container.innerHTML = '';
    // ç¢ºä¿ classOrder å­˜åœ¨
    if (!this.data.classOrder) this.data.classOrder = Object.keys(this.data.classes);
    const order = this.data.classOrder;

    order.forEach((id, idx) => {
      const cls = this.data.classes[id];
      if (!cls) return;
      const tab = document.createElement('div');
      tab.className = 'class-tab' + (id === this.currentClassId ? ' active' : '');
      tab.draggable = true;
      tab.dataset.classId = id;
      tab.innerHTML = `
        <span class="drag-handle" title="æ‹–æ›³æ’åº">â ¿</span>
        <span class="tab-name">${cls.name}</span>
        <span class="class-tab-rename" title="ä¿®æ”¹åç¨±">âœï¸</span>
      `;

      // åˆ‡æ›ç­ç´š
      tab.querySelector('.tab-name').onclick = () => {
        this.currentClassId = id;
        this._renderTabs();
        this._renderAll();
      };

      // é‡æ–°å‘½å
      tab.querySelector('.class-tab-rename').onclick = e => {
        e.stopPropagation();
        this.renamingClassId = id;
        document.getElementById('renameClassInput').value = cls.name;
        this._showModal('renameClassModal');
      };

      // â”€â”€ Tab æ‹–æ›³æ’åº â”€â”€
      tab.addEventListener('dragstart', e => {
        e.dataTransfer.setData('tabId', id);
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => tab.classList.add('tab-dragging'), 0);
        this._dragTabId = id;
      });
      tab.addEventListener('dragend', () => {
        tab.classList.remove('tab-dragging');
        container.querySelectorAll('.class-tab').forEach(t => {
          t.classList.remove('tab-drag-over-left', 'tab-drag-over-right');
        });
        this._dragTabId = null;
      });
      tab.addEventListener('dragover', e => {
        e.preventDefault();
        if (!this._dragTabId || this._dragTabId === id) return;
        const rect = tab.getBoundingClientRect();
        const mid = rect.left + rect.width / 2;
        tab.classList.remove('tab-drag-over-left', 'tab-drag-over-right');
        if (e.clientX < mid) tab.classList.add('tab-drag-over-left');
        else tab.classList.add('tab-drag-over-right');
      });
      tab.addEventListener('dragleave', () => {
        tab.classList.remove('tab-drag-over-left', 'tab-drag-over-right');
      });
      tab.addEventListener('drop', e => {
        e.preventDefault();
        tab.classList.remove('tab-drag-over-left', 'tab-drag-over-right');
        const fromId = this._dragTabId;
        if (!fromId || fromId === id) return;

        const rect = tab.getBoundingClientRect();
        const mid = rect.left + rect.width / 2;
        const insertBefore = e.clientX < mid;

        const arr = [...this.data.classOrder];
        const fromIdx = arr.indexOf(fromId);
        const toIdx = arr.indexOf(id);
        if (fromIdx === -1 || toIdx === -1) return;

        // ç§»é™¤ from
        arr.splice(fromIdx, 1);
        // é‡æ–°è¨ˆç®— to çš„ index
        const newToIdx = arr.indexOf(id);
        arr.splice(insertBefore ? newToIdx : newToIdx + 1, 0, fromId);

        this.data.classOrder = arr;
        this._renderTabs();
        this._scheduleSave();
      });

      container.appendChild(tab);
    });
  }

  // ä¸€éµä¾åç¨±æ’åº
  _sortClassesByName() {
    if (!this.data.classOrder) this.data.classOrder = Object.keys(this.data.classes);
    this.data.classOrder.sort((a, b) => {
      const na = (this.data.classes[a]?.name || '').localeCompare(this.data.classes[b]?.name || '', 'zh-TW', { numeric: true });
      return na;
    });
    this._renderTabs();
    this._scheduleSave();
  }

  _renderStudentList() {
    const container = document.getElementById('studentList');
    container.innerHTML = '';
    for (let i=1;i<=40;i++) {
      const st = Object.values(this._students).find(s=>s.seatNumber===i);
      const chip = document.createElement('div');
      if (st) {
        const hw = this._hwCount(st.id);
        chip.className = 's-chip ' + (st.gender === 'male' ? 's-chip-male' : 's-chip-female');
        chip.draggable = true;
        chip.dataset.studentId = st.id;
        chip.innerHTML = `
          <div class="sn">${st.seatNumber}</div>
          <div class="nm">${st.name.length>3?st.name.slice(0,3):st.name}</div>
          ${hw>0?`<div style="font-size:0.5rem;color:#f59e0b;">${'â˜…'.repeat(Math.min(hw,3))}</div>`:''}
        `;
        chip.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', `student:${st.id}`);
          chip.classList.add('dragging');
        });
        chip.addEventListener('dragend', () => chip.classList.remove('dragging'));
        let tt=0;
        chip.addEventListener('dblclick', () => this._showSettings(st.id));
        chip.addEventListener('touchend', e => {
          const now=Date.now(),d=now-tt;
          if(d<400&&d>0){e.preventDefault();this._showSettings(st.id);}
          tt=now;
        });
      } else {
        chip.className = 's-chip empty';
        chip.innerHTML = `<div class="sn" style="color:#94a3b8;">${i}</div><div style="font-size:0.55rem;color:#94a3b8;">ç©º</div>`;
        chip.onclick = () => this._openEditStudent(null, i);
      }
      container.appendChild(chip);
    }
  }

  _renderSeats() {
    const area = document.getElementById('seatingArea');
    area.innerHTML = '';

    if (this.currentMode === 'free') {
      this._renderFreeSeats(area);
      return;
    }

    if (this.isStudentView) {
      const p = document.createElement('div'); p.className='podium'; p.textContent='è¬›  å°';
      area.appendChild(p);
    }

    if (this.currentMode==='normal') this._renderNormal(area);
    else if (this.currentMode==='group') this._renderGroup(area);
    else if (this.currentMode==='exam') this._renderExam(area);
    else if (this.currentMode==='scilab') this._renderSciLab(area);
    else if (this.currentMode==='computer') this._renderComputer(area);

    if (!this.isStudentView) {
      const p = document.createElement('div'); p.className='podium'; p.style.marginTop='1.25rem'; p.textContent='è¬›  å°';
      area.appendChild(p);
    }
  }

  // Normal: 5 rows Ã— 6 cols (2-2-2)
  _renderNormal(container) {
    const sz = this.seatSize;
    const rows = this.isStudentView?[4,3,2,1,0]:[0,1,2,3,4];
    rows.forEach(row => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'normal-row';
      const order = this.isStudentView?[5,4,3,2,1,0]:[0,1,2,3,4,5];
      for (let g=0;g<3;g++) {
        const grp = document.createElement('div'); grp.className='seat-group';
        for (let k=0;k<2;k++) {
          grp.appendChild(this._mkSeat(row*6+order[g*2+k], sz));
        }
        rowDiv.appendChild(grp);
      }
      container.appendChild(rowDiv);
    });
  }

  // Group: 6 groups Ã— 5 seats
  // è€å¸«è¦–è§’ï¼ˆå¾æ•™å®¤å¾Œæ–¹çœ‹ï¼‰ï¼š
  //   pos0=æœ€å‰å–®åº§; pos1=å·¦, pos2=å³(ç¬¬2æ’); pos3=å·¦, pos4=å³(æœ€å¾Œæ’)
  //   çµ„é †åº: ä¸ŠåŠ3çµ„[3,4,5]+ä¸‹åŠ3çµ„[0,1,2] â†’ é¡¯ç¤ºå·¦æ¬„[0,1,2]å³æ¬„[3,4,5]
  // å­¸ç”Ÿè¦–è§’ï¼šä¸Šä¸‹ç¿»è½‰ï¼Œæ¯æ’å…§å·¦å³ä¸è®Š
  //   posé †åº: [3,4] â†’ [1,2] â†’ [0]
  //   çµ„é †åºç¿»è½‰: ä¸ŠåŠ/ä¸‹åŠå°èª¿
  _renderGroup(container) {
    const sv = this.isStudentView;
    const sz = this.seatSize;
    const gc = document.createElement('div'); gc.className='group-grid';
    // è€å¸«è¦–è§’: å·¦æ¬„[0,1,2]ç”±ä¸Šâ†’ä¸‹, å³æ¬„[3,4,5]ç”±ä¸Šâ†’ä¸‹
    // å­¸ç”Ÿè¦–è§’: ä¸Šä¸‹ç¿» â†’ å·¦æ¬„[2,1,0], å³æ¬„[5,4,3]ï¼ˆå·¦å³æ¬„ä¸æ›ï¼‰
    const groupOrder = sv ? [2,1,0,5,4,3] : [0,1,2,3,4,5];
    // æ¯çµ„å…§åº§ä½æ’åˆ—ï¼šè€å¸«è¦–è§’ [[0],[1,2],[3,4]]ï¼›å­¸ç”Ÿè¦–è§’ä¸Šä¸‹ç¿» [[3,4],[1,2],[0]]
    const seatRows = sv ? [[3,4],[1,2],[0]] : [[0],[1,2],[3,4]];
    // çµ„åç¨±å­˜åœ¨classè³‡æ–™è£¡
    const cls = this._cls;
    if (!cls.groupNames) cls.groupNames = {};
    groupOrder.forEach(g => {
      const box = document.createElement('div'); box.className='group-box';
      const groupName = cls.groupNames[g] || `ç¬¬${g+1}çµ„`;
      const lbl = document.createElement('button'); lbl.className='group-lbl-btn';
      lbl.textContent = groupName;
      lbl.onclick = () => this._showGroupScoreModal(g+1);
      // é›™æ“Šé‡å‘½å
      lbl.ondblclick = (e) => {
        e.stopPropagation();
        const newName = prompt(`ä¿®æ”¹çµ„åï¼ˆç›®å‰ï¼š${groupName}ï¼‰`, groupName);
        if (newName !== null && newName.trim()) {
          cls.groupNames[g] = newName.trim();
          this._scheduleSave();
          this._renderSeats();
        }
      };
      box.appendChild(lbl);
      const inner = document.createElement('div'); inner.className='group-inner';
      seatRows.forEach(sr => {
        const rDiv = document.createElement('div'); rDiv.className='group-row';
        sr.forEach(s => rDiv.appendChild(this._mkSeat(g*5+s, sz)));
        inner.appendChild(rDiv);
      });
      box.appendChild(inner);
      gc.appendChild(box);
    });
    container.appendChild(gc);
  }

  // Exam: 6 rows Ã— 6 cols
  _renderExam(container) {
    const sz = this.seatSize;
    const rows = this.isStudentView?[5,4,3,2,1,0]:[0,1,2,3,4,5];
    rows.forEach(row => {
      const rowDiv = document.createElement('div'); rowDiv.className='normal-row';
      const order = this.isStudentView?[5,4,3,2,1,0]:[0,1,2,3,4,5];
      order.forEach(col => rowDiv.appendChild(this._mkSeat(row*6+col, sz)));
      container.appendChild(rowDiv);
    });
  }

  // â”€â”€ Sci Lab: 6æ¡Œ å·¦3å³3ï¼Œæ¯æ¡Œé•·é‚Š3åº§(é¢å°)+çŸ­é‚Š2åº§ â”€â”€
  // åº§ä½ç·¨è™Ÿï¼šæ¡Œ0~5ï¼Œæ¯æ¡Œpos = table*5 + 0..4
  // pos0,1,2 = é•·é‚Š(é è¬›å°)ï¼›pos3,4 = çŸ­é‚Š(å¾Œå´)
  //
  // è€å¸«è¦–è§’: å·¦æ¬„[1,2,3çµ„ç”±ä¸Šâ†“]  å³æ¬„[4,5,6çµ„ç”±ä¸Šâ†“]  æ¯çµ„é•·é‚Šåœ¨ä¸Š
  // å­¸ç”Ÿè¦–è§’: ä¸Šä¸‹ç¿»è½‰ï¼ˆä¸ç¿»å·¦å³ï¼‰
  //           å·¦æ¬„[3,2,1çµ„ç”±ä¸Šâ†“]  å³æ¬„[6,5,4çµ„ç”±ä¸Šâ†“]  æ¯çµ„çŸ­é‚Šåœ¨ä¸Š
  _renderSciLab(container) {
    const sv = this.isStudentView;
    const sz = this.seatSize;
    const grid = document.createElement('div');
    grid.className = 'scilab-grid';

    const leftSection  = document.createElement('div'); leftSection.className='scilab-section';
    const rightSection = document.createElement('div'); rightSection.className='scilab-section';

    // è€å¸«è¦–è§’: [0,1,2] åœ¨å·¦æ¬„, [3,4,5] åœ¨å³æ¬„ï¼Œå„è‡ªç”±ä¸Šåˆ°ä¸‹
    // å­¸ç”Ÿè¦–è§’: ä¸Šä¸‹ç¿»è½‰ â†’ å·¦æ¬„ [2,1,0], å³æ¬„ [5,4,3]ï¼ˆå·¦å³æ¬„ä¸äº¤æ›ï¼‰
    const leftOrder  = sv ? [2,1,0] : [0,1,2];
    const rightOrder = sv ? [5,4,3] : [3,4,5];

    const makeTable = (t) => {
      const tableEl = document.createElement('div');
      tableEl.className = 'scilab-table';

      const lbl = document.createElement('button');
      lbl.className = 'scilab-table-lbl';
      const scGroupName = (this._cls.groupNames||{})[t] || `ç¬¬${t+1}çµ„`;
      lbl.textContent = scGroupName;
      lbl.onclick = () => this._showGroupScoreModal(t+1);
      lbl.ondblclick = (e) => {
        e.stopPropagation();
        const newName = prompt(`ä¿®æ”¹çµ„åï¼ˆç›®å‰ï¼š${scGroupName}ï¼‰`, scGroupName);
        if (newName !== null && newName.trim()) {
          if (!this._cls.groupNames) this._cls.groupNames = {};
          this._cls.groupNames[t] = newName.trim();
          this._scheduleSave();
          this._renderSeats();
        }
      };
      tableEl.appendChild(lbl);

      if (sv) {
        // å­¸ç”Ÿè¦–è§’ï¼šçŸ­é‚Šåœ¨ä¸Šï¼Œé•·é‚Šåœ¨ä¸‹
        const shortRow = document.createElement('div');
        shortRow.className = 'scilab-short-row';
        [4,3].forEach(s => shortRow.appendChild(this._mkSeat(t*5+s, sz)));
        tableEl.appendChild(shortRow);

        const div = document.createElement('div');
        div.className = 'scilab-divider';
        tableEl.appendChild(div);

        const longRow = document.createElement('div');
        longRow.className = 'scilab-long-row';
        [2,1,0].forEach(s => longRow.appendChild(this._mkSeat(t*5+s, sz)));
        tableEl.appendChild(longRow);
      } else {
        // è€å¸«è¦–è§’ï¼šé•·é‚Šåœ¨ä¸Šï¼ŒçŸ­é‚Šåœ¨ä¸‹
        const longRow = document.createElement('div');
        longRow.className = 'scilab-long-row';
        [0,1,2].forEach(s => longRow.appendChild(this._mkSeat(t*5+s, sz)));
        tableEl.appendChild(longRow);

        const div = document.createElement('div');
        div.className = 'scilab-divider';
        tableEl.appendChild(div);

        const shortRow = document.createElement('div');
        shortRow.className = 'scilab-short-row';
        [3,4].forEach(s => shortRow.appendChild(this._mkSeat(t*5+s, sz)));
        tableEl.appendChild(shortRow);
      }
      return tableEl;
    };

    leftOrder.forEach(t  => leftSection.appendChild(makeTable(t)));
    rightOrder.forEach(t => rightSection.appendChild(makeTable(t)));

    grid.appendChild(leftSection);
    grid.appendChild(rightSection);
    container.appendChild(grid);
  }

  // â”€â”€ Computer Room: ç¸±æ’ 3æ¬„Ã—10åˆ— é¢å‘è¬›æ¡Œ â”€â”€
  // posKey: col*10 + row  (col=0,1,2; row=0..9 å‰â†’å¾Œ)
  // è¢å¹•: é¡¯ç¤º 10 æ©«åˆ—ï¼Œæ¯åˆ— 3 å€‹åº§ä½ï¼ˆä»£è¡¨å·¦ä¸­å³3æ¬„ï¼‰
  // è€å¸«è¦–è§’: ç¬¬1åˆ—åœ¨è¬›å°æ—ï¼Œç¬¬10åˆ—æœ€é 
  // å­¸ç”Ÿè¦–è§’: ç¿»è½‰ï¼Œç¬¬10åˆ—(æœ€é )åœ¨ä¸Šï¼Œç¬¬1åˆ—(è¬›å°æ—)åœ¨ä¸‹
  _renderComputer(container) {
    const sz = Math.min(this.seatSize, 105);
    const area = document.createElement('div');
    area.style.cssText = 'display:flex;flex-direction:column;gap:6px;align-items:center;';

    // rowOrder: è€å¸«è¦–è§’ row0(å‰)åœ¨ä¸‹æ–¹â†’å¾0æ¸²æŸ“åˆ°9; å­¸ç”Ÿè¦–è§’ç›¸å
    const rowOrder = this.isStudentView ? [9,8,7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7,8,9];
    // æ¬„é †åºï¼šè€å¸«è¦–è§’ col=0(å·¦)â†’2(å³); å­¸ç”Ÿè¦–è§’ä¹Ÿå·¦â†’å³ï¼ˆä¸éœ€ç¿»è½‰ï¼Œåªç¿»å‰å¾Œï¼‰
    const colOrder = [0,1,2];

    rowOrder.forEach(row => {
      const wrap = document.createElement('div');
      wrap.style.cssText = 'display:flex;align-items:center;gap:6px;';

      const lbl = document.createElement('div');
      lbl.style.cssText = 'font-size:0.68rem;font-weight:700;color:#7c3aed;min-width:32px;text-align:right;background:#f3e8ff;border:1px solid #ddd6fe;border-radius:5px;padding:2px 4px;';
      lbl.textContent = `ç¬¬${row+1}åˆ—`;
      wrap.appendChild(lbl);

      const rowDiv = document.createElement('div');
      rowDiv.style.cssText = 'display:flex;gap:6px;';
      colOrder.forEach(col => rowDiv.appendChild(this._mkSeat(col*10+row, sz)));
      wrap.appendChild(rowDiv);

      area.appendChild(wrap);
    });
    container.appendChild(area);
  }

  _mkSeat(position, sz) {
    const el = document.createElement('div');
    el.className = 'seat';
    el.dataset.position = position;
    el.style.width = sz+'px';
    el.style.height = Math.round(sz*0.65)+'px';
    const seats = this._seats;
    const sid = seats[position];
    if (sid) {
      const st = this._students[sid];
      if (st) {
        // æ€§åˆ¥åº•è‰²
        el.classList.add(st.gender === 'male' ? 'seat-male' : 'seat-female');
        const hw = this._hwCount(st.id);
        const nameSz = Math.max(10, Math.round(sz*0.13));
        const numSz  = Math.max(9,  Math.round(sz*0.11));
        el.innerHTML = `
          <div class="seat-no" style="font-size:${numSz}px;">${st.seatNumber}</div>
          <div class="seat-nm" style="font-size:${nameSz}px;">${st.name.length>4?st.name.slice(0,4):st.name}</div>
          ${hw>0?`<div class="seat-hw">${'â­'.repeat(Math.min(hw,4))}${hw>4?'+':''}</div>`:''}
        `;
        let tt=0;
        el.addEventListener('dblclick',()=>{if(!this.isLotteryRunning)this._showSettings(st.id);});
        el.addEventListener('touchend',e=>{
          const now=Date.now(),d=now-tt;
          if(d<400&&d>0){e.preventDefault();this._showSettings(st.id);}
          tt=now;
        });
      }
    } else {
      el.classList.add('empty-seat');
      const hintSz = Math.max(9, Math.round(sz*0.1));
      el.innerHTML = `<div style="color:#cbd5e1;font-size:${hintSz}px;">ç©ºä½</div>`;
    }
    this._makeDrop(el);
    this._makeDragSeat(el);
    return el;
  }

  // â”€â”€ Free Seats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _renderFreeSeats(area) {
    area.innerHTML = '';
    // è¬›å°ï¼ˆè‡ªç”±æ¨¡å¼ä¹Ÿè¦æœ‰ï¼‰
    if (this.isStudentView) {
      const p = document.createElement('div'); p.className='podium'; p.textContent='è¬›  å°';
      area.appendChild(p);
    }
    const wrap = document.createElement('div');
    wrap.id = 'freeArea';

    const hint = document.createElement('div');
    hint.className = 'free-hint';
    hint.innerHTML = 'å°‡å·¦å´å­¸ç”Ÿæ‹–æ›³åˆ°æ­¤å€åŸŸ<br>å¯è‡ªç”±æ’åˆ—ä½ç½®<br><span style="font-size:0.8rem;opacity:0.7;">é›™æ“Šåº§ä½å¯åŠ æ¸›åˆ† Â· å³éµç§»é™¤</span>';
    wrap.appendChild(hint);

    const sz = this.seatSize;
    const freeSeats = this._seats;
    // è¨ˆç®— freeArea çš„é«˜åº¦ï¼ˆå›ºå®š 500px minHeightï¼‰ï¼Œç”¨æ–¼å­¸ç”Ÿè¦–è§’ç¿»è½‰
    const areaH = 500;
    const seatH = Math.round(sz * 0.65);
    Object.entries(freeSeats).forEach(([posKey, sid]) => {
      const st = this._students[sid];
      if (!st) return;
      const coords = posKey.split(',');
      let x = parseFloat(coords[0]);
      let y = parseFloat(coords[1]);
      // å­¸ç”Ÿè¦–è§’ï¼šå‚ç›´ç¿»è½‰ y åº§æ¨™
      if (this.isStudentView) {
        y = areaH - y - seatH;
      }
      const el = this._mkFreeSeat(posKey, st, x, y, sz);
      wrap.appendChild(el);
    });

    // Drop onto free area from student panel
    wrap.addEventListener('dragover', e => { e.preventDefault(); wrap.classList.add('drop-active'); });
    wrap.addEventListener('dragleave', () => wrap.classList.remove('drop-active'));
    wrap.addEventListener('drop', e => {
      e.preventDefault();
      wrap.classList.remove('drop-active');
      const data = e.dataTransfer.getData('text/plain');
      const rect = wrap.getBoundingClientRect();
      const x = Math.max(0, e.clientX - rect.left - sz/2);
      const y = Math.max(0, e.clientY - rect.top  - Math.round(sz*0.65)/2);
      const freeSeats = { ...this._seats };
      if (data.startsWith('student:')) {
        const sid = data.replace('student:','');
        // remove from any existing free seat
        Object.keys(freeSeats).forEach(k => { if (freeSeats[k]===sid) delete freeSeats[k]; });
        freeSeats[`${x},${y}`] = sid;
        this._setSeats(freeSeats);
        this._scheduleSave();
        this._renderSeats();
      } else if (data.startsWith('freemove:')) {
        const oldKey = data.replace('freemove:','');
        const sid = freeSeats[oldKey];
        if (sid) {
          delete freeSeats[oldKey];
          freeSeats[`${x},${y}`] = sid;
          this._setSeats(freeSeats);
          this._scheduleSave();
          this._renderSeats();
        }
      }
    });

    area.appendChild(wrap);
    // è€å¸«è¦–è§’ï¼šè¬›å°åœ¨ä¸‹æ–¹
    if (!this.isStudentView) {
      const p = document.createElement('div'); p.className='podium'; p.style.marginTop='1rem'; p.textContent='è¬›  å°';
      area.appendChild(p);
    }
  }

  _mkFreeSeat(posKey, st, x, y, sz) {
    const el = document.createElement('div');
    el.className = 'free-seat ' + (st.gender === 'male' ? 'free-seat-male' : 'free-seat-female');
    el.dataset.posKey = posKey;
    el.dataset.pk = btoa(unescape(encodeURIComponent(posKey))); // safe for selector
    el.style.left = x+'px';
    el.style.top  = y+'px';
    el.style.width = sz+'px';
    el.style.height = Math.round(sz*0.65)+'px';
    const hw = this._hwCount(st.id);
    const nameSz = Math.max(10, Math.round(sz*0.13));
    const numSz  = Math.max(9,  Math.round(sz*0.11));
    el.innerHTML = `
      <div class="seat-no" style="font-size:${numSz}px;color:#7c3aed;">${st.seatNumber}</div>
      <div class="seat-nm" style="font-size:${nameSz}px;">${st.name.length>4?st.name.slice(0,4):st.name}</div>
      ${hw>0?`<div class="seat-hw">${'â­'.repeat(Math.min(hw,4))}${hw>4?'+':''}</div>`:''}
    `;

    // Double-click to open settings
    let tt=0;
    el.addEventListener('dblclick', ()=>{if(!this.isLotteryRunning)this._showSettings(st.id);});
    el.addEventListener('touchend',e=>{
      const now=Date.now(),d=now-tt;
      if(d<400&&d>0){e.preventDefault();this._showSettings(st.id);}
      tt=now;
    });

    // Right-click to remove
    el.addEventListener('contextmenu', e => {
      e.preventDefault();
      if (confirm(`ç§»é™¤ ${st.name} çš„è‡ªç”±åº§ä½ï¼Ÿ`)) {
        const freeSeats = { ...this._seats };
        delete freeSeats[posKey];
        this._setSeats(freeSeats);
        this._scheduleSave();
        this._renderSeats();
      }
    });

    // Drag to move within free area
    el.draggable = true;
    el.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', `freemove:${posKey}`);
      el.classList.add('dragging-free');
    });
    el.addEventListener('dragend', () => el.classList.remove('dragging-free'));

    return el;
  }

  // â”€â”€ Drag & Drop for normal/group/exam â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _makeDragSeat(el) {
    el.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', `seat:${el.dataset.position}`);
      el.classList.add('dragging');
    });
    el.addEventListener('dragend', () => el.classList.remove('dragging'));
  }

  _makeDrop(el) {
    el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drop-zone'); });
    el.addEventListener('dragleave', () => el.classList.remove('drop-zone'));
    el.addEventListener('drop', e => {
      e.preventDefault();
      el.classList.remove('drop-zone');
      const data = e.dataTransfer.getData('text/plain');
      const toPos = parseInt(el.dataset.position);
      const seats = { ...this._seats };
      if (data.startsWith('student:')) {
        const sid = data.replace('student:','');
        Object.keys(seats).forEach(p => { if(seats[p]===sid) delete seats[p]; });
        seats[toPos] = sid;
      } else if (data.startsWith('seat:')) {
        const fromPos = parseInt(data.replace('seat:',''));
        const tmp = seats[fromPos]; seats[fromPos]=seats[toPos]; seats[toPos]=tmp;
        if (!seats[fromPos]) delete seats[fromPos];
        if (!seats[toPos])   delete seats[toPos];
      }
      this._setSeats(seats);
      this._scheduleSave();
      this._renderAll();
    });
  }

  // â”€â”€ Student Settings Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _showSettings(sid) {
    const st = this._students[sid];
    if (!st) return;
    this.currentSettingsSid = sid;
    document.getElementById('settingsName').textContent = `${st.seatNumber}è™Ÿ ${st.name}`;
    document.getElementById('settingsScore').textContent = `${this._scores[sid]||0} åˆ†`;
    document.getElementById('settingsReason').value = '';
    document.getElementById('settingsAmt').value = 1;
    this._showModal('studentSettingsModal');
  }

  _adjustScore(type) {
    const sid = this.currentSettingsSid;
    const reason = document.getElementById('settingsReason').value.trim();
    if (!reason) {
      // è¦–è¦ºæç¤ºå¿…å¡«
      const ta = document.getElementById('settingsReason');
      ta.style.borderColor = '#ef4444';
      ta.style.animation = 'shake 0.3s ease';
      setTimeout(() => { ta.style.borderColor = '#fbbf24'; ta.style.animation = ''; }, 1200);
      ta.focus();
      return;
    }
    const amt = parseInt(document.getElementById('settingsAmt').value)||1;
    const change = type*amt;
    const cls = this.data.classes[this.currentClassId];
    if (!cls.scores) cls.scores={};
    if (!cls.scoreHistory) cls.scoreHistory={};
    if (!cls.scoreHistory[sid]) cls.scoreHistory[sid]=[];
    cls.scores[sid] = (cls.scores[sid]||0) + change;
    cls.scoreHistory[sid].push({ date:new Date().toLocaleString('zh-TW'), change, reason, total:cls.scores[sid] });
    document.getElementById('settingsScore').textContent = `${cls.scores[sid]} åˆ†`;
    document.getElementById('settingsReason').value = '';
    this._scheduleSave();
    this._renderAll();
  }

  // â”€â”€ Group Score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _showGroupScoreModal(g) {
    this.currentGroupNum = g;
    document.getElementById('groupModalTitle').textContent = `ç¬¬${g}çµ„ ç©åˆ†èª¿æ•´`;
    document.getElementById('groupReason').value = '';
    this._showModal('groupScoreModal');
  }

  _adjustGroupScore(type) {
    const g = this.currentGroupNum;
    const reason = document.getElementById('groupReason').value.trim();
    if (!reason) { alert('è«‹è¼¸å…¥åŸå› '); return; }
    const amt = parseInt(document.getElementById('groupScoreAmt').value)||1;
    const change = type*amt;
    const cls = this.data.classes[this.currentClassId];
    if (!cls.groupScores) cls.groupScores={};
    if (!cls.groupScoreHistory) cls.groupScoreHistory={};
    cls.groupScores[g] = (cls.groupScores[g]||0)+change;
    if (!cls.groupScoreHistory[g]) cls.groupScoreHistory[g]=[];
    cls.groupScoreHistory[g].push({ date:new Date().toLocaleString('zh-TW'), change, reason, total:cls.groupScores[g] });
    this._scheduleSave();
    this._hideModal('groupScoreModal');
    alert(`ç¬¬${g}çµ„ ${change>0?'+':''}${change}åˆ† âœ“`);
  }

  // â”€â”€ Lottery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _startLottery(type) {
    if (this.isLotteryRunning) return;
    this._clearSel();
    const seats = this._seats;
    const isFree = this.currentMode === 'free';
    const eligible = [];
    Object.entries(seats).forEach(([posKey, sid]) => {
      const st = this._students[sid];
      if (st && (type==='all'||st.gender===type)) eligible.push({posKey, st});
    });
    const count = parseInt(document.getElementById('lotteryCount').value)||1;
    if (!eligible.length) { alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿåœ¨åº§ä½ä¸Š'); return; }
    if (count > eligible.length) { alert(`åªæœ‰${eligible.length}äººï¼Œä¸è¶³${count}äºº`); return; }
    this.isLotteryRunning = true;
    this.flashIntervals = [];
    const getEl = (posKey) => {
      if (isFree) {
        // posKey may contain commas, can't use CSS selector directly
        return Array.from(document.querySelectorAll('.free-seat')).find(e => e.dataset.posKey === posKey) || null;
      }
      return document.querySelector(`[data-position="${posKey}"]`);
    };
    eligible.forEach(({posKey}) => {
      const el = getEl(posKey);
      if (!el) return;
      const iv = setInterval(()=>el.classList.toggle('lottery-flash'), 200+Math.random()*300);
      this.flashIntervals.push(iv);
    });
    setTimeout(() => {
      this.flashIntervals.forEach(iv=>clearInterval(iv));
      this.flashIntervals=[];
      eligible.forEach(({posKey}) => {
        const el = getEl(posKey);
        if (el) el.classList.remove('lottery-flash');
      });
      const winners = [...eligible].sort(()=>Math.random()-0.5).slice(0,count);
      this.selectedStudents = winners;
      winners.forEach(({posKey})=>{
        const el = getEl(posKey);
        if(el) el.classList.add('lottery-selected');
      });
      this._showLotteryResult(winners);
      const names = winners.map(w=>w.st.name);
      this._speak(winners.length===1?`æ­å–œ${winners[0].st.name}`:`æ­å–œ${names.join('ã€')}`);
      document.getElementById('clearSelBtn').style.display='';
      this.isLotteryRunning = false;
    }, 3000);
  }

  _showLotteryResult(winners) {
    const title = document.getElementById('lotteryResultTitle');
    const list  = document.getElementById('lotteryResultList');
    title.textContent = winners.length===1 ? 'ğŸ‰ æŠ½ä¸­äº†ï¼' : `ğŸ‰ æŠ½ä¸­ ${winners.length} ä½åŒå­¸ï¼`;
    list.innerHTML = winners.map(w => `
      <div style="background:${w.st.gender==='male'?'linear-gradient(135deg,#dbeafe,#bfdbfe)':'linear-gradient(135deg,#fee2e2,#fecaca)'};border:2px solid ${w.st.gender==='male'?'#93c5fd':'#fca5a5'};border-radius:14px;padding:14px 24px;min-width:110px;box-shadow:0 4px 14px rgba(0,0,0,0.12);">
        <div style="font-size:2rem;font-weight:800;color:${w.st.gender==='male'?'#1e40af':'#991b1b'};">${w.st.seatNumber}</div>
        <div style="font-size:1.1rem;font-weight:700;color:${w.st.gender==='male'?'#1e3a8a':'#7f1d1d'};">${w.st.name}</div>
      </div>`).join('');
    this._showModal('lotteryResultModal');
  }

  _clearSel() {
    this.flashIntervals.forEach(iv=>clearInterval(iv)); this.flashIntervals=[];
    document.querySelectorAll('.lottery-selected,.lottery-flash').forEach(el=>{
      el.classList.remove('lottery-selected','lottery-flash');
    });
    this.selectedStudents=[];
    document.getElementById('clearSelBtn').style.display='none';
  }

  _speak(text) {
    if (!window.speechSynthesis) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang='zh-TW'; u.rate=0.9; u.pitch=1.1;
    const v = speechSynthesis.getVoices().find(v=>v.name.includes('Google')&&v.lang.includes('zh'));
    if(v) u.voice=v;
    speechSynthesis.speak(u);
  }

  // â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _startTimer() {
    const h=parseInt(document.getElementById('timerH').value)||0;
    const m=parseInt(document.getElementById('timerM').value)||0;
    const s=parseInt(document.getElementById('timerS').value)||0;
    const total=h*3600+m*60+s;
    if(!total){alert('è«‹è¨­å®šæœ‰æ•ˆæ™‚é–“');return;}
    this.timerRemaining=total; this.timerPaused=false;
    this._hideModal('timerModal');
    const disp=document.getElementById('timerDisplay');
    const pauseBtn=document.getElementById('pauseTimerBtn');
    const stopBtn=document.getElementById('stopTimerBtn');
    disp.style.display=''; pauseBtn.style.display=''; stopBtn.style.display='';
    const upd=()=>{
      const h2=Math.floor(this.timerRemaining/3600);
      const m2=Math.floor((this.timerRemaining%3600)/60);
      const s2=this.timerRemaining%60;
      disp.textContent=h2>0
        ?`${String(h2).padStart(2,'0')}:${String(m2).padStart(2,'0')}:${String(s2).padStart(2,'0')}`
        :`${String(m2).padStart(2,'0')}:${String(s2).padStart(2,'0')}`;
      disp.className='timer-display'+(this.timerRemaining<=10&&this.timerRemaining>0?' urgent':'');
    };
    upd();
    this.timerInterval=setInterval(()=>{
      if(!this.timerPaused){
        this.timerRemaining--;upd();
        if(this.timerRemaining<=0){
          clearInterval(this.timerInterval);
          disp.style.display='none'; pauseBtn.style.display='none'; stopBtn.style.display='none';
          this._playAlarm();
          // èªéŸ³æ’­å ±ä¸‰æ¬¡
          const sayTime = (i) => setTimeout(() => this._speak('æ™‚é–“åˆ°å›‰'), i * 1800);
          sayTime(0); sayTime(1); sayTime(2);
          this._showModal('timeUpModal');
        }
      }
    },1000);
  }

  _playAlarm() {
    try {
      const ctx=new(window.AudioContext||window.webkitAudioContext)();
      for(let i=0;i<3;i++){
        setTimeout(()=>{
          const osc=ctx.createOscillator(),gain=ctx.createGain();
          osc.connect(gain);gain.connect(ctx.destination);
          osc.frequency.setValueAtTime(880,ctx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(440,ctx.currentTime+0.3);
          gain.gain.setValueAtTime(0.3,ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.5);
          osc.start();osc.stop(ctx.currentTime+0.5);
        },i*600);
      }
    }catch(e){}
  }

  // â”€â”€ Edit Student â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _openEditStudent(sid, defaultSeat=null) {
    this.editingStudentId = sid;
    const st = sid ? this._students[sid] : null;
    document.getElementById('editStudentTitle').textContent = st?'ç·¨è¼¯å­¸ç”Ÿ':'æ–°å¢å­¸ç”Ÿ';
    document.getElementById('editSeatNum').value = st ? st.seatNumber : (defaultSeat||'');
    document.getElementById('editName').value = st ? st.name : '';
    document.getElementById('editGender').value = st ? st.gender : 'male';
    document.getElementById('deleteStudentBtn').style.display = st?'':'none';
    this._showModal('editStudentModal');
  }

  _saveStudent() {
    const sn=parseInt(document.getElementById('editSeatNum').value);
    const name=document.getElementById('editName').value.trim();
    const gender=document.getElementById('editGender').value;
    if(!name){alert('è«‹è¼¸å…¥å§“å');return;}
    const cls=this.data.classes[this.currentClassId];
    if(!cls.students)cls.students={};
    if(this.editingStudentId){
      const st=cls.students[this.editingStudentId];
      if(st){st.seatNumber=sn;st.name=name;st.gender=gender;}
    } else {
      const id=`s${Date.now()}`;
      cls.students[id]={id,seatNumber:sn,name,gender};
    }
    this._scheduleSave();this._renderAll();this._hideModal('editStudentModal');
  }

  _deleteStudent() {
    if(!this.editingStudentId||!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ'))return;
    const cls=this.data.classes[this.currentClassId];
    const sid=this.editingStudentId;
    delete cls.students[sid];
    ['normalSeats','groupSeats','examSeats','freeSeats'].forEach(k=>{
      const s=cls[k]||{};
      Object.keys(s).forEach(p=>{if(s[p]===sid)delete s[p];});
    });
    delete (cls.scores||{})[sid];
    delete (cls.scoreHistory||{})[sid];
    if(this.data.homeworkNotes)delete this.data.homeworkNotes[sid];
    this._scheduleSave();this._renderAll();this._hideModal('editStudentModal');
  }

  // â”€â”€ Bulk edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _showBulkEdit() {
    const c=document.getElementById('bulkEditList');c.innerHTML='';
    for(let i=1;i<=40;i++){
      const st=Object.values(this._students).find(s=>s.seatNumber===i);
      const chip=document.createElement('div');
      chip.style.cssText='aspect-ratio:1;background:white;border:1.5px solid #e2e8f0;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;padding:5px;font-size:0.65rem;text-align:center;transition:all 0.15s;';
      if(st){
        chip.innerHTML=`<div style="font-weight:700;color:#3b82f6;">${i}</div><div style="color:#374151;">${st.name.slice(0,3)}</div>`;
        chip.addEventListener('mouseenter',()=>chip.style.borderColor='#93c5fd');
        chip.addEventListener('mouseleave',()=>chip.style.borderColor='#e2e8f0');
        chip.onclick=()=>{this._hideModal('bulkEditModal');this._openEditStudent(st.id);};
      } else {
        chip.innerHTML=`<div style="color:#94a3b8;">${i}</div><div style="color:#94a3b8;font-size:0.55rem;">ç©º</div>`;
        chip.style.borderStyle='dashed';
        chip.onclick=()=>{this._hideModal('bulkEditModal');this._openEditStudent(null,i);};
      }
      c.appendChild(chip);
    }
    this._showModal('bulkEditModal');
  }

  // â”€â”€ Scores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _showScores() {
    const sorted=Object.values(this._students)
      .map(st=>({...st,score:this._scores[st.id]||0}))
      .sort((a,b)=>b.score-a.score);
    const list=document.getElementById('scoresList');list.innerHTML='';
    sorted.forEach((st,i)=>{
      const row=document.createElement('div');row.className='score-row';
      row.innerHTML=`
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="rank-badge ${i<3?'rank-'+(i+1):''}">${i+1}</div>
          <span style="font-size:0.875rem;">${st.seatNumber}è™Ÿ ${st.name}</span>
        </div>
        <span style="font-weight:700;color:#3b82f6;font-size:0.95rem;">${st.score} åˆ†</span>
      `;
      list.appendChild(row);
    });
    this._showModal('scoresModal');
  }

  _showGroupScores() {
    const gs=this._cls.groupScores||{};
    const groups=Array.from({length:6},(_,i)=>({g:i+1,score:gs[i+1]||0})).sort((a,b)=>b.score-a.score);
    const list=document.getElementById('groupScoresList');list.innerHTML='';
    groups.forEach((g,i)=>{
      const row=document.createElement('div');row.className='score-row';
      row.innerHTML=`
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="rank-badge ${i<3?'rank-'+(i+1):''}">${i+1}</div>
          <span style="font-size:0.875rem;">ç¬¬${g.g}çµ„</span>
        </div>
        <span style="font-weight:700;color:#10b981;font-size:0.95rem;">${g.score} åˆ†</span>
      `;
      list.appendChild(row);
    });
    this._showModal('groupScoresModal');
  }

  // â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _showHistory(sid) {
    const st=this._students[sid];if(!st)return;
    const history=(this._cls.scoreHistory||{})[sid]||[];
    document.getElementById('historyTitle').textContent=`${st.seatNumber}è™Ÿ ${st.name} çš„ç©åˆ†è¨˜éŒ„`;
    const list=document.getElementById('historyList');list.innerHTML='';
    if(!history.length){list.innerHTML='<div style="color:#94a3b8;text-align:center;padding:1rem;">æš«ç„¡è¨˜éŒ„</div>';return;}
    [...history].reverse().forEach(r=>{
      const d=document.createElement('div');
      d.className=`history-entry ${r.change>0?'pos':'neg'}`;
      d.innerHTML=`
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
          <span style="font-size:0.72rem;color:#94a3b8;">${r.date}</span>
          <span style="font-weight:700;color:${r.change>0?'#10b981':'#ef4444'};">${r.change>0?'+':''}${r.change}åˆ†</span>
        </div>
        <div style="font-size:0.82rem;">${r.reason}</div>
        <div style="font-size:0.72rem;color:#94a3b8;margin-top:2px;">ç´¯ç©ï¼š${r.total}åˆ†</div>
      `;
      list.appendChild(d);
    });
    this._showModal('historyModal');
  }

  // â”€â”€ Homework â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _showHomework() {
    const sid=this.currentSettingsSid;
    const st=this._students[sid];if(!st)return;
    document.getElementById('homeworkTitle').textContent=`ä½œæ¥­ç®¡ç† - ${st.name}`;
    document.getElementById('newHwInput').value='';
    this._renderHwList();
    this._showModal('homeworkModal');
  }

  _renderHwList() {
    const sid=this.currentSettingsSid;
    const list=(this._hw[sid]||[]);
    const c=document.getElementById('homeworkList');c.innerHTML='';
    if(!list.length){c.innerHTML='<div style="color:#94a3b8;font-size:0.82rem;">ç›®å‰æ²’æœ‰æœªäº¤ä½œæ¥­ âœ“</div>';return;}
    list.forEach((hw,i)=>{
      const d=document.createElement('div');d.className='hw-item';
      d.innerHTML=`<span>â­ ${hw.name} <span style="color:#94a3b8;font-size:0.7rem;">${hw.date}</span></span>`;
      const btn=document.createElement('button');
      btn.className='btn btn-green btn-sm';btn.textContent='å·²äº¤';
      btn.onclick=()=>{
        list.splice(i,1);
        if(!list.length)delete this.data.homeworkNotes[sid];
        this._renderHwList();
      };
      d.appendChild(btn);c.appendChild(d);
    });
  }

  // â”€â”€ Random Seating â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _randomSeating() {
    if(!confirm('ç¢ºå®šéš¨æ©Ÿå®‰æ’åº§ä½ï¼Ÿ'))return;
    const posCount = {normal:30,group:30,exam:36,free:0,scilab:30,computer:30};
    const maxPos = posCount[this.currentMode] || 30;
    if(maxPos===0){alert('è‡ªç”±åº§ä½è«‹ç›´æ¥æ‹–æ›³å®‰æ’');return;}
    const positions=Array.from({length:maxPos},(_,i)=>i).sort(()=>Math.random()-0.5);
    const students=Object.values(this._students).sort(()=>Math.random()-0.5);
    const seats={};
    students.forEach((st,i)=>{if(i<positions.length)seats[positions[i]]=st.id;});
    this._setSeats(seats);this._scheduleSave();this._renderSeats();
  }

  _syncSizePresets() {
    const presets=[72,88,100,120,148];
    document.querySelectorAll('.size-preset-btn').forEach((btn,i)=>{
      btn.classList.toggle('active', Math.abs(parseInt(btn.dataset.sz)-this.seatSize)<8);
    });
  }

  // â”€â”€ Bulk Tab Switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _switchBulkTab(tab) {
    const grid = document.getElementById('bulkGridView');
    const imp  = document.getElementById('bulkImportView');
    const btnG = document.getElementById('switchGrid');
    const btnI = document.getElementById('switchImport');
    if (tab === 'grid') {
      grid.style.display = ''; imp.style.display = 'none';
      btnG.classList.add('active'); btnI.classList.remove('active');
    } else {
      grid.style.display = 'none'; imp.style.display = '';
      btnI.classList.add('active'); btnG.classList.remove('active');
      document.getElementById('importText').value = '';
    }
  }

  _confirmImport() {
    const raw = document.getElementById('importText').value.trim();
    if (!raw) { alert('è«‹è¼¸å…¥å­¸ç”Ÿè³‡æ–™'); return; }
    const overwrite = document.getElementById('importOverwrite').checked;
    const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const parsed = [];
    const errors = [];
    lines.forEach((line, i) => {
      const parts = line.trim().split(/\s+/);
      const sn = parseInt(parts[0]);
      if (isNaN(sn) || sn < 1 || sn > 99) { errors.push(`ç¬¬${i+1}è¡Œï¼šåº§è™Ÿç„¡æ•ˆ`); return; }
      const name = parts[1];
      if (!name) { errors.push(`ç¬¬${i+1}è¡Œï¼šç¼ºå°‘å§“å`); return; }
      // é è¨­ï¼šåº§è™Ÿ21-40ç‚ºå¥³ç”Ÿï¼Œå…¶ä»–ç‚ºç”·ç”Ÿï¼›å¯ç”¨ m/f æ‰‹å‹•è¦†è“‹
      let gender = (sn >= 21 && sn <= 40) ? 'female' : 'male';
      if (parts[2]) {
        const g = parts[2].toLowerCase();
        if (g === 'f' || g === 'å¥³' || g === 'female') gender = 'female';
        else if (g === 'm' || g === 'ç”·' || g === 'male') gender = 'male';
      }
      parsed.push({ seatNumber: sn, name, gender });
    });
    if (errors.length) { alert('éŒ¯èª¤ï¼š\n' + errors.join('\n')); return; }
    if (!confirm(`ç¢ºå®šåŒ¯å…¥ ${parsed.length} åå­¸ç”Ÿï¼Ÿ`)) return;
    const cls = this.data.classes[this.currentClassId];
    if (!cls.students) cls.students = {};
    if (overwrite) {
      Object.keys(cls.students).forEach(k => {
        if (parsed.some(p => p.seatNumber === cls.students[k].seatNumber)) delete cls.students[k];
      });
    }
    parsed.forEach(p => {
      const id = `s${Date.now()}${p.seatNumber}`;
      cls.students[id] = { id, seatNumber: p.seatNumber, name: p.name, gender: p.gender };
    });
    this._scheduleSave();
    this._renderAll();
    this._hideModal('bulkEditModal');
    alert(`æˆåŠŸåŒ¯å…¥ ${parsed.length} åå­¸ç”Ÿï¼`);
  }


  // â”€â”€ Export CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _exportCSV() {
    const rows=[['åº§è™Ÿ','å§“å','æ€§åˆ¥','ç©åˆ†']];
    Object.values(this._students).sort((a,b)=>a.seatNumber-b.seatNumber).forEach(st=>{
      rows.push([st.seatNumber,st.name,st.gender==='male'?'ç”·':'å¥³',this._scores[st.id]||0]);
    });
    const csv='\uFEFF'+rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
    a.download=`${this._cls.name||'ç­ç´š'}_${new Date().toLocaleDateString('zh-TW').replace(/\//g,'')}.csv`;
    a.click();
  }

  // â”€â”€ Modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _showModal(id){document.getElementById(id).classList.add('show');}
  _hideModal(id){document.getElementById(id).classList.remove('show');}

  // â”€â”€ Event Binding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _bindEvents() {
    // Google Login
    document.getElementById('googleLoginBtn')?.addEventListener('click',async()=>{
      try{
        const p=new window._GoogleAuthProvider();
        await window._signInWithPopup(window._auth,p);
      }catch(e){alert('ç™»å…¥å¤±æ•—ï¼š'+e.message);}
    });

    // Sign out
    document.getElementById('signoutBtn')?.addEventListener('click',async()=>{
      if(confirm('ç¢ºå®šç™»å‡ºï¼Ÿ'))await window._signOut(window._auth);
    });

    // Sort Classes
    document.getElementById('sortClassBtn')?.addEventListener('click',()=>this._sortClassesByName());

    // Add Class
    document.getElementById('addClassBtn')?.addEventListener('click',()=>{
      if(Object.keys(this.data?.classes||{}).length>=30){alert('æœ€å¤šå¯å»ºç«‹30å€‹ç­ç´š');return;}
      document.getElementById('newClassName').value='';
      this._showModal('addClassModal');
    });
    document.getElementById('confirmAddClass')?.addEventListener('click',()=>{
      const name=document.getElementById('newClassName').value.trim();
      if(!name){alert('è«‹è¼¸å…¥ç­ç´šåç¨±');return;}
      const id=`class${Date.now()}`;
      this.data.classes[id]=this._newClass(name);
      if(!this.data.classOrder)this.data.classOrder=[];
      this.data.classOrder.push(id);
      this.currentClassId=id;
      document.getElementById('newClassName').value='';
      this._hideModal('addClassModal');
      this._renderTabs();this._renderAll();this._scheduleSave();
    });
    document.getElementById('cancelAddClass')?.addEventListener('click',()=>this._hideModal('addClassModal'));

    // Rename Class
    document.getElementById('confirmRename')?.addEventListener('click',()=>{
      const name=document.getElementById('renameClassInput').value.trim();
      if(!name){alert('è«‹è¼¸å…¥åç¨±');return;}
      this.data.classes[this.renamingClassId].name=name;
      this._renderTabs();this._scheduleSave();this._hideModal('renameClassModal');
    });
    document.getElementById('deleteClassBtn')?.addEventListener('click',()=>{
      if(Object.keys(this.data.classes).length<=1){alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç­ç´š');return;}
      if(!confirm('ç¢ºå®šåˆªé™¤é€™å€‹ç­ç´šï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æ¶ˆå¤±ï¼'))return;
      delete this.data.classes[this.renamingClassId];
      if(this.data.classOrder){
        this.data.classOrder=this.data.classOrder.filter(i=>i!==this.renamingClassId);
      }
      this.currentClassId=this.data.classOrder?.[0]||Object.keys(this.data.classes)[0]||null;
      this._renderTabs();this._renderAll();this._scheduleSave();this._hideModal('renameClassModal');
    });
    document.getElementById('cancelRename')?.addEventListener('click',()=>this._hideModal('renameClassModal'));

    // Mode buttons
    const modeMap={modeNormal:'normal',modeGroup:'group',modeExam:'exam',modeFree:'free',modeSciLab:'scilab',modeComputer:'computer'};
    const modeLabels={normal:'ä¸€èˆ¬åº§ä½æ¨¡å¼',group:'å°çµ„åº§ä½æ¨¡å¼',exam:'è€ƒè©¦åº§ä½æ¨¡å¼',free:'è‡ªç”±åº§ä½æ¨¡å¼',scilab:'è‡ªç„¶æ•™å®¤æ¨¡å¼',computer:'é›»è…¦æ•™å®¤æ¨¡å¼'};
    Object.entries(modeMap).forEach(([btnId,mode])=>{
      document.getElementById(btnId)?.addEventListener('click',()=>{
        this.currentMode=mode;
        Object.keys(modeMap).forEach(b=>{
          const el=document.getElementById(b);
          if(el)el.className=b===btnId?'btn btn-primary active':'btn btn-outline';
        });
        document.getElementById('modeLabel').textContent=modeLabels[mode];
        this._renderSeats();
      });
    });

    // Student view
    document.getElementById('studentViewBtn')?.addEventListener('click',()=>{
      this.isStudentView=!this.isStudentView;
      const btn=document.getElementById('studentViewBtn');
      btn.textContent=this.isStudentView?'ğŸ“ è€å¸«è¦–è§’':'ğŸ‘¤ å­¸ç”Ÿè¦–è§’';
      btn.className=this.isStudentView?'btn btn-view-active':'btn btn-view';
      const ind=document.getElementById('viewIndicator');
      if(ind){
        ind.textContent=this.isStudentView?'ğŸ‘¤ å­¸ç”Ÿè¦–è§’':'ğŸ“ è€å¸«è¦–è§’';
        ind.style.background=this.isStudentView?'#ede9fe':'#fef3c7';
        ind.style.color=this.isStudentView?'#5b21b6':'#92400e';
        ind.style.borderColor=this.isStudentView?'#c4b5fd':'#fde68a';
      }
      this._renderSeats();
    });

    // Scores
    document.getElementById('showScoresBtn')?.addEventListener('click',()=>this._showScores());
    document.getElementById('closeScoresBtn')?.addEventListener('click',()=>this._hideModal('scoresModal'));
    document.getElementById('resetAllScoresBtn')?.addEventListener('click',()=>{
      if(!confirm('ç¢ºå®šé‡ç½®å…¨éƒ¨ç©åˆ†ï¼Ÿ'))return;
      const cls=this.data.classes[this.currentClassId];
      cls.scores={};cls.scoreHistory={};
      this._scheduleSave();this._hideModal('scoresModal');
    });

    // Group Scores
    document.getElementById('showGroupScoresBtn')?.addEventListener('click',()=>this._showGroupScores());
    document.getElementById('closeGroupScoresBtn')?.addEventListener('click',()=>this._hideModal('groupScoresModal'));
    document.getElementById('resetGroupScoresBtn')?.addEventListener('click',()=>{
      if(!confirm('ç¢ºå®šé‡ç½®å°çµ„ç©åˆ†ï¼Ÿ'))return;
      const cls=this.data.classes[this.currentClassId];
      cls.groupScores={};cls.groupScoreHistory={};
      this._scheduleSave();this._hideModal('groupScoresModal');
    });

    // Group score modal
    document.getElementById('addGroupBtn')?.addEventListener('click',()=>this._adjustGroupScore(1));
    document.getElementById('subGroupBtn')?.addEventListener('click',()=>this._adjustGroupScore(-1));
    document.getElementById('cancelGroupScore')?.addEventListener('click',()=>this._hideModal('groupScoreModal'));
    document.getElementById('confirmGroupScore')?.addEventListener('click',()=>{}); // handled by add/sub
    document.querySelectorAll('.group-reason').forEach(btn=>{
      btn.addEventListener('click',()=>{document.getElementById('groupReason').value=btn.dataset.r;});
    });

    // Lottery
    document.getElementById('lotteryAllBtn')?.addEventListener('click',()=>this._startLottery('all'));
    document.getElementById('lotteryBoysBtn')?.addEventListener('click',()=>this._startLottery('male'));
    document.getElementById('lotteryGirlsBtn')?.addEventListener('click',()=>this._startLottery('female'));
    document.getElementById('clearSelBtn')?.addEventListener('click',()=>this._clearSel());
    document.getElementById('closeLotteryResult')?.addEventListener('click',()=>this._hideModal('lotteryResultModal'));

    // Timer
    document.getElementById('timerBtn')?.addEventListener('click',()=>this._showModal('timerModal'));
    document.getElementById('startTimerBtn')?.addEventListener('click',()=>this._startTimer());
    document.getElementById('cancelTimerBtn')?.addEventListener('click',()=>this._hideModal('timerModal'));
    document.getElementById('pauseTimerBtn')?.addEventListener('click',()=>{
      this.timerPaused=!this.timerPaused;
      document.getElementById('pauseTimerBtn').textContent=this.timerPaused?'ç¹¼çºŒ':'æš«åœ';
    });
    document.getElementById('stopTimerBtn')?.addEventListener('click',()=>{
      if(!confirm('ç¢ºå®šåœæ­¢è¨ˆæ™‚å™¨ï¼Ÿ'))return;
      clearInterval(this.timerInterval);this.timerInterval=null;this.timerPaused=false;
      document.getElementById('timerDisplay').style.display='none';
      document.getElementById('pauseTimerBtn').style.display='none';
      document.getElementById('stopTimerBtn').style.display='none';
    });
    document.querySelectorAll('.quick-time').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const m=parseInt(btn.dataset.m);
        document.getElementById('timerH').value=Math.floor(m/60);
        document.getElementById('timerM').value=m%60;
        document.getElementById('timerS').value=0;
      });
    });
    document.getElementById('closeTimeUpBtn')?.addEventListener('click',()=>this._hideModal('timeUpModal'));

    // Student settings
    document.getElementById('settingsAddBtn')?.addEventListener('click',()=>this._adjustScore(1));
    document.getElementById('settingsSubBtn')?.addEventListener('click',()=>this._adjustScore(-1));
    // settingsConfirmBtn removed - add/sub buttons handle directly
    document.querySelectorAll('.settings-qs').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.getElementById('settingsAmt').value=btn.dataset.s;
        document.querySelectorAll('.settings-qs').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
    document.querySelectorAll('.settings-reason').forEach(btn=>{
      btn.addEventListener('click',()=>{document.getElementById('settingsReason').value=btn.dataset.r;});
    });
    document.getElementById('settingsHistoryBtn')?.addEventListener('click',()=>{
      const sid=this.currentSettingsSid;
      // ä¸é—œ settingsModalï¼Œç›´æ¥ç–ŠåŠ é¡¯ç¤º historyModal
      this._showHistory(sid);
    });
    document.getElementById('settingsEditBtn')?.addEventListener('click',()=>{
      const sid=this.currentSettingsSid;
      this._hideModal('studentSettingsModal');
      this._openEditStudent(sid);
    });
    document.getElementById('settingsHomeworkBtn')?.addEventListener('click',()=>this._showHomework());
    document.getElementById('closeSettingsBtn')?.addEventListener('click',()=>this._hideModal('studentSettingsModal'));

    // Edit Student
    document.getElementById('editStudentsBtn')?.addEventListener('click',()=>this._showBulkEdit());
    document.getElementById('saveStudentBtn')?.addEventListener('click',()=>this._saveStudent());
    document.getElementById('deleteStudentBtn')?.addEventListener('click',()=>this._deleteStudent());
    document.getElementById('cancelEditStudent')?.addEventListener('click',()=>{
      this._hideModal('editStudentModal');
      if(this.currentSettingsSid) this._showModal('studentSettingsModal');
    });
    document.getElementById('closeBulkEdit')?.addEventListener('click',()=>this._hideModal('bulkEditModal'));

    // History - é—œé–‰å¾Œå›åˆ° studentSettings
    document.getElementById('closeHistoryBtn')?.addEventListener('click',()=>{
      this._hideModal('historyModal');
      if(this.currentSettingsSid) this._showModal('studentSettingsModal');
    });

    // Homework
    document.getElementById('addHwBtn')?.addEventListener('click',()=>{
      const name=document.getElementById('newHwInput').value.trim();
      if(!name){alert('è«‹è¼¸å…¥ä½œæ¥­åç¨±');return;}
      const sid=this.currentSettingsSid;
      if(!this.data.homeworkNotes)this.data.homeworkNotes={};
      if(!this.data.homeworkNotes[sid])this.data.homeworkNotes[sid]=[];
      if(this.data.homeworkNotes[sid].some(h=>h.name===name)){alert('å·²æœ‰ç›¸åŒä½œæ¥­');return;}
      this.data.homeworkNotes[sid].push({name,date:new Date().toLocaleDateString('zh-TW')});
      document.getElementById('newHwInput').value='';
      this._renderHwList();
    });
    document.getElementById('saveHwBtn')?.addEventListener('click',()=>{
      this._scheduleSave();this._renderAll();this._hideModal('homeworkModal');
      if(this.currentSettingsSid) this._showModal('studentSettingsModal');
    });
    document.getElementById('closeHwBtn')?.addEventListener('click',()=>{
      this._hideModal('homeworkModal');
      if(this.currentSettingsSid) this._showModal('studentSettingsModal');
    });

    // Random / Reset
    document.getElementById('randomBtn')?.addEventListener('click',()=>this._randomSeating());
    document.getElementById('resetBtn')?.addEventListener('click',()=>{
      if(!confirm('ç¢ºå®šé‡ç½®åº§ä½ï¼Ÿ'))return;
      this._setSeats({});this._scheduleSave();this._renderSeats();
    });

    // Import
    document.getElementById('confirmImportBtn')?.addEventListener('click',()=>this._confirmImport());

    // Export
    document.getElementById('exportBtn')?.addEventListener('click',()=>this._exportCSV());

    // Seat size slider + preset buttons
    document.getElementById('seatSizeSlider')?.addEventListener('input',e=>{
      this.seatSize=parseInt(e.target.value);
      this._syncSizePresets();
      this._renderSeats();
    });
    document.querySelectorAll('.size-preset-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const sz=parseInt(btn.dataset.sz);
        this.seatSize=sz;
        document.getElementById('seatSizeSlider').value=sz;
        this._syncSizePresets();
        this._renderSeats();
      });
    });

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay=>{
      overlay.addEventListener('click',e=>{
        if(e.target===overlay)overlay.classList.remove('show');
      });
    });
  }
}

const app = new ClassroomApp();
</script>
</body>
</html>
