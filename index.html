<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>æ•™å®¤åº§ä½å®‰æ’ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            box-sizing: border-box;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1024px) {
            .control-panel {
                flex-direction: column;
                gap: 1rem;
            }
            
            .control-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .student-list {
                width: 100% !important;
                max-height: 300px;
                overflow-y: auto;
            }
            
            .classroom-area {
                width: 100% !important;
                min-height: 500px;
            }
            
            .seat {
                width: 80px !important;
                height: 60px !important;
                font-size: 0.75rem !important;
            }
            
            .student-item {
                width: 60px !important;
                height: 48px !important;
                font-size: 0.7rem !important;
            }
        }
        
        @media (max-width: 768px) {
            .control-panel {
                padding: 1rem;
            }
            
            .control-buttons {
                gap: 0.5rem;
            }
            
            .control-buttons button {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .seat {
                width: 70px !important;
                height: 50px !important;
                font-size: 0.7rem !important;
            }
            
            .student-item {
                width: 50px !important;
                height: 40px !important;
                font-size: 0.65rem !important;
            }
            
            .seating-area {
                padding: 1rem !important;
            }
            
            .group-container {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .title {
                font-size: 1.5rem !important;
            }
            
            .control-buttons button {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .seat {
                width: 60px !important;
                height: 45px !important;
                font-size: 0.65rem !important;
            }
            
            .student-item {
                width: 45px !important;
                height: 36px !important;
                font-size: 0.6rem !important;
            }
            
            .group-container {
                grid-template-columns: 1fr !important;
            }
            
            .modal-content {
                margin: 1rem !important;
                max-height: 90vh;
                overflow-y: auto;
            }
        }
        
        /* å¹³æ¿æ©«å‘å„ªåŒ– */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .main-content {
                flex-direction: row;
            }
            
            .student-list {
                width: 25% !important;
                max-height: none;
            }
            
            .classroom-area {
                width: 75% !important;
            }
        }
        
        /* è‡ªå‹•ç¸®æ”¾å®¹å™¨ */
        .auto-scale-container {
            transform-origin: top left;
            transition: transform 0.3s ease;
        }
        
        /* ç¢ºä¿æ¨¡æ…‹æ¡†åœ¨å°è¢å¹•ä¸Šæ­£å¸¸é¡¯ç¤º */
        .modal-responsive {
            padding: 0.5rem;
        }
        
        .modal-responsive .modal-content {
            max-width: 95vw;
            max-height: 95vh;
            overflow-y: auto;
        }
        .dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .drop-zone {
            border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .seat {
            transition: all 0.3s ease;
        }
        .seat:hover {
            transform: scale(1.05);
        }
        .score-popup {
            animation: scoreUp 1s ease-out;
        }
        @keyframes scoreUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.2); opacity: 0; }
        }
        .lottery-flash {
            animation: lotteryFlash 0.3s ease-in-out infinite alternate;
        }
        @keyframes lotteryFlash {
            0% { background-color: #fbbf24; border-color: #f59e0b; }
            100% { background-color: #fb923c; border-color: #ea580c; }
        }
        .lottery-selected {
            background-color: rgba(239, 68, 68, 0.8) !important;
            border-color: #dc2626 !important;
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 h-full">
    <div class="w-full p-4 h-full flex flex-col">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">æ•™å®¤åº§ä½å®‰æ’ç³»çµ±</h1>
            <p class="text-gray-600">ç·¨è¼¯å­¸ç”Ÿè³‡æ–™ã€å®‰æ’åº§ä½ã€ç®¡ç†çå‹µç©åˆ†</p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="control-buttons flex flex-wrap gap-4 items-center justify-between">
                <!-- æ¨¡å¼é¸æ“‡ -->
                <div class="flex gap-2">
                    <button id="normalMode" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        ä¸€èˆ¬åº§ä½
                    </button>
                    <button id="groupMode" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        å°çµ„åº§ä½
                    </button>
                    <button id="examMode" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        è€ƒè©¦åº§ä½
                    </button>
                    <button id="freeMode" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        ç©ºç™½åº§ä½
                    </button>
                </div>
                
                <!-- åŠŸèƒ½æŒ‰éˆ• -->
                <div class="flex gap-2 items-center">
                    <button id="studentView" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                        å­¸ç”Ÿè¦–è§’
                    </button>
                    <button id="showScores" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        å€‹äººç©åˆ†æ’è¡Œæ¦œ
                    </button>
                    <button id="showGroupScores" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                        å°çµ„ç©åˆ†æ’è¡Œæ¦œ
                    </button>

                    
                    <!-- åˆ†éš”ç·š -->
                    <div class="h-8 w-px bg-gray-300 mx-2"></div>
                    
                    <!-- è¨ˆæ™‚å™¨åŠŸèƒ½å€å¡Š -->
                    <div class="flex items-center gap-2">
                        <button id="timerBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            è¨ˆæ™‚å™¨
                        </button>
                        <div id="timerDisplay" class="text-lg font-mono font-bold text-gray-700 min-w-20 text-center hidden">
                            00:00
                        </div>
                        <button id="pauseTimer" class="px-3 py-2 bg-orange-500 text-white rounded text-sm hover:bg-orange-600 transition-colors hidden">
                            æš«åœ
                        </button>
                        <button id="stopTimer" class="px-3 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors hidden">
                            åœæ­¢
                        </button>
                    </div>
                    
                    <!-- åˆ†éš”ç·š -->
                    <div class="h-8 w-px bg-gray-300 mx-2"></div>
                    
                    <!-- æŠ½ç±¤åŠŸèƒ½å€å¡Š -->
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600">æŠ½</span>
                        <input id="lotteryCount" type="number" min="1" max="10" value="1" class="w-12 px-2 py-1 border border-gray-300 rounded text-center text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm text-gray-600">äºº</span>
                    </div>
                    <button id="lotteryAll" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                        å…¨éƒ¨æŠ½ç±¤
                    </button>
                    <button id="lotteryBoys" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        ç”·ç”ŸæŠ½ç±¤
                    </button>
                    <button id="lotteryGirls" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors">
                        å¥³ç”ŸæŠ½ç±¤
                    </button>
                    <button id="clearSelection" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors hidden">
                        å–æ¶ˆæ¨™è¨˜
                    </button>
                    

                </div>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="main-content flex gap-6 w-full flex-1">
            <!-- å­¸ç”Ÿåå–® - 1/4å¯¬åº¦ -->
            <div class="student-list w-1/4 bg-white rounded-lg shadow-lg p-4 flex-shrink-0 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">å­¸ç”Ÿåå–®</h3>
                    <div class="flex gap-2">
                        <button id="exportStudents" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors">
                            åŒ¯å‡ºExcel
                        </button>
                        <button id="importStudents" class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600 transition-colors" title="åŒ¯å…¥Exceléœ€è¦ç”¨åŒ¯å‡ºExcelçš„æ ¼å¼æ‰èƒ½åŒ¯å…¥æˆåŠŸ">
                            åŒ¯å…¥Excel
                        </button>
                        <button id="editStudents" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors">
                            ç·¨è¼¯å­¸ç”Ÿ
                        </button>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mb-4">
                    ğŸ’¡ æç¤ºï¼šåŒ¯å…¥Exceléœ€è¦ç”¨åŒ¯å‡ºExcelçš„æ ¼å¼æ‰èƒ½åŒ¯å…¥æˆåŠŸ
                </div>
                <div id="studentList" class="flex-1 overflow-y-auto">
                    <!-- å­¸ç”Ÿåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥å…ƒç´  -->
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
            </div>

            <!-- æ•™å®¤åº§ä½å€åŸŸ - 3/4å¯¬åº¦ -->
            <div class="classroom-area flex-1 bg-white rounded-lg shadow-lg p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h3 class="text-lg font-semibold text-gray-800">æ•™å®¤åº§ä½åœ–</h3>
                        <button id="randomSeating" class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600 transition-colors">
                            éš¨æ©Ÿå…¥åº§
                        </button>
                        <button id="resetSeats" class="px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600 transition-colors">
                            é‡ç½®åº§ä½
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">
                        <span id="currentMode">ä¸€èˆ¬åº§ä½æ¨¡å¼</span>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mb-4">
                    ğŸ’¡ æç¤ºï¼šè«‹ç›´æ¥æŒ‰ä½å·¦é‚Šçš„å­¸ç”Ÿï¼Œç”¨æ‹–æ›³çš„æ–¹å¼æ‹‰å…¥åº§ä½ä¸­
                </div>
                
                <!-- è¬›å°ï¼ˆå­¸ç”Ÿè¦–è§’æ™‚åœ¨ä¸Šæ–¹ï¼‰ -->
                <div id="podiumTop" class="bg-gray-800 text-white text-center py-3 rounded-lg mb-6 hidden">
                    <span class="text-lg font-semibold">è¬›å°</span>
                </div>

                <!-- åº§ä½å€åŸŸ -->
                <div id="seatingArea" class="seating-area border-2 border-dashed border-gray-300 rounded-lg p-4 mb-6 flex-1">
                    <!-- åº§ä½å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <!-- è¬›å°ï¼ˆè€å¸«è¦–è§’æ™‚åœ¨ä¸‹æ–¹ï¼‰ -->
                <div id="podiumBottom" class="bg-gray-800 text-white text-center py-3 rounded-lg">
                    <span class="text-lg font-semibold">è¬›å°</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å­¸ç”Ÿæ¨¡æ…‹æ¡† -->
    <div id="editModal" class="modal-responsive fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">ç·¨è¼¯å­¸ç”Ÿè³‡æ–™</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åº§è™Ÿ</label>
                    <input id="editSeatNumber" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å§“å</label>
                    <input id="editStudentName" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                    <select id="editStudentGender" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="male">ç”·ç”Ÿ ğŸ”µ</option>
                        <option value="female">å¥³ç”Ÿ ğŸ”´</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button id="saveStudent" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ä¿å­˜
                    </button>
                    <button id="deleteStudent" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        åˆªé™¤
                    </button>
                    <button id="cancelEdit" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ æ¸›åˆ†æ¨¡æ…‹æ¡† -->
    <div id="scoreModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">èª¿æ•´ç©åˆ†</h3>
            <div class="text-center mb-4">
                <span id="scoreStudentName" class="text-xl font-bold text-gray-800"></span>
            </div>
            <div class="space-y-4">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">èª¿æ•´åˆ†æ•¸</label>
                        <div class="flex items-center gap-2 justify-center">
                            <input id="scoreAmount" type="number" min="1" max="10" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">åˆ†</span>
                        </div>
                        <div class="flex gap-1 justify-center mt-2">
                            <button type="button" class="quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="1">1åˆ†</button>
                            <button type="button" class="quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="2">2åˆ†</button>
                            <button type="button" class="quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="3">3åˆ†</button>
                            <button type="button" class="quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="5">5åˆ†</button>
                        </div>
                    </div>
                    <div class="flex gap-2 justify-center">
                        <button id="addScoreBtn" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 text-lg font-semibold">
                            <span id="addScoreText">+1</span> åŠ åˆ†
                        </button>
                        <button id="subtractScoreBtn" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 text-lg font-semibold">
                            <span id="subtractScoreText">-1</span> æ‰£åˆ†
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŸå› èªªæ˜</label>
                    <div class="mb-3">
                        <div class="text-xs text-gray-600 mb-2">å¿«é€Ÿé¸æ“‡ï¼š</div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors border border-green-300">
                                å›ç­”å•é¡Œ
                            </button>
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors border border-green-300">
                                å¹«è€å¸«å¿™
                            </button>
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors border border-red-300">
                                ä¸Šèª²èŠå¤©
                            </button>
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors border border-red-300">
                                ç½µé«’è©±
                            </button>
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors border border-red-300">
                                ä½œæ¥­æ²’å¯«
                            </button>
                        </div>
                    </div>
                    <textarea id="scoreReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="3" placeholder="è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button id="confirmScore" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ç¢ºèª
                    </button>
                    <button id="cancelScore" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç©åˆ†æŸ¥çœ‹æ¨¡æ…‹æ¡† -->
    <div id="scoresModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold mb-4">å€‹äººç©åˆ†æ’è¡Œæ¦œ</h3>
            <div id="scoresList" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- ç©åˆ†åˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
            <div class="mt-4 flex gap-2">
                <button id="resetScores" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    é‡ç½®æ‰€æœ‰ç©åˆ†
                </button>
                <button id="closeScores" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- ç©åˆ†æ­·å²æ¨¡æ…‹æ¡† -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold mb-4">ç©åˆ†æ­·å²è¨˜éŒ„</h3>
            <div class="text-center mb-4">
                <span id="historyStudentName" class="text-xl font-bold text-gray-800"></span>
                <span id="historyTotalScore" class="ml-2 text-lg text-blue-600 font-semibold"></span>
            </div>
            <div id="historyList" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- æ­·å²è¨˜éŒ„å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
            <div class="mt-4 flex gap-2">
                <button id="closeHistory" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- è¨ˆæ™‚å™¨è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="timerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">è¨­å®šå€’æ•¸è¨ˆæ™‚å™¨</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å°æ™‚</label>
                        <input id="timerHours" type="number" min="0" max="23" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†é˜</label>
                        <input id="timerMinutes" type="number" min="0" max="59" value="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç§’æ•¸</label>
                        <input id="timerSeconds" type="number" min="0" max="59" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¿«é€Ÿè¨­å®š</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" class="quick-time-btn px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors border border-blue-300" data-minutes="1">
                            1åˆ†é˜
                        </button>
                        <button type="button" class="quick-time-btn px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors border border-blue-300" data-minutes="5">
                            5åˆ†é˜
                        </button>
                        <button type="button" class="quick-time-btn px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors border border-blue-300" data-minutes="10">
                            10åˆ†é˜
                        </button>
                        <button type="button" class="quick-time-btn px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors border border-blue-300" data-minutes="15">
                            15åˆ†é˜
                        </button>
                        <button type="button" class="quick-time-btn px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors border border-blue-300" data-minutes="30">
                            30åˆ†é˜
                        </button>
                        <button type="button" class="quick-time-btn px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors border border-blue-300" data-minutes="45">
                            45åˆ†é˜
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="startTimer" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        é–‹å§‹è¨ˆæ™‚
                    </button>
                    <button id="cancelTimer" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™‚é–“åˆ°æé†’æ¨¡æ…‹æ¡† -->
    <div id="timeUpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-md mx-4 text-center animate-pulse">
            <div class="text-6xl mb-4">â°</div>
            <h3 class="text-2xl font-bold text-red-600 mb-4">æ™‚é–“åˆ°å›‰ï¼</h3>
            <div class="text-lg text-gray-700 mb-6">è¨ˆæ™‚å™¨å·²çµæŸ</div>
            <button id="closeTimeUp" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 text-lg font-semibold">
                ç¢ºèª
            </button>
        </div>
    </div>

    <!-- å°çµ„ç©åˆ†æ¨¡æ…‹æ¡† -->
    <div id="groupScoresModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold mb-4">å°çµ„ç©åˆ†æ’è¡Œæ¦œ</h3>
            <div id="groupScoresList" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- å°çµ„ç©åˆ†åˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
            <div class="mt-4 flex gap-2">
                <button id="resetGroupScores" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    é‡ç½®å°çµ„ç©åˆ†
                </button>
                <button id="closeGroupScores" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- å°çµ„ç©åˆ†èª¿æ•´æ¨¡æ…‹æ¡† -->
    <div id="groupScoreModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">èª¿æ•´å°çµ„ç©åˆ†</h3>
            <div class="text-center mb-4">
                <span id="groupScoreGroupName" class="text-xl font-bold text-gray-800"></span>
            </div>
            <div class="space-y-4">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">èª¿æ•´åˆ†æ•¸</label>
                        <div class="flex items-center gap-2 justify-center">
                            <input id="groupScoreAmount" type="number" min="1" max="10" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">åˆ†</span>
                        </div>
                        <div class="flex gap-1 justify-center mt-2">
                            <button type="button" class="group-quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="1">1åˆ†</button>
                            <button type="button" class="group-quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="2">2åˆ†</button>
                            <button type="button" class="group-quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="3">3åˆ†</button>
                            <button type="button" class="group-quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="5">5åˆ†</button>
                        </div>
                    </div>
                    <div class="flex gap-2 justify-center">
                        <button id="addGroupScoreBtn" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 text-lg font-semibold">
                            <span id="addGroupScoreText">+1</span> åŠ åˆ†
                        </button>
                        <button id="subtractGroupScoreBtn" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 text-lg font-semibold">
                            <span id="subtractGroupScoreText">-1</span> æ‰£åˆ†
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŸå› èªªæ˜</label>
                    <div class="mb-3">
                        <div class="text-xs text-gray-600 mb-2">å¿«é€Ÿé¸æ“‡ï¼š</div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button type="button" class="group-reason-btn px-3 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors border border-green-300">
                                è¨è«–ç©æ¥µ
                            </button>
                            <button type="button" class="group-reason-btn px-3 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors border border-green-300">
                                åˆä½œè‰¯å¥½
                            </button>
                            <button type="button" class="group-reason-btn px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors border border-red-300">
                                è¨è«–åµé¬§
                            </button>
                            <button type="button" class="group-reason-btn px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors border border-red-300">
                                ä¸åƒèˆ‡è¨è«–
                            </button>
                        </div>
                    </div>
                    <textarea id="groupScoreReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="3" placeholder="è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button id="confirmGroupScore" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ç¢ºèª
                    </button>
                    <button id="cancelGroupScore" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿè¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="studentSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">å­¸ç”Ÿè¨­å®š</h3>
            <div class="text-center mb-4">
                <span id="settingsStudentName" class="text-xl font-bold text-gray-800"></span>
                <span id="settingsStudentScore" class="ml-2 text-lg text-blue-600 font-semibold"></span>
            </div>
            
            <!-- åŠ æ¸›åˆ†å€åŸŸ -->
            <div class="mb-6">
                <h4 class="text-md font-semibold mb-3 text-gray-700">èª¿æ•´ç©åˆ†</h4>
                <div class="space-y-3 mb-3">
                    <div>
                        <div class="flex items-center gap-2 justify-center mb-2">
                            <input id="settingsScoreAmount" type="number" min="1" max="10" value="1" class="w-16 px-2 py-1 border border-gray-300 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600 text-sm">åˆ†</span>
                        </div>
                        <div class="flex gap-1 justify-center mb-3">
                            <button type="button" class="settings-quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="1">1åˆ†</button>
                            <button type="button" class="settings-quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="2">2åˆ†</button>
                            <button type="button" class="settings-quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="3">3åˆ†</button>
                            <button type="button" class="settings-quick-score-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors border border-blue-300" data-score="5">5åˆ†</button>
                        </div>
                    </div>
                    <div class="flex gap-2 justify-center">
                        <button id="settingsAddScore" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                            <span id="settingsAddScoreText">+1</span> åŠ åˆ†
                        </button>
                        <button id="settingsSubtractScore" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold">
                            <span id="settingsSubtractScoreText">-1</span> æ‰£åˆ†
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŸå› èªªæ˜</label>
                    <div class="mb-2">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button type="button" class="settings-reason-btn px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors border border-green-300">
                                å›ç­”å•é¡Œ
                            </button>
                            <button type="button" class="settings-reason-btn px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors border border-green-300">
                                å¹«è€å¸«å¿™
                            </button>
                            <button type="button" class="settings-reason-btn px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors border border-red-300">
                                ä¸Šèª²èŠå¤©
                            </button>
                            <button type="button" class="settings-reason-btn px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors border border-red-300">
                                ä½œæ¥­æ²’å¯«
                            </button>
                        </div>
                    </div>
                    <textarea id="settingsScoreReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="2" placeholder="è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ..."></textarea>
                </div>
            </div>
            
            <!-- åŠŸèƒ½æŒ‰éˆ• -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button id="settingsViewHistory" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                    æŸ¥çœ‹çæ‡²ç´€éŒ„
                </button>
                <button id="settingsEditStudent" class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm">
                    ç·¨è¼¯å­¸ç”Ÿè³‡æ–™
                </button>
                <button id="settingsManageHomework" class="px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm">
                    ä½œæ¥­ç®¡ç†
                </button>
            </div>
            
            <div class="flex gap-2">
                <button id="settingsConfirmScore" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    ç¢ºèªç©åˆ†èª¿æ•´
                </button>
                <button id="closeStudentSettings" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- ä½œæ¥­ç®¡ç†æ¨¡æ…‹æ¡† -->
    <div id="homeworkModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">ä½œæ¥­ç®¡ç†</h3>
            <div class="text-center mb-4">
                <span id="homeworkStudentName" class="text-xl font-bold text-gray-800"></span>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">æœªäº¤ä½œæ¥­æ¸…å–®</label>
                <div id="homeworkList" class="space-y-2 max-h-48 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
                    <!-- ä½œæ¥­æ¸…å–®å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">æ–°å¢æœªäº¤ä½œæ¥­</label>
                <div class="flex gap-2">
                    <input id="newHomeworkName" type="text" placeholder="ä½œæ¥­åç¨±ï¼ˆä¾‹å¦‚ï¼šæ•¸å­¸ç¿’ä½œp.25ï¼‰" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <button id="addHomework" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                        æ–°å¢
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button id="saveHomeworkNotes" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                    å„²å­˜
                </button>
                <button id="closeHomework" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">ç¢ºèªåŒ¯å…¥å­¸ç”Ÿè³‡æ–™</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">é è¦½åŒ¯å…¥çš„å­¸ç”Ÿè³‡æ–™ï¼š</p>
                <div id="importPreview" class="border border-gray-300 rounded-lg p-3 bg-gray-50 max-h-48 overflow-y-auto">
                    <!-- é è¦½å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="replaceAllStudents" class="mr-2">
                    <span class="text-sm">æ›¿æ›æ‰€æœ‰ç¾æœ‰å­¸ç”Ÿè³‡æ–™ï¼ˆä¸å‹¾é¸å‰‡ç‚ºæ–°å¢æ¨¡å¼ï¼‰</span>
                </label>
            </div>
            <div class="flex gap-2">
                <button id="confirmImport" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    ç¢ºèªåŒ¯å…¥
                </button>
                <button id="cancelImport" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        class ClassroomManager {
            constructor() {
                this.students = this.loadStudents();
                this.currentMode = 'normal'; // 'normal', 'group', 'exam', or 'free'
                this.normalSeats = this.loadSeats('normal');
                this.groupSeats = this.loadSeats('group');
                this.examSeats = this.loadSeats('exam');
                this.freeSeats = this.loadSeats('free');
                this.scores = this.loadScores();
                this.scoreHistory = this.loadScoreHistory();
                this.groupScores = this.loadGroupScores();
                this.groupScoreHistory = this.loadGroupScoreHistory();
                this.homeworkNotes = this.loadHomeworkNotes();
                this.editingStudent = null;
                this.currentScoreStudent = null;
                this.isStudentView = false;
                this.selectedScoreType = null;
                this.isLotteryRunning = false;
                this.selectedStudent = null;
                this.selectedStudents = [];
                
                // è¨ˆæ™‚å™¨ç›¸é—œè®Šæ•¸
                this.timerInterval = null;
                this.timerRemaining = 0;
                this.timerRunning = false;
                this.timerPaused = false;
                
                this.initializeEventListeners();
                this.renderStudentList();
                this.renderSeats();
                this.initializeResponsiveDesign();
            }

            loadStudents() {
                const saved = localStorage.getItem('classroom_students');
                if (saved) {
                    return JSON.parse(saved);
                }
                // é è¨­å­¸ç”Ÿè³‡æ–™
                const defaultStudents = [];
                
                // ç”·ç”Ÿ 1-15è™Ÿ
                for (let i = 1; i <= 15; i++) {
                    defaultStudents.push({
                        id: i,
                        seatNumber: i,
                        name: `å­¸ç”Ÿ${i}`,
                        gender: 'male'
                    });
                }
                
                // å¥³ç”Ÿ 21-35è™Ÿ
                for (let i = 21; i <= 35; i++) {
                    defaultStudents.push({
                        id: i,
                        seatNumber: i,
                        name: `å­¸ç”Ÿ${i}`,
                        gender: 'female'
                    });
                }
                
                // 16-20è™Ÿå’Œ36-40è™Ÿç•™ç©ºï¼Œä¸é è¨­å­¸ç”Ÿ
                
                return defaultStudents;
            }

            loadSeats(mode) {
                const saved = localStorage.getItem(`classroom_seats_${mode}`);
                return saved ? JSON.parse(saved) : {};
            }

            loadScores() {
                const saved = localStorage.getItem('classroom_scores');
                return saved ? JSON.parse(saved) : {};
            }

            loadScoreHistory() {
                const saved = localStorage.getItem('classroom_score_history');
                return saved ? JSON.parse(saved) : {};
            }

            loadGroupScores() {
                const saved = localStorage.getItem('classroom_group_scores');
                return saved ? JSON.parse(saved) : {};
            }

            loadGroupScoreHistory() {
                const saved = localStorage.getItem('classroom_group_score_history');
                return saved ? JSON.parse(saved) : {};
            }

            loadHomeworkNotes() {
                const saved = localStorage.getItem('classroom_homework_notes');
                return saved ? JSON.parse(saved) : {};
            }

            saveData() {
                localStorage.setItem('classroom_students', JSON.stringify(this.students));
                localStorage.setItem(`classroom_seats_${this.currentMode}`, JSON.stringify(this.getCurrentSeats()));
                localStorage.setItem('classroom_scores', JSON.stringify(this.scores));
                localStorage.setItem('classroom_score_history', JSON.stringify(this.scoreHistory));
                localStorage.setItem('classroom_group_scores', JSON.stringify(this.groupScores));
                localStorage.setItem('classroom_group_score_history', JSON.stringify(this.groupScoreHistory));
                localStorage.setItem('classroom_homework_notes', JSON.stringify(this.homeworkNotes));
            }

            getCurrentSeats() {
                if (this.currentMode === 'normal') return this.normalSeats;
                if (this.currentMode === 'group') return this.groupSeats;
                if (this.currentMode === 'exam') return this.examSeats;
                return this.freeSeats;
            }

            initializeEventListeners() {
                // æ¨¡å¼åˆ‡æ›
                document.getElementById('normalMode').addEventListener('click', () => this.switchMode('normal'));
                document.getElementById('groupMode').addEventListener('click', () => this.switchMode('group'));
                document.getElementById('examMode').addEventListener('click', () => this.switchMode('exam'));
                document.getElementById('freeMode').addEventListener('click', () => this.switchMode('free'));

                // æ§åˆ¶æŒ‰éˆ•
                document.getElementById('studentView').addEventListener('click', () => this.toggleStudentView());
                document.getElementById('editStudents').addEventListener('click', () => this.showEditModal());
                document.getElementById('exportStudents').addEventListener('click', () => this.exportStudentsToExcel());
                document.getElementById('importStudents').addEventListener('click', () => this.importStudentsFromExcel());
                document.getElementById('randomSeating').addEventListener('click', () => this.randomSeating());
                document.getElementById('resetSeats').addEventListener('click', () => this.resetSeats());
                document.getElementById('showScores').addEventListener('click', () => this.showScoresModal());
                document.getElementById('showGroupScores').addEventListener('click', () => this.showGroupScoresModal());

                // ç·¨è¼¯æ¨¡æ…‹æ¡†
                document.getElementById('saveStudent').addEventListener('click', () => this.saveStudent());
                document.getElementById('deleteStudent').addEventListener('click', () => this.deleteStudent());
                document.getElementById('cancelEdit').addEventListener('click', () => this.hideEditModal());

                // ç©åˆ†æ¨¡æ…‹æ¡†
                document.getElementById('resetScores').addEventListener('click', () => this.resetAllScores());
                document.getElementById('closeScores').addEventListener('click', () => this.hideScoresModal());

                // åŠ æ¸›åˆ†æ¨¡æ…‹æ¡†
                document.getElementById('addScoreBtn').addEventListener('click', () => this.selectScoreType(1));
                document.getElementById('subtractScoreBtn').addEventListener('click', () => this.selectScoreType(-1));
                document.getElementById('confirmScore').addEventListener('click', () => this.confirmScore());
                document.getElementById('cancelScore').addEventListener('click', () => this.hideScoreModal());

                // ç©åˆ†æ­·å²æ¨¡æ…‹æ¡†
                document.getElementById('closeHistory').addEventListener('click', () => this.hideHistoryModal());

                // å­¸ç”Ÿè¨­å®šæ¨¡æ…‹æ¡†
                document.getElementById('settingsAddScore').addEventListener('click', () => this.selectSettingsScoreType(1));
                document.getElementById('settingsSubtractScore').addEventListener('click', () => this.selectSettingsScoreType(-1));
                document.getElementById('settingsConfirmScore').addEventListener('click', () => this.confirmSettingsScore());
                document.getElementById('settingsViewHistory').addEventListener('click', () => this.viewHistoryFromSettings());
                document.getElementById('settingsEditStudent').addEventListener('click', () => this.editStudentFromSettings());
                document.getElementById('settingsManageHomework').addEventListener('click', () => this.showHomeworkModal());
                document.getElementById('closeStudentSettings').addEventListener('click', () => this.hideStudentSettingsModal());

                // è¨ˆæ™‚å™¨åŠŸèƒ½
                document.getElementById('timerBtn').addEventListener('click', () => this.showTimerModal());
                document.getElementById('startTimer').addEventListener('click', () => this.startCountdownTimer());
                document.getElementById('cancelTimer').addEventListener('click', () => this.hideTimerModal());
                document.getElementById('pauseTimer').addEventListener('click', () => this.pauseTimer());
                document.getElementById('stopTimer').addEventListener('click', () => this.stopTimer());

                // æŠ½ç±¤åŠŸèƒ½
                document.getElementById('lotteryAll').addEventListener('click', () => this.startLottery('all'));
                document.getElementById('lotteryBoys').addEventListener('click', () => this.startLottery('male'));
                document.getElementById('lotteryGirls').addEventListener('click', () => this.startLottery('female'));
                document.getElementById('clearSelection').addEventListener('click', () => this.clearSelection());

                // æ™‚é–“åˆ°æé†’
                document.getElementById('closeTimeUp').addEventListener('click', () => this.hideTimeUpModal());

                // å°çµ„ç©åˆ†åŠŸèƒ½
                document.getElementById('resetGroupScores').addEventListener('click', () => this.resetAllGroupScores());
                document.getElementById('closeGroupScores').addEventListener('click', () => this.hideGroupScoresModal());
                document.getElementById('addGroupScoreBtn').addEventListener('click', () => this.selectGroupScoreType(1));
                document.getElementById('subtractGroupScoreBtn').addEventListener('click', () => this.selectGroupScoreType(-1));
                document.getElementById('confirmGroupScore').addEventListener('click', () => this.confirmGroupScore());
                document.getElementById('cancelGroupScore').addEventListener('click', () => this.hideGroupScoreModal());

                // åŒ¯å…¥åŠŸèƒ½
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));
                document.getElementById('confirmImport').addEventListener('click', () => this.confirmImportStudents());
                document.getElementById('cancelImport').addEventListener('click', () => this.hideImportModal());

                // ä½œæ¥­ç®¡ç†åŠŸèƒ½
                document.getElementById('addHomework').addEventListener('click', () => this.addHomework());
                document.getElementById('saveHomeworkNotes').addEventListener('click', () => this.saveHomeworkNotes());
                document.getElementById('closeHomework').addEventListener('click', () => this.hideHomeworkModal());

                // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
                document.getElementById('editModal').addEventListener('click', (e) => {
                    if (e.target.id === 'editModal') this.hideEditModal();
                });
                document.getElementById('scoresModal').addEventListener('click', (e) => {
                    if (e.target.id === 'scoresModal') this.hideScoresModal();
                });
                document.getElementById('scoreModal').addEventListener('click', (e) => {
                    if (e.target.id === 'scoreModal') this.hideScoreModal();
                });
                document.getElementById('historyModal').addEventListener('click', (e) => {
                    if (e.target.id === 'historyModal') this.hideHistoryModal();
                });
                document.getElementById('studentSettingsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'studentSettingsModal') this.hideStudentSettingsModal();
                });
                document.getElementById('timerModal').addEventListener('click', (e) => {
                    if (e.target.id === 'timerModal') this.hideTimerModal();
                });
                document.getElementById('timeUpModal').addEventListener('click', (e) => {
                    if (e.target.id === 'timeUpModal') this.hideTimeUpModal();
                });
                document.getElementById('groupScoresModal').addEventListener('click', (e) => {
                    if (e.target.id === 'groupScoresModal') this.hideGroupScoresModal();
                });
                document.getElementById('groupScoreModal').addEventListener('click', (e) => {
                    if (e.target.id === 'groupScoreModal') this.hideGroupScoreModal();
                });
                document.getElementById('importModal').addEventListener('click', (e) => {
                    if (e.target.id === 'importModal') this.hideImportModal();
                });
                document.getElementById('homeworkModal').addEventListener('click', (e) => {
                    if (e.target.id === 'homeworkModal') this.hideHomeworkModal();
                });
            }

            toggleStudentView() {
                this.isStudentView = !this.isStudentView;
                
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼å’Œæ–‡å­—
                const button = document.getElementById('studentView');
                const podiumTop = document.getElementById('podiumTop');
                const podiumBottom = document.getElementById('podiumBottom');
                
                if (this.isStudentView) {
                    button.className = 'px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors';
                    button.textContent = 'è€å¸«è¦–è§’';
                    // å­¸ç”Ÿè¦–è§’ï¼šè¬›å°åœ¨ä¸Šæ–¹
                    podiumTop.classList.remove('hidden');
                    podiumBottom.classList.add('hidden');
                } else {
                    button.className = 'px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors';
                    button.textContent = 'å­¸ç”Ÿè¦–è§’';
                    // è€å¸«è¦–è§’ï¼šè¬›å°åœ¨ä¸‹æ–¹
                    podiumTop.classList.add('hidden');
                    podiumBottom.classList.remove('hidden');
                }
                
                this.renderSeats();
            }

            switchMode(mode) {
                this.saveData(); // ä¿å­˜ç•¶å‰æ¨¡å¼çš„åº§ä½
                this.currentMode = mode;
                
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼
                const activeClass = 'px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors';
                const inactiveClass = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors';
                
                document.getElementById('normalMode').className = mode === 'normal' ? activeClass : inactiveClass;
                document.getElementById('groupMode').className = mode === 'group' ? activeClass : inactiveClass;
                document.getElementById('examMode').className = mode === 'exam' ? activeClass : inactiveClass;
                document.getElementById('freeMode').className = mode === 'free' ? activeClass : inactiveClass;

                const modeNames = {
                    'normal': 'ä¸€èˆ¬åº§ä½æ¨¡å¼',
                    'group': 'å°çµ„åº§ä½æ¨¡å¼',
                    'exam': 'è€ƒè©¦åº§ä½æ¨¡å¼',
                    'free': 'ç©ºç™½åº§ä½æ¨¡å¼'
                };
                document.getElementById('currentMode').textContent = modeNames[mode];
                
                this.renderSeats();
            }

            renderStudentList() {
                const container = document.getElementById('studentList');
                container.innerHTML = '';

                // å‰µå»ºç¶²æ ¼å®¹å™¨ï¼Œæ¯è¡Œ5å€‹ï¼ŒåŠ ä¸Šé–“éš™
                container.className = 'grid grid-cols-5 gap-3';

                // é¡¯ç¤º1-40è™Ÿï¼Œä½†æŒ‰ç…§åŸæœ¬çš„æ’åˆ—æ–¹å¼
                const displayRanges = [
                    { start: 1, end: 40 }
                ];

                displayRanges.forEach(range => {
                    for (let i = range.start; i <= range.end; i++) {
                        const student = this.students.find(s => s.seatNumber === i);
                        const div = document.createElement('div');
                        
                        if (student) {
                            // æœ‰å­¸ç”Ÿçš„åº§ä½
                            div.className = 'w-16 h-12 lg:w-18 lg:h-14 border-2 border-gray-400 rounded-lg cursor-move hover:border-blue-400 transition-colors bg-gray-50 hover:bg-gray-100 flex flex-col items-center justify-center text-xs';
                            div.draggable = true;
                            div.dataset.studentId = student.id;
                            
                            const genderDot = student.gender === 'male' ? 
                                '<span class="inline-block w-2 h-2 bg-blue-500 rounded-full ml-1"></span>' : 
                                '<span class="inline-block w-2 h-2 bg-red-500 rounded-full ml-1"></span>';
                            const displayName = student.name.length > 3 ? student.name.substring(0, 3) : student.name;
                            
                            div.innerHTML = `
                                <div class="font-bold text-xs lg:text-sm flex items-center">${student.seatNumber}${genderDot}</div>
                                <div class="text-xs lg:text-sm">
                                    ${displayName}
                                </div>
                            `;
                            
                            // æ‹–æ‹½äº‹ä»¶
                            div.addEventListener('dragstart', (e) => {
                                e.dataTransfer.setData('text/plain', `student:${student.id}`);
                                div.classList.add('dragging');
                            });
                            
                            div.addEventListener('dragend', (e) => {
                                div.classList.remove('dragging');
                            });
                            
                            // é›™æ“Šäº‹ä»¶é–‹å•Ÿå­¸ç”Ÿè¨­å®š
                            div.addEventListener('dblclick', () => {
                                this.showStudentSettingsModal(student);
                            });
                            
                        } else {
                            // ç©ºåº§ä½
                            div.className = 'w-16 h-12 lg:w-18 lg:h-14 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors flex flex-col items-center justify-center text-xs text-gray-400';
                            div.innerHTML = `
                                <div class="font-bold">${i}</div>
                                <div class="text-xs">ç©º</div>
                            `;
                            
                            // é»æ“Šç©ºåº§ä½æ–°å¢å­¸ç”Ÿ
                            div.addEventListener('click', () => {
                                this.showEditModal(null, i);
                            });
                        }
                        
                        container.appendChild(div);
                    }
                });
            }

            renderSeats() {
                const container = document.getElementById('seatingArea');
                container.innerHTML = '';

                if (this.currentMode === 'normal') {
                    this.renderNormalSeats(container);
                } else if (this.currentMode === 'group') {
                    this.renderGroupSeats(container);
                } else if (this.currentMode === 'exam') {
                    this.renderExamSeats(container);
                } else {
                    this.renderFreeSeats(container);
                }
            }

            renderNormalSeats(container) {
                container.className = 'border-2 border-dashed border-gray-300 rounded-lg p-4 mb-6 flex-1 flex flex-col justify-center';
                container.innerHTML = '';
                
                const seats = this.getCurrentSeats();
                
                // æ±ºå®šæ’åˆ—é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚é¡›å€’ï¼‰
                const rows = this.isStudentView ? [4, 3, 2, 1, 0] : [0, 1, 2, 3, 4];
                
                // å‰µå»º5æ’åº§ä½ï¼Œæ¯æ’2-2-2çš„æ’åˆ—
                rows.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'flex justify-between items-center px-8 mb-4';
                    
                    // æ±ºå®šåº§ä½é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚å·¦å³ä¹Ÿé¡›å€’ï¼‰
                    const seatOrder = this.isStudentView ? [5, 4, 3, 2, 1, 0] : [0, 1, 2, 3, 4, 5];
                    
                    // å·¦é‚Š2å€‹åº§ä½
                    const leftGroup = document.createElement('div');
                    leftGroup.className = 'flex gap-4';
                    
                    for (let i = 0; i < 2; i++) {
                        const col = seatOrder[i];
                        const position = row * 6 + col;
                        const seatDiv = this.createSeatElement(position, seats);
                        leftGroup.appendChild(seatDiv);
                    }
                    
                    // ä¸­é–“2å€‹åº§ä½
                    const middleGroup = document.createElement('div');
                    middleGroup.className = 'flex gap-4';
                    
                    for (let i = 2; i < 4; i++) {
                        const col = seatOrder[i];
                        const position = row * 6 + col;
                        const seatDiv = this.createSeatElement(position, seats);
                        middleGroup.appendChild(seatDiv);
                    }
                    
                    // å³é‚Š2å€‹åº§ä½
                    const rightGroup = document.createElement('div');
                    rightGroup.className = 'flex gap-4';
                    
                    for (let i = 4; i < 6; i++) {
                        const col = seatOrder[i];
                        const position = row * 6 + col;
                        const seatDiv = this.createSeatElement(position, seats);
                        rightGroup.appendChild(seatDiv);
                    }
                    
                    rowDiv.appendChild(leftGroup);
                    rowDiv.appendChild(middleGroup);
                    rowDiv.appendChild(rightGroup);
                    container.appendChild(rowDiv);
                });
            }

            createSeatElement(position, seats) {
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat w-24 h-16 lg:w-32 lg:h-20 xl:w-40 xl:h-24 border-2 border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-blue-400 transition-colors text-xs lg:text-sm';
                seatDiv.dataset.position = position;

                const studentId = seats[position];
                if (studentId) {
                    const student = this.students.find(s => s.id === studentId);
                    if (student) {
                        let bgColor = 'bg-blue-100 border-blue-400';
                        if (this.currentMode === 'group') bgColor = 'bg-green-100 border-green-400';
                        if (this.currentMode === 'exam') bgColor = 'bg-red-100 border-red-400';
                        if (this.currentMode === 'free') bgColor = 'bg-purple-100 border-purple-400';
                        
                        seatDiv.className += ` ${bgColor}`;
                        
                        const genderDot = student.gender === 'male' ? 
                            '<span class="inline-block w-1.5 h-1.5 bg-blue-500 rounded-full ml-1"></span>' : 
                            '<span class="inline-block w-1.5 h-1.5 bg-red-500 rounded-full ml-1"></span>';
                        const displayName = student.name.length > 3 ? student.name.substring(0, 3) : student.name;
                        
                        // è¨ˆç®—æœªäº¤ä½œæ¥­æ•¸é‡ï¼Œæœ€å¤šé¡¯ç¤º5å€‹æ˜Ÿæ˜Ÿ
                        const homeworkCount = this.getHomeworkCount(student.id);
                        const displayStars = Math.min(homeworkCount, 5);
                        const homeworkStars = 'â­'.repeat(displayStars);
                        
                        seatDiv.innerHTML = `
                            <div class="font-semibold text-xs lg:text-sm flex items-center justify-center">${student.seatNumber}${genderDot}</div>
                            <div class="text-xs lg:text-sm">
                                ${displayName}
                            </div>
                            ${homeworkCount > 0 ? `<div class="text-xs text-yellow-600" title="æœªäº¤ä½œæ¥­ï¼š${homeworkCount}é …">${homeworkStars}${homeworkCount > 5 ? '+' : ''}</div>` : ''}
                        `;
                        seatDiv.addEventListener('dblclick', () => {
                            if (!this.isLotteryRunning) {
                                this.showStudentSettingsModal(student);
                            }
                        });
                    }
                } else {
                    seatDiv.innerHTML = '<div class="text-gray-400 text-xs lg:text-sm">ç©ºä½</div>';
                }

                this.makeDraggable(seatDiv);
                this.makeDroppable(seatDiv);
                return seatDiv;
            }

            renderGroupSeats(container) {
                container.className = 'border-2 border-dashed border-gray-300 rounded-lg p-6 mb-6 flex-1';
                container.innerHTML = '';
                
                const seats = this.getCurrentSeats();
                
                // å‰µå»ºæ•™å®¤é¢¨æ ¼çš„å°çµ„åº§ä½å€åŸŸ
                const groupsContainer = document.createElement('div');
                groupsContainer.className = 'group-container grid grid-cols-3 gap-6 h-full flex-1';
                
                // æ±ºå®šå°çµ„é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚é¡›å€’ï¼‰
                const groupOrder = this.isStudentView ? [3, 4, 5, 0, 1, 2] : [3, 4, 5, 0, 1, 2];
                
                groupOrder.forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'border-2 border-dashed border-gray-400 rounded-lg p-4 min-h-52 relative bg-gray-50';
                    
                    const groupLabel = document.createElement('button');
                    groupLabel.className = 'absolute -top-3 left-4 bg-white px-3 py-1 text-sm font-semibold text-gray-700 rounded border hover:bg-gray-100 hover:border-blue-400 transition-colors cursor-pointer';
                    groupLabel.textContent = `ç¬¬${group + 1}çµ„`;
                    groupLabel.dataset.groupNumber = group + 1;
                    groupLabel.addEventListener('click', () => {
                        this.showGroupScoreModal(group + 1);
                    });
                    groupDiv.appendChild(groupLabel);
                    
                    const groupSeats = document.createElement('div');
                    groupSeats.className = 'flex flex-col items-center justify-center h-full pt-4';
                    
                    // æ±ºå®šåº§ä½æ’åˆ—é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚ä¸Šä¸‹é¡›å€’ï¼‰
                    const seatRows = this.isStudentView ? [
                        // å­¸ç”Ÿè¦–è§’ï¼šä¸‹æ’è®Šä¸Šæ’ï¼Œä¸Šæ’è®Šä¸‹æ’
                        [3, 4], // åŸæœ¬çš„ä¸‹æ’è®Šæˆä¸Šæ’
                        [1, 2], // åŸæœ¬çš„ä¸­æ’ä¿æŒä¸­æ’
                        [0]     // åŸæœ¬çš„ä¸Šæ’è®Šæˆä¸‹æ’
                    ] : [
                        // è€å¸«è¦–è§’ï¼šæ­£å¸¸æ’åˆ—
                        [0],    // ä¸Šæ’1å€‹
                        [1, 2], // ä¸­æ’2å€‹
                        [3, 4]  // ä¸‹æ’2å€‹
                    ];
                    
                    seatRows.forEach((rowSeats, rowIndex) => {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'flex justify-center gap-3 mb-3';
                        
                        rowSeats.forEach(seat => {
                            const position = group * 5 + seat;
                            const seatDiv = this.createSeatElement(position, seats);
                            rowDiv.appendChild(seatDiv);
                        });
                        
                        groupSeats.appendChild(rowDiv);
                    });
                    
                    groupDiv.appendChild(groupSeats);
                    groupsContainer.appendChild(groupDiv);
                });
                
                container.appendChild(groupsContainer);
            }

            renderExamSeats(container) {
                container.className = 'border-2 border-dashed border-gray-300 rounded-lg p-4 mb-6 flex-1 flex flex-col justify-center';
                container.innerHTML = '';
                
                const seats = this.getCurrentSeats();
                
                // æ±ºå®šæ’åˆ—é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚é¡›å€’ï¼‰
                const rows = this.isStudentView ? [5, 4, 3, 2, 1, 0] : [0, 1, 2, 3, 4, 5];
                
                // å‰µå»º6æ’åº§ä½ï¼Œæ¯æ’6å€‹åº§ä½
                rows.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'flex justify-between items-center px-8 mb-3';
                    
                    // æ±ºå®šåº§ä½é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚å·¦å³ä¹Ÿé¡›å€’ï¼‰
                    const seatOrder = this.isStudentView ? [5, 4, 3, 2, 1, 0] : [0, 1, 2, 3, 4, 5];
                    
                    seatOrder.forEach(col => {
                        const position = row * 6 + col;
                        const seatDiv = this.createSeatElement(position, seats);
                        rowDiv.appendChild(seatDiv);
                    });
                    
                    container.appendChild(rowDiv);
                });
            }

            renderFreeSeats(container) {
                container.className = 'border-2 border-dashed border-gray-300 rounded-lg p-6 mb-6 flex-1 relative bg-gray-50';
                container.innerHTML = '';
                
                // æ·»åŠ æç¤ºæ–‡å­—
                const hint = document.createElement('div');
                hint.className = 'absolute top-4 left-4 text-gray-500 text-sm pointer-events-none';
                hint.textContent = 'å¾å·¦å´æ‹–æ‹½å­¸ç”Ÿåˆ°æ­¤å€åŸŸå‰µå»ºåº§ä½';
                container.appendChild(hint);
                
                const seats = this.getCurrentSeats();
                
                // æ¸²æŸ“ç¾æœ‰çš„è‡ªç”±åº§ä½
                Object.keys(seats).forEach(position => {
                    const studentId = seats[position];
                    if (studentId) {
                        const student = this.students.find(s => s.id === studentId);
                        if (student) {
                            const seatDiv = this.createFreeSeatElement(position, student);
                            container.appendChild(seatDiv);
                        }
                    }
                });
                
                // è®“æ•´å€‹å®¹å™¨å¯ä»¥æ¥å—æ‹–æ‹½
                this.makeFreeDroppable(container);
            }

            createFreeSeatElement(position, student) {
                const seatDiv = document.createElement('div');
                seatDiv.className = 'absolute w-40 h-24 bg-purple-100 border-2 border-purple-400 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-purple-600 transition-colors text-xs shadow-md';
                seatDiv.dataset.position = position;
                seatDiv.draggable = true;
                
                // å¾positionè§£æåº§æ¨™
                const coords = position.split(',');
                const x = parseInt(coords[0]);
                const y = parseInt(coords[1]);
                
                seatDiv.style.left = `${x}px`;
                seatDiv.style.top = `${y}px`;
                
                const genderDot = student.gender === 'male' ? 
                    '<span class="inline-block w-1.5 h-1.5 bg-blue-500 rounded-full ml-1"></span>' : 
                    '<span class="inline-block w-1.5 h-1.5 bg-red-500 rounded-full ml-1"></span>';
                
                // è¨ˆç®—æœªäº¤ä½œæ¥­æ•¸é‡ï¼Œæœ€å¤šé¡¯ç¤º5å€‹æ˜Ÿæ˜Ÿ
                const homeworkCount = this.getHomeworkCount(student.id);
                const displayStars = Math.min(homeworkCount, 5);
                const homeworkStars = 'â­'.repeat(displayStars);
                
                seatDiv.innerHTML = `
                    <div class="font-semibold text-xs">${student.seatNumber}</div>
                    <div class="truncate w-full text-center px-1 text-xs flex items-center justify-center">
                        ${student.name}${genderDot}
                    </div>
                    ${homeworkCount > 0 ? `<div class="text-xs text-yellow-600" title="æœªäº¤ä½œæ¥­ï¼š${homeworkCount}é …">${homeworkStars}${homeworkCount > 5 ? '+' : ''}</div>` : ''}
                `;
                
                // é›™æ“Šäº‹ä»¶
                seatDiv.addEventListener('dblclick', () => {
                    if (!this.isLotteryRunning) {
                        this.showScoreModal(student);
                    }
                });
                
                // æ‹–æ‹½äº‹ä»¶
                seatDiv.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', `freeseat:${position}`);
                    seatDiv.classList.add('dragging');
                });
                
                seatDiv.addEventListener('dragend', (e) => {
                    seatDiv.classList.remove('dragging');
                });
                
                return seatDiv;
            }

            makeFreeDroppable(container) {
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    container.classList.add('drop-zone');
                });
                
                container.addEventListener('dragleave', (e) => {
                    if (!container.contains(e.relatedTarget)) {
                        container.classList.remove('drop-zone');
                    }
                });
                
                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    container.classList.remove('drop-zone');
                    
                    const dragData = e.dataTransfer.getData('text/plain');
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX - rect.left - 80; // æ¸›å»åº§ä½å¯¬åº¦çš„ä¸€åŠ
                    const y = e.clientY - rect.top - 48; // æ¸›å»åº§ä½é«˜åº¦çš„ä¸€åŠ
                    
                    // ç¢ºä¿åº§ä½ä¸æœƒè¶…å‡ºé‚Šç•Œ
                    const maxX = container.clientWidth - 160;
                    const maxY = container.clientHeight - 96;
                    const finalX = Math.max(0, Math.min(x, maxX));
                    const finalY = Math.max(0, Math.min(y, maxY));
                    
                    const position = `${finalX},${finalY}`;
                    
                    if (dragData.startsWith('student:')) {
                        // å¾å­¸ç”Ÿåˆ—è¡¨æ‹–æ‹½åˆ°è‡ªç”±å€åŸŸ
                        const studentId = parseInt(dragData.replace('student:', ''));
                        this.assignStudentToFreeSeat(studentId, position);
                    } else if (dragData.startsWith('freeseat:')) {
                        // ç§»å‹•ç¾æœ‰çš„è‡ªç”±åº§ä½
                        const oldPosition = dragData.replace('freeseat:', '');
                        this.moveFreeSeats(oldPosition, position);
                    }
                });
            }

            assignStudentToFreeSeat(studentId, position) {
                const seats = this.getCurrentSeats();
                
                // æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²ç¶“æœ‰åº§ä½ï¼Œå¦‚æœæœ‰å°±æ¸…é™¤åŸåº§ä½
                Object.keys(seats).forEach(pos => {
                    if (seats[pos] === studentId) {
                        delete seats[pos];
                    }
                });
                
                // å°‡å­¸ç”Ÿåˆ†é…åˆ°æ–°ä½ç½®
                seats[position] = studentId;
                
                this.saveData();
                this.renderSeats();
            }

            moveFreeSeats(oldPosition, newPosition) {
                const seats = this.getCurrentSeats();
                const studentId = seats[oldPosition];
                
                if (studentId) {
                    delete seats[oldPosition];
                    seats[newPosition] = studentId;
                    
                    this.saveData();
                    this.renderSeats();
                }
            }

            makeDraggable(element) {
                element.draggable = true;
                element.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.position);
                    e.target.classList.add('dragging');
                });
                element.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            }

            makeDroppable(element) {
                element.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    element.classList.add('drop-zone');
                });
                element.addEventListener('dragleave', () => {
                    element.classList.remove('drop-zone');
                });
                element.addEventListener('drop', (e) => {
                    e.preventDefault();
                    element.classList.remove('drop-zone');
                    
                    const dragData = e.dataTransfer.getData('text/plain');
                    const toPosition = parseInt(element.dataset.position);
                    
                    if (dragData.startsWith('student:')) {
                        // å¾å­¸ç”Ÿåˆ—è¡¨æ‹–æ‹½åˆ°åº§ä½
                        const studentId = parseInt(dragData.replace('student:', ''));
                        this.assignStudentToSeat(studentId, toPosition);
                    } else {
                        // åº§ä½ä¹‹é–“çš„æ‹–æ‹½
                        const fromPosition = parseInt(dragData);
                        if (fromPosition !== toPosition) {
                            this.swapSeats(fromPosition, toPosition);
                        }
                    }
                });
            }

            assignStudentToSeat(studentId, position) {
                const seats = this.getCurrentSeats();
                
                // æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²ç¶“æœ‰åº§ä½ï¼Œå¦‚æœæœ‰å°±æ¸…é™¤åŸåº§ä½
                Object.keys(seats).forEach(pos => {
                    if (seats[pos] === studentId) {
                        delete seats[pos];
                    }
                });
                
                // å°‡å­¸ç”Ÿåˆ†é…åˆ°æ–°åº§ä½
                seats[position] = studentId;
                
                this.saveData();
                this.renderSeats();
            }

            swapSeats(pos1, pos2) {
                const seats = this.getCurrentSeats();
                const temp = seats[pos1];
                seats[pos1] = seats[pos2];
                seats[pos2] = temp;
                
                this.saveData();
                this.renderSeats();
            }

            showScoreModal(student) {
                this.currentScoreStudent = student;
                this.selectedScoreType = null; // é‡ç½®é¸æ“‡ç‹€æ…‹
                const modal = document.getElementById('scoreModal');
                const studentName = document.getElementById('scoreStudentName');
                const reasonInput = document.getElementById('scoreReason');
                
                studentName.textContent = `${student.seatNumber}è™Ÿ ${student.name}`;
                reasonInput.value = '';
                
                // ç‚ºå¿«é€ŸåŸå› æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const reasonButtons = modal.querySelectorAll('.reason-btn');
                reasonButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        reasonInput.value = btn.textContent.trim();
                        reasonInput.focus();
                    });
                });
                
                // ç‚ºå¿«é€Ÿåˆ†æ•¸æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const quickScoreButtons = modal.querySelectorAll('.quick-score-btn');
                quickScoreButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const score = parseInt(btn.dataset.score);
                        document.getElementById('scoreAmount').value = score;
                        this.updateScoreButtonText();
                    });
                });
                
                // ç‚ºåˆ†æ•¸è¼¸å…¥æ¡†æ·»åŠ äº‹ä»¶ç›£è½å™¨
                document.getElementById('scoreAmount').addEventListener('input', () => {
                    this.updateScoreButtonText();
                });
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideScoreModal() {
                document.getElementById('scoreModal').classList.add('hidden');
                document.getElementById('scoreModal').classList.remove('flex');
                this.currentScoreStudent = null;
                this.selectedScoreType = null;
            }

            selectScoreType(type) {
                const scoreAmount = parseInt(document.getElementById('scoreAmount').value) || 1;
                this.selectedScoreType = type * scoreAmount;
                const reasonInput = document.getElementById('scoreReason');
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                document.getElementById('addScoreText').textContent = `+${scoreAmount}`;
                document.getElementById('subtractScoreText').textContent = `-${scoreAmount}`;
                
                // è¨­å®šé è¨­å…§å®¹
                if (type === 1) {
                    reasonInput.value = 'è¡¨ç¾å„ªè‰¯';
                } else {
                    reasonInput.value = 'è¡¨ç¾ä¸å¥½';
                }
                
                reasonInput.focus();
                reasonInput.select(); // é¸ä¸­æ–‡å­—ï¼Œæ–¹ä¾¿ä¿®æ”¹
            }

            confirmScore() {
                if (!this.selectedScoreType) {
                    alert('è«‹å…ˆé¸æ“‡åŠ åˆ†æˆ–æ‰£åˆ†');
                    return;
                }
                
                this.adjustScore(this.selectedScoreType);
            }

            adjustScore(change) {
                if (!this.currentScoreStudent) return;
                
                const reason = document.getElementById('scoreReason').value.trim();
                if (!reason) {
                    alert('è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ');
                    return;
                }

                const student = this.currentScoreStudent;
                
                // æ›´æ–°ç©åˆ†
                if (!this.scores[student.id]) {
                    this.scores[student.id] = 0;
                }
                this.scores[student.id] += change;
                
                // è¨˜éŒ„æ­·å²
                if (!this.scoreHistory[student.id]) {
                    this.scoreHistory[student.id] = [];
                }
                
                this.scoreHistory[student.id].push({
                    date: new Date().toLocaleString('zh-TW'),
                    change: change,
                    reason: reason,
                    total: this.scores[student.id]
                });
                
                this.saveData();
                this.renderStudentList();
                this.renderSeats();
                this.hideScoreModal();
                
                // é¡¯ç¤ºå‹•ç•«
                const changeText = change > 0 ? `+${change}` : `${change}`;
                // é€™è£¡å¯ä»¥æ·»åŠ å‹•ç•«æ•ˆæœ
            }

            showEditModal(student = null, defaultSeatNumber = null) {
                this.editingStudent = student;
                const modal = document.getElementById('editModal');
                const seatNumberInput = document.getElementById('editSeatNumber');
                const nameInput = document.getElementById('editStudentName');
                const genderSelect = document.getElementById('editStudentGender');
                
                if (student) {
                    seatNumberInput.value = student.seatNumber;
                    nameInput.value = student.name;
                    genderSelect.value = student.gender || 'male';
                } else {
                    seatNumberInput.value = defaultSeatNumber || (this.students.length + 1);
                    nameInput.value = '';
                    genderSelect.value = 'male';
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                nameInput.focus();
            }

            hideEditModal() {
                document.getElementById('editModal').classList.add('hidden');
                document.getElementById('editModal').classList.remove('flex');
                this.editingStudent = null;
            }

            saveStudent() {
                const seatNumber = parseInt(document.getElementById('editSeatNumber').value);
                const name = document.getElementById('editStudentName').value.trim();
                const gender = document.getElementById('editStudentGender').value;
                
                if (!name) {
                    alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“å');
                    return;
                }

                if (this.editingStudent) {
                    // ç·¨è¼¯ç¾æœ‰å­¸ç”Ÿ
                    this.editingStudent.seatNumber = seatNumber;
                    this.editingStudent.name = name;
                    this.editingStudent.gender = gender;
                } else {
                    // æ–°å¢å­¸ç”Ÿ
                    const newId = Math.max(...this.students.map(s => s.id), 0) + 1;
                    const newStudent = {
                        id: newId,
                        seatNumber: seatNumber,
                        name: name,
                        gender: gender
                    };
                    
                    // å¦‚æœæ˜¯16è™Ÿä¹‹å¾Œçš„åº§è™Ÿï¼Œéœ€è¦æ’å…¥åˆ°æ­£ç¢ºä½ç½®
                    if (seatNumber >= 16) {
                        // æ‰¾åˆ°æ’å…¥ä½ç½®
                        let insertIndex = this.students.length;
                        for (let i = 0; i < this.students.length; i++) {
                            if (this.students[i].seatNumber > seatNumber) {
                                insertIndex = i;
                                break;
                            }
                        }
                        this.students.splice(insertIndex, 0, newStudent);
                    } else {
                        // 15è™Ÿä»¥å‰çš„ç›´æ¥åŠ åˆ°æœ«å°¾
                        this.students.push(newStudent);
                    }
                }

                this.saveData();
                this.renderStudentList();
                this.renderSeats(); // åŒæ­¥æ›´æ–°åº§ä½é¡¯ç¤º
                this.hideEditModal();
            }

            deleteStudent() {
                if (this.editingStudent && confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ')) {
                    // å¾åº§ä½ä¸­ç§»é™¤
                    Object.keys(this.normalSeats).forEach(pos => {
                        if (this.normalSeats[pos] === this.editingStudent.id) {
                            delete this.normalSeats[pos];
                        }
                    });
                    Object.keys(this.groupSeats).forEach(pos => {
                        if (this.groupSeats[pos] === this.editingStudent.id) {
                            delete this.groupSeats[pos];
                        }
                    });
                    Object.keys(this.examSeats).forEach(pos => {
                        if (this.examSeats[pos] === this.editingStudent.id) {
                            delete this.examSeats[pos];
                        }
                    });
                    Object.keys(this.freeSeats).forEach(pos => {
                        if (this.freeSeats[pos] === this.editingStudent.id) {
                            delete this.freeSeats[pos];
                        }
                    });

                    // å¾å­¸ç”Ÿåˆ—è¡¨ä¸­ç§»é™¤
                    this.students = this.students.filter(s => s.id !== this.editingStudent.id);
                    
                    // ç§»é™¤ç©åˆ†
                    delete this.scores[this.editingStudent.id];

                    this.saveData();
                    this.renderStudentList();
                    this.renderSeats();
                    this.hideEditModal();
                }
            }

            randomSeating() {
                if (confirm('ç¢ºå®šè¦å°‡æ‰€æœ‰å­¸ç”Ÿéš¨æ©Ÿå®‰æ’åº§ä½å—ï¼Ÿé€™æœƒæ¸…é™¤ç›®å‰çš„åº§ä½å®‰æ’ã€‚')) {
                    const seats = this.getCurrentSeats();
                    
                    // æ¸…ç©ºç•¶å‰åº§ä½å®‰æ’
                    Object.keys(seats).forEach(position => {
                        delete seats[position];
                    });
                    
                    // ç²å–æ‰€æœ‰å¯ç”¨åº§ä½ä½ç½®
                    let availablePositions = [];
                    
                    if (this.currentMode === 'normal') {
                        // ä¸€èˆ¬åº§ä½ï¼š30å€‹ä½ç½® (5æ’ x 6åˆ—)
                        for (let i = 0; i < 30; i++) {
                            availablePositions.push(i);
                        }
                    } else if (this.currentMode === 'group') {
                        // å°çµ„åº§ä½ï¼š30å€‹ä½ç½® (6çµ„ x 5å€‹åº§ä½)
                        for (let i = 0; i < 30; i++) {
                            availablePositions.push(i);
                        }
                    } else if (this.currentMode === 'exam') {
                        // è€ƒè©¦åº§ä½ï¼š36å€‹ä½ç½® (6æ’ x 6åˆ—)
                        for (let i = 0; i < 36; i++) {
                            availablePositions.push(i);
                        }
                    } else {
                        // è‡ªç”±åº§ä½æ¨¡å¼ä¸é©ç”¨éš¨æ©Ÿå…¥åº§
                        alert('è‡ªç”±åº§ä½æ¨¡å¼ä¸æ”¯æ´éš¨æ©Ÿå…¥åº§åŠŸèƒ½');
                        return;
                    }
                    
                    // æ´—ç‰Œç®—æ³•æ‰“äº‚åº§ä½é †åº
                    for (let i = availablePositions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [availablePositions[i], availablePositions[j]] = [availablePositions[j], availablePositions[i]];
                    }
                    
                    // å°‡å­¸ç”Ÿéš¨æ©Ÿåˆ†é…åˆ°åº§ä½
                    const studentsToAssign = [...this.students]; // è¤‡è£½å­¸ç”Ÿé™£åˆ—
                    
                    // ä¹Ÿæ‰“äº‚å­¸ç”Ÿé †åº
                    for (let i = studentsToAssign.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [studentsToAssign[i], studentsToAssign[j]] = [studentsToAssign[j], studentsToAssign[i]];
                    }
                    
                    // åˆ†é…åº§ä½
                    studentsToAssign.forEach((student, index) => {
                        if (index < availablePositions.length) {
                            seats[availablePositions[index]] = student.id;
                        }
                    });
                    
                    this.saveData();
                    this.renderSeats();
                    
                    alert(`éš¨æ©Ÿå…¥åº§å®Œæˆï¼å·²ç‚º ${Math.min(studentsToAssign.length, availablePositions.length)} ä½å­¸ç”Ÿå®‰æ’åº§ä½ã€‚`);
                }
            }

            resetSeats() {
                if (confirm('ç¢ºå®šè¦é‡ç½®ç•¶å‰æ¨¡å¼çš„åº§ä½å®‰æ’å—ï¼Ÿ')) {
                    if (this.currentMode === 'normal') {
                        this.normalSeats = {};
                    } else if (this.currentMode === 'group') {
                        this.groupSeats = {};
                    } else if (this.currentMode === 'exam') {
                        this.examSeats = {};
                    } else {
                        this.freeSeats = {};
                    }
                    this.saveData();
                    this.renderSeats();
                }
            }

            showScoresModal() {
                const modal = document.getElementById('scoresModal');
                const container = document.getElementById('scoresList');
                
                // æŒ‰ç©åˆ†æ’åº
                const sortedStudents = this.students
                    .map(student => ({
                        ...student,
                        score: this.scores[student.id] || 0
                    }))
                    .sort((a, b) => b.score - a.score);

                container.innerHTML = '';
                sortedStudents.forEach((student, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </span>
                            <span>${student.seatNumber}è™Ÿ ${student.name}</span>
                        </div>
                        <span class="text-lg font-bold text-blue-600">${student.score}åˆ†</span>
                    `;
                    container.appendChild(div);
                });

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideScoresModal() {
                document.getElementById('scoresModal').classList.add('hidden');
                document.getElementById('scoresModal').classList.remove('flex');
            }

            showHistoryModal(student) {
                const modal = document.getElementById('historyModal');
                const studentName = document.getElementById('historyStudentName');
                const totalScore = document.getElementById('historyTotalScore');
                const container = document.getElementById('historyList');
                
                studentName.textContent = `${student.seatNumber}è™Ÿ ${student.name}`;
                totalScore.textContent = `ç¸½ç©åˆ†ï¼š${this.scores[student.id] || 0}åˆ†`;
                
                container.innerHTML = '';
                
                const history = this.scoreHistory[student.id] || [];
                if (history.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">æš«ç„¡ç©åˆ†è¨˜éŒ„</div>';
                } else {
                    // æŒ‰æ™‚é–“å€’åºé¡¯ç¤º
                    history.slice().reverse().forEach(record => {
                        const div = document.createElement('div');
                        div.className = 'p-3 bg-gray-50 rounded-lg border-l-4 ' + 
                            (record.change > 0 ? 'border-green-500' : 'border-red-500');
                        
                        const changeColor = record.change > 0 ? 'text-green-600' : 'text-red-600';
                        const changeText = record.change > 0 ? `+${record.change}` : `${record.change}`;
                        
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-sm text-gray-600">${record.date}</span>
                                <span class="font-bold ${changeColor}">${changeText}åˆ†</span>
                            </div>
                            <div class="text-sm text-gray-800 mb-1">${record.reason}</div>
                            <div class="text-xs text-gray-500">ç©åˆ†è®Šç‚ºï¼š${record.total}åˆ†</div>
                        `;
                        container.appendChild(div);
                    });
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideHistoryModal() {
                document.getElementById('historyModal').classList.add('hidden');
                document.getElementById('historyModal').classList.remove('flex');
            }

            resetAllScores() {
                if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç”Ÿçš„ç©åˆ†å—ï¼Ÿ')) {
                    this.scores = {};
                    this.scoreHistory = {};
                    this.saveData();
                    this.renderStudentList();
                    this.hideScoresModal();
                }
            }

            startLottery(type) {
                if (this.isLotteryRunning) return;
                
                // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡
                this.clearSelection();
                
                // ç²å–ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿ
                const eligibleStudents = this.getEligibleStudents(type);
                const lotteryCount = parseInt(document.getElementById('lotteryCount').value) || 1;
                
                if (eligibleStudents.length === 0) {
                    const typeText = type === 'all' ? 'æ‰€æœ‰' : (type === 'male' ? 'ç”·' : 'å¥³');
                    alert(`æ²’æœ‰${typeText}å­¸ç”Ÿåœ¨åº§ä½ä¸Šï¼Œç„¡æ³•é€²è¡ŒæŠ½ç±¤ï¼`);
                    return;
                }
                
                if (lotteryCount > eligibleStudents.length) {
                    const typeText = type === 'all' ? 'æ‰€æœ‰' : (type === 'male' ? 'ç”·' : 'å¥³');
                    alert(`${typeText}å­¸ç”Ÿåªæœ‰${eligibleStudents.length}äººï¼Œç„¡æ³•æŠ½å–${lotteryCount}äººï¼`);
                    return;
                }
                
                this.isLotteryRunning = true;
                this.disableLotteryButtons();
                
                // é–‹å§‹é–ƒçˆå‹•ç•«
                this.startFlashAnimation(eligibleStudents);
                
                // 3ç§’å¾Œé¸å‡ºçµæœ
                setTimeout(() => {
                    this.selectWinners(eligibleStudents, lotteryCount);
                }, 3000);
            }

            getEligibleStudents(type) {
                const seats = this.getCurrentSeats();
                const eligibleStudents = [];
                
                Object.keys(seats).forEach(position => {
                    const studentId = seats[position];
                    if (studentId) {
                        const student = this.students.find(s => s.id === studentId);
                        if (student) {
                            if (type === 'all' || student.gender === type) {
                                eligibleStudents.push({
                                    student: student,
                                    position: position
                                });
                            }
                        }
                    }
                });
                
                return eligibleStudents;
            }

            startFlashAnimation(eligibleStudents) {
                this.flashIntervals = [];
                
                eligibleStudents.forEach((item, index) => {
                    const seatElement = document.querySelector(`[data-position="${item.position}"]`);
                    if (seatElement) {
                        // ç‚ºæ¯å€‹å­¸ç”Ÿè¨­å®šä¸åŒçš„éš¨æ©Ÿé–ƒçˆé–“éš”
                        const randomInterval = 200 + Math.random() * 400; // 200-600ms éš¨æ©Ÿé–“éš”
                        const randomDelay = Math.random() * 300; // 0-300ms éš¨æ©Ÿå»¶é²é–‹å§‹
                        
                        setTimeout(() => {
                            const interval = setInterval(() => {
                                if (seatElement.classList.contains('lottery-flash')) {
                                    seatElement.classList.remove('lottery-flash');
                                } else {
                                    seatElement.classList.add('lottery-flash');
                                }
                            }, randomInterval);
                            
                            this.flashIntervals.push(interval);
                        }, randomDelay);
                    }
                });
            }

            selectWinners(eligibleStudents, count) {
                // åœæ­¢æ‰€æœ‰é–ƒçˆå‹•ç•«è¨ˆæ™‚å™¨
                if (this.flashIntervals) {
                    this.flashIntervals.forEach(interval => clearInterval(interval));
                    this.flashIntervals = [];
                }
                
                // æ¸…é™¤æ‰€æœ‰é–ƒçˆæ•ˆæœ
                eligibleStudents.forEach(item => {
                    const seatElement = document.querySelector(`[data-position="${item.position}"]`);
                    if (seatElement) {
                        seatElement.classList.remove('lottery-flash');
                    }
                });
                
                // ä½¿ç”¨æ´—ç‰Œç®—æ³•éš¨æ©Ÿé¸æ“‡å¤šå€‹ç²å‹è€…
                const shuffled = [...eligibleStudents];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                const winners = shuffled.slice(0, count);
                this.selectedStudents = winners;
                
                // æ¨™è¨˜æ‰€æœ‰ç²å‹è€…
                const seatNumbers = [];
                winners.forEach(winner => {
                    const winnerSeat = document.querySelector(`[data-position="${winner.position}"]`);
                    if (winnerSeat) {
                        winnerSeat.classList.add('lottery-selected');
                    }
                    seatNumbers.push(winner.student.seatNumber);
                });
                
                // èªéŸ³æ’­å ±çµæœ
                this.speakLotteryResults(seatNumbers);
                
                // é¡¯ç¤ºå–æ¶ˆæ¨™è¨˜æŒ‰éˆ•
                document.getElementById('clearSelection').classList.remove('hidden');
                
                this.isLotteryRunning = false;
                this.enableLotteryButtons();
            }

            clearSelection() {
                // åœæ­¢æ‰€æœ‰é–ƒçˆå‹•ç•«è¨ˆæ™‚å™¨
                if (this.flashIntervals) {
                    this.flashIntervals.forEach(interval => clearInterval(interval));
                    this.flashIntervals = [];
                }
                
                // æ¸…é™¤æ‰€æœ‰é¸ä¸­çš„å­¸ç”Ÿ
                if (this.selectedStudents && this.selectedStudents.length > 0) {
                    this.selectedStudents.forEach(selectedStudent => {
                        const seatElement = document.querySelector(`[data-position="${selectedStudent.position}"]`);
                        if (seatElement) {
                            seatElement.classList.remove('lottery-selected');
                        }
                    });
                    this.selectedStudents = [];
                }
                
                // éš±è—å–æ¶ˆæ¨™è¨˜æŒ‰éˆ•
                document.getElementById('clearSelection').classList.add('hidden');
                
                // æ¸…é™¤æ‰€æœ‰é–ƒçˆæ•ˆæœ
                document.querySelectorAll('.lottery-flash').forEach(element => {
                    element.classList.remove('lottery-flash');
                });
            }

            disableLotteryButtons() {
                document.getElementById('lotteryAll').disabled = true;
                document.getElementById('lotteryBoys').disabled = true;
                document.getElementById('lotteryGirls').disabled = true;
                
                document.getElementById('lotteryAll').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('lotteryBoys').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('lotteryGirls').classList.add('opacity-50', 'cursor-not-allowed');
            }

            enableLotteryButtons() {
                document.getElementById('lotteryAll').disabled = false;
                document.getElementById('lotteryBoys').disabled = false;
                document.getElementById('lotteryGirls').disabled = false;
                
                document.getElementById('lotteryAll').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('lotteryBoys').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('lotteryGirls').classList.remove('opacity-50', 'cursor-not-allowed');
            }

            speakLotteryResults(seatNumbers) {
                // ä½¿ç”¨ç€è¦½å™¨çš„èªéŸ³åˆæˆAPIæ’­å ±æŠ½ç±¤çµæœ
                if ('speechSynthesis' in window) {
                    let message;
                    if (seatNumbers.length === 1) {
                        message = `æ­å–œ${seatNumbers[0]}è™Ÿ`;
                    } else {
                        const numbersText = seatNumbers.join('è™Ÿã€') + 'è™Ÿ';
                        message = `æ­å–œ${numbersText}`;
                    }
                    
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.lang = 'zh-TW'; // è¨­å®šç‚ºç¹é«”ä¸­æ–‡
                    utterance.rate = 0.9; // ç¨å¾®æ…¢ä¸€é»çš„èªé€Ÿ
                    utterance.pitch = 1.1; // ç¨å¾®é«˜ä¸€é»çš„éŸ³èª¿
                    utterance.volume = 0.8; // éŸ³é‡
                    
                    // å˜—è©¦ä½¿ç”¨Googleçš„èªéŸ³ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                    const voices = speechSynthesis.getVoices();
                    const googleVoice = voices.find(voice => 
                        voice.name.includes('Google') && voice.lang.includes('zh')
                    );
                    if (googleVoice) {
                        utterance.voice = googleVoice;
                    }
                    
                    speechSynthesis.speak(utterance);
                } else {
                    console.log('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆåŠŸèƒ½');
                }
            }



            showStudentSettingsModal(student) {
                this.currentSettingsStudent = student;
                this.selectedSettingsScoreType = null;
                const modal = document.getElementById('studentSettingsModal');
                const studentName = document.getElementById('settingsStudentName');
                const studentScore = document.getElementById('settingsStudentScore');
                const reasonInput = document.getElementById('settingsScoreReason');
                
                studentName.textContent = `${student.seatNumber}è™Ÿ ${student.name}`;
                studentScore.textContent = `ç©åˆ†ï¼š${this.scores[student.id] || 0}åˆ†`;
                reasonInput.value = '';
                
                // ç‚ºå¿«é€ŸåŸå› æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const reasonButtons = modal.querySelectorAll('.settings-reason-btn');
                reasonButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        reasonInput.value = btn.textContent.trim();
                        reasonInput.focus();
                    });
                });
                
                // ç‚ºå¿«é€Ÿåˆ†æ•¸æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const quickScoreButtons = modal.querySelectorAll('.settings-quick-score-btn');
                quickScoreButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const score = parseInt(btn.dataset.score);
                        document.getElementById('settingsScoreAmount').value = score;
                        this.updateSettingsScoreButtonText();
                    });
                });
                
                // ç‚ºåˆ†æ•¸è¼¸å…¥æ¡†æ·»åŠ äº‹ä»¶ç›£è½å™¨
                document.getElementById('settingsScoreAmount').addEventListener('input', () => {
                    this.updateSettingsScoreButtonText();
                });
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideStudentSettingsModal() {
                document.getElementById('studentSettingsModal').classList.add('hidden');
                document.getElementById('studentSettingsModal').classList.remove('flex');
                this.currentSettingsStudent = null;
                this.selectedSettingsScoreType = null;
            }

            selectSettingsScoreType(type) {
                const scoreAmount = parseInt(document.getElementById('settingsScoreAmount').value) || 1;
                this.selectedSettingsScoreType = type * scoreAmount;
                const reasonInput = document.getElementById('settingsScoreReason');
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                document.getElementById('settingsAddScoreText').textContent = `+${scoreAmount}`;
                document.getElementById('settingsSubtractScoreText').textContent = `-${scoreAmount}`;
                
                // è¨­å®šé è¨­å…§å®¹
                if (type === 1) {
                    reasonInput.value = 'è¡¨ç¾å„ªè‰¯';
                } else {
                    reasonInput.value = 'è¡¨ç¾ä¸å¥½';
                }
                
                reasonInput.focus();
                reasonInput.select();
            }

            confirmSettingsScore() {
                if (!this.selectedSettingsScoreType) {
                    alert('è«‹å…ˆé¸æ“‡åŠ åˆ†æˆ–æ‰£åˆ†');
                    return;
                }
                
                const reason = document.getElementById('settingsScoreReason').value.trim();
                if (!reason) {
                    alert('è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ');
                    return;
                }

                const student = this.currentSettingsStudent;
                
                // æ›´æ–°ç©åˆ†
                if (!this.scores[student.id]) {
                    this.scores[student.id] = 0;
                }
                this.scores[student.id] += this.selectedSettingsScoreType;
                
                // è¨˜éŒ„æ­·å²
                if (!this.scoreHistory[student.id]) {
                    this.scoreHistory[student.id] = [];
                }
                
                this.scoreHistory[student.id].push({
                    date: new Date().toLocaleString('zh-TW'),
                    change: this.selectedSettingsScoreType,
                    reason: reason,
                    total: this.scores[student.id]
                });
                
                this.saveData();
                this.renderStudentList();
                this.renderSeats();
                
                // æ›´æ–°æ¨¡æ…‹æ¡†ä¸­çš„ç©åˆ†é¡¯ç¤º
                const studentScore = document.getElementById('settingsStudentScore');
                studentScore.textContent = `ç©åˆ†ï¼š${this.scores[student.id]}åˆ†`;
                
                // æ¸…é™¤é¸æ“‡ç‹€æ…‹
                this.selectedSettingsScoreType = null;
                document.getElementById('settingsScoreReason').value = '';
                
                alert(`ç©åˆ†èª¿æ•´å®Œæˆï¼${student.name}ç›®å‰ç©åˆ†ï¼š${this.scores[student.id]}åˆ†`);
            }

            viewHistoryFromSettings() {
                this.hideStudentSettingsModal();
                this.showHistoryModal(this.currentSettingsStudent);
            }

            editStudentFromSettings() {
                const studentToEdit = this.currentSettingsStudent;
                this.hideStudentSettingsModal();
                this.showEditModal(studentToEdit);
            }

            // è¨ˆæ™‚å™¨åŠŸèƒ½æ–¹æ³•
            showTimerModal() {
                const modal = document.getElementById('timerModal');
                
                // ç‚ºå¿«é€Ÿæ™‚é–“æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const quickTimeButtons = modal.querySelectorAll('.quick-time-btn');
                quickTimeButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const minutes = parseInt(btn.dataset.minutes);
                        document.getElementById('timerHours').value = Math.floor(minutes / 60);
                        document.getElementById('timerMinutes').value = minutes % 60;
                        document.getElementById('timerSeconds').value = 0;
                    });
                });
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideTimerModal() {
                document.getElementById('timerModal').classList.add('hidden');
                document.getElementById('timerModal').classList.remove('flex');
            }

            startCountdownTimer() {
                const hours = parseInt(document.getElementById('timerHours').value) || 0;
                const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
                const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
                
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                
                if (totalSeconds <= 0) {
                    alert('è«‹è¨­å®šæœ‰æ•ˆçš„æ™‚é–“ï¼');
                    return;
                }
                
                this.timerRemaining = totalSeconds;
                this.timerRunning = true;
                this.timerPaused = false;
                
                this.hideTimerModal();
                this.showTimerControls();
                this.runTimer();
            }

            showTimerControls() {
                document.getElementById('timerDisplay').classList.remove('hidden');
                document.getElementById('pauseTimer').classList.remove('hidden');
                document.getElementById('stopTimer').classList.remove('hidden');
                
                // æ›´æ–°è¨ˆæ™‚å™¨æŒ‰éˆ•æ–‡å­—
                document.getElementById('timerBtn').textContent = 'è¨­å®šè¨ˆæ™‚å™¨';
            }

            hideTimerControls() {
                document.getElementById('timerDisplay').classList.add('hidden');
                document.getElementById('pauseTimer').classList.add('hidden');
                document.getElementById('stopTimer').classList.add('hidden');
                
                // æ¢å¾©è¨ˆæ™‚å™¨æŒ‰éˆ•æ–‡å­—
                document.getElementById('timerBtn').textContent = 'è¨ˆæ™‚å™¨';
            }

            runTimer() {
                this.updateTimerDisplay();
                
                this.timerInterval = setInterval(() => {
                    if (!this.timerPaused) {
                        this.timerRemaining--;
                        this.updateTimerDisplay();
                        
                        if (this.timerRemaining <= 0) {
                            this.timerFinished();
                        }
                    }
                }, 1000);
            }

            updateTimerDisplay() {
                const hours = Math.floor(this.timerRemaining / 3600);
                const minutes = Math.floor((this.timerRemaining % 3600) / 60);
                const seconds = this.timerRemaining % 60;
                
                let display = '';
                if (hours > 0) {
                    display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                document.getElementById('timerDisplay').textContent = display;
                
                // æœ€å¾Œ10ç§’è®Šç´…è‰²
                if (this.timerRemaining <= 10 && this.timerRemaining > 0) {
                    document.getElementById('timerDisplay').className = 'text-lg font-mono font-bold text-red-600 min-w-20 text-center animate-pulse';
                } else {
                    document.getElementById('timerDisplay').className = 'text-lg font-mono font-bold text-gray-700 min-w-20 text-center';
                }
            }

            pauseTimer() {
                if (this.timerRunning) {
                    this.timerPaused = !this.timerPaused;
                    const pauseBtn = document.getElementById('pauseTimer');
                    
                    if (this.timerPaused) {
                        pauseBtn.textContent = 'ç¹¼çºŒ';
                        pauseBtn.className = 'px-3 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors';
                    } else {
                        pauseBtn.textContent = 'æš«åœ';
                        pauseBtn.className = 'px-3 py-2 bg-orange-500 text-white rounded text-sm hover:bg-orange-600 transition-colors';
                    }
                }
            }

            stopTimer() {
                if (confirm('ç¢ºå®šè¦åœæ­¢è¨ˆæ™‚å™¨å—ï¼Ÿ')) {
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                    }
                    
                    this.timerRunning = false;
                    this.timerPaused = false;
                    this.timerRemaining = 0;
                    
                    this.hideTimerControls();
                }
            }

            timerFinished() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                this.timerRunning = false;
                this.timerPaused = false;
                
                // æ’­æ”¾éŸ¿éˆ´éŸ³æ•ˆå’ŒèªéŸ³æé†’
                this.playAlarmSound();
                this.speakTimeUp();
                
                // é¡¯ç¤ºæ™‚é–“åˆ°æé†’è¦–çª—
                this.showTimeUpModal();
                
                // éš±è—è¨ˆæ™‚å™¨æ§åˆ¶é …
                this.hideTimerControls();
            }

            playAlarmSound() {
                // å‰µå»ºéŸ³é »ä¸Šä¸‹æ–‡ä¾†æ’­æ”¾éŸ¿éˆ´éŸ³æ•ˆ
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // æ’­æ”¾3æ¬¡éŸ¿éˆ´
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            // å‰µå»ºæŒ¯ç›ªå™¨ç”¢ç”ŸéŸ¿éˆ´éŸ³
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            // è¨­å®šéŸ¿éˆ´é »ç‡å’ŒéŸ³é‡
                            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
                            
                            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                            
                            oscillator.start(audioContext.currentTime);
                            oscillator.stop(audioContext.currentTime + 0.5);
                        }, i * 600); // æ¯600æ¯«ç§’éŸ¿ä¸€æ¬¡
                    }
                } catch (error) {
                    console.log('ç„¡æ³•æ’­æ”¾éŸ³æ•ˆ:', error);
                }
            }

            speakTimeUp() {
                // ä½¿ç”¨ç€è¦½å™¨çš„èªéŸ³åˆæˆAPIå¿µå‡º"æ™‚é–“åˆ°å›‰"ä¸‰æ¬¡
                if ('speechSynthesis' in window) {
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const utterance = new SpeechSynthesisUtterance('æ™‚é–“åˆ°å›‰');
                            utterance.lang = 'zh-TW'; // è¨­å®šç‚ºç¹é«”ä¸­æ–‡
                            utterance.rate = 1; // èªé€Ÿ
                            utterance.pitch = 1; // éŸ³èª¿
                            utterance.volume = 0.8; // éŸ³é‡
                            
                            // å˜—è©¦ä½¿ç”¨Googleçš„èªéŸ³ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                            const voices = speechSynthesis.getVoices();
                            const googleVoice = voices.find(voice => 
                                voice.name.includes('Google') && voice.lang.includes('zh')
                            );
                            if (googleVoice) {
                                utterance.voice = googleVoice;
                            }
                            
                            speechSynthesis.speak(utterance);
                        }, i * 1500); // æ¯1.5ç§’å¿µä¸€æ¬¡
                    }
                } else {
                    console.log('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆåŠŸèƒ½');
                }
            }



            showTimeUpModal() {
                const modal = document.getElementById('timeUpModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideTimeUpModal() {
                const modal = document.getElementById('timeUpModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            // å°çµ„ç©åˆ†ç›¸é—œæ–¹æ³•
            showGroupScoresModal() {
                const modal = document.getElementById('groupScoresModal');
                const container = document.getElementById('groupScoresList');
                
                // è¨ˆç®—æ¯çµ„ç©åˆ†
                const groupScores = [];
                for (let i = 1; i <= 6; i++) {
                    groupScores.push({
                        group: i,
                        score: this.groupScores[i] || 0
                    });
                }
                
                // æŒ‰ç©åˆ†æ’åº
                groupScores.sort((a, b) => b.score - a.score);

                container.innerHTML = '';
                groupScores.forEach((group, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </span>
                            <span>ç¬¬${group.group}çµ„</span>
                        </div>
                        <span class="text-lg font-bold text-green-600">${group.score}åˆ†</span>
                    `;
                    container.appendChild(div);
                });

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideGroupScoresModal() {
                document.getElementById('groupScoresModal').classList.add('hidden');
                document.getElementById('groupScoresModal').classList.remove('flex');
            }

            showGroupScoreModal(groupNumber) {
                this.currentGroupNumber = groupNumber;
                this.selectedGroupScoreType = null;
                const modal = document.getElementById('groupScoreModal');
                const groupName = document.getElementById('groupScoreGroupName');
                const reasonInput = document.getElementById('groupScoreReason');
                
                groupName.textContent = `ç¬¬${groupNumber}çµ„`;
                reasonInput.value = '';
                
                // ç‚ºå¿«é€ŸåŸå› æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const reasonButtons = modal.querySelectorAll('.group-reason-btn');
                reasonButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        reasonInput.value = btn.textContent.trim();
                        reasonInput.focus();
                    });
                });
                
                // ç‚ºå¿«é€Ÿåˆ†æ•¸æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const quickScoreButtons = modal.querySelectorAll('.group-quick-score-btn');
                quickScoreButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const score = parseInt(btn.dataset.score);
                        document.getElementById('groupScoreAmount').value = score;
                        this.updateGroupScoreButtonText();
                    });
                });
                
                // ç‚ºåˆ†æ•¸è¼¸å…¥æ¡†æ·»åŠ äº‹ä»¶ç›£è½å™¨
                document.getElementById('groupScoreAmount').addEventListener('input', () => {
                    this.updateGroupScoreButtonText();
                });
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideGroupScoreModal() {
                document.getElementById('groupScoreModal').classList.add('hidden');
                document.getElementById('groupScoreModal').classList.remove('flex');
                this.currentGroupNumber = null;
                this.selectedGroupScoreType = null;
            }

            selectGroupScoreType(type) {
                const scoreAmount = parseInt(document.getElementById('groupScoreAmount').value) || 1;
                this.selectedGroupScoreType = type * scoreAmount;
                const reasonInput = document.getElementById('groupScoreReason');
                
                // æ›´æ–°æŒ‰éˆ•æ–‡å­—
                document.getElementById('addGroupScoreText').textContent = `+${scoreAmount}`;
                document.getElementById('subtractGroupScoreText').textContent = `-${scoreAmount}`;
                
                // è¨­å®šé è¨­å…§å®¹
                if (type === 1) {
                    reasonInput.value = 'å°çµ„è¡¨ç¾å„ªè‰¯';
                } else {
                    reasonInput.value = 'å°çµ„è¡¨ç¾ä¸ä½³';
                }
                
                reasonInput.focus();
                reasonInput.select();
            }

            confirmGroupScore() {
                if (!this.selectedGroupScoreType) {
                    alert('è«‹å…ˆé¸æ“‡åŠ åˆ†æˆ–æ‰£åˆ†');
                    return;
                }
                
                const reason = document.getElementById('groupScoreReason').value.trim();
                if (!reason) {
                    alert('è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ');
                    return;
                }

                const groupNumber = this.currentGroupNumber;
                
                // æ›´æ–°å°çµ„ç©åˆ†
                if (!this.groupScores[groupNumber]) {
                    this.groupScores[groupNumber] = 0;
                }
                this.groupScores[groupNumber] += this.selectedGroupScoreType;
                
                // è¨˜éŒ„æ­·å²
                if (!this.groupScoreHistory[groupNumber]) {
                    this.groupScoreHistory[groupNumber] = [];
                }
                
                this.groupScoreHistory[groupNumber].push({
                    date: new Date().toLocaleString('zh-TW'),
                    change: this.selectedGroupScoreType,
                    reason: reason,
                    total: this.groupScores[groupNumber]
                });
                
                this.saveData();
                this.hideGroupScoreModal();
                
                // é¡¯ç¤ºçµæœ
                const changeText = this.selectedGroupScoreType > 0 ? `+${this.selectedGroupScoreType}` : `${this.selectedGroupScoreType}`;
                alert(`ç¬¬${groupNumber}çµ„ç©åˆ†èª¿æ•´å®Œæˆï¼${changeText}åˆ†\nç›®å‰ç©åˆ†ï¼š${this.groupScores[groupNumber]}åˆ†`);
            }

            resetAllGroupScores() {
                if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å°çµ„çš„ç©åˆ†å—ï¼Ÿ')) {
                    this.groupScores = {};
                    this.groupScoreHistory = {};
                    this.saveData();
                    this.hideGroupScoresModal();
                    alert('æ‰€æœ‰å°çµ„ç©åˆ†å·²é‡ç½®ï¼');
                }
            }

            // æ›´æ–°æŒ‰éˆ•æ–‡å­—çš„æ–¹æ³•
            updateScoreButtonText() {
                const scoreAmount = parseInt(document.getElementById('scoreAmount').value) || 1;
                document.getElementById('addScoreText').textContent = `+${scoreAmount}`;
                document.getElementById('subtractScoreText').textContent = `-${scoreAmount}`;
            }

            updateSettingsScoreButtonText() {
                const scoreAmount = parseInt(document.getElementById('settingsScoreAmount').value) || 1;
                document.getElementById('settingsAddScoreText').textContent = `+${scoreAmount}`;
                document.getElementById('settingsSubtractScoreText').textContent = `-${scoreAmount}`;
            }

            updateGroupScoreButtonText() {
                const scoreAmount = parseInt(document.getElementById('groupScoreAmount').value) || 1;
                document.getElementById('addGroupScoreText').textContent = `+${scoreAmount}`;
                document.getElementById('subtractGroupScoreText').textContent = `-${scoreAmount}`;
            }

            // ä½œæ¥­ç®¡ç†ç›¸é—œæ–¹æ³•
            getHomeworkCount(studentId) {
                const homeworkList = this.homeworkNotes[studentId] || [];
                return homeworkList.length;
            }

            showHomeworkModal() {
                if (!this.currentSettingsStudent) return;
                
                const student = this.currentSettingsStudent;
                const modal = document.getElementById('homeworkModal');
                const studentName = document.getElementById('homeworkStudentName');
                const newHomeworkInput = document.getElementById('newHomeworkName');
                
                studentName.textContent = `${student.seatNumber}è™Ÿ ${student.name}`;
                newHomeworkInput.value = '';
                
                this.renderHomeworkList();
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideHomeworkModal() {
                document.getElementById('homeworkModal').classList.add('hidden');
                document.getElementById('homeworkModal').classList.remove('flex');
            }

            renderHomeworkList() {
                if (!this.currentSettingsStudent) return;
                
                const studentId = this.currentSettingsStudent.id;
                const container = document.getElementById('homeworkList');
                const homeworkList = this.homeworkNotes[studentId] || [];
                
                container.innerHTML = '';
                
                if (homeworkList.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-2">ç›®å‰æ²’æœ‰æœªäº¤ä½œæ¥­</div>';
                    return;
                }
                
                homeworkList.forEach((homework, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 bg-white rounded border';
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-yellow-600">â­</span>
                            <span class="text-sm">${homework.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">${homework.date}</span>
                            <button class="remove-homework px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600" data-index="${index}">
                                å·²äº¤
                            </button>
                        </div>
                    `;
                    
                    // æ·»åŠ ç§»é™¤æŒ‰éˆ•äº‹ä»¶
                    const removeBtn = div.querySelector('.remove-homework');
                    removeBtn.addEventListener('click', () => {
                        this.removeHomework(index);
                    });
                    
                    container.appendChild(div);
                });
            }

            addHomework() {
                if (!this.currentSettingsStudent) return;
                
                const input = document.getElementById('newHomeworkName');
                const homeworkName = input.value.trim();
                
                if (!homeworkName) {
                    alert('è«‹è¼¸å…¥ä½œæ¥­åç¨±');
                    return;
                }
                
                const studentId = this.currentSettingsStudent.id;
                
                if (!this.homeworkNotes[studentId]) {
                    this.homeworkNotes[studentId] = [];
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒä½œæ¥­
                const exists = this.homeworkNotes[studentId].some(hw => hw.name === homeworkName);
                if (exists) {
                    alert('æ­¤ä½œæ¥­å·²åœ¨æœªäº¤æ¸…å–®ä¸­');
                    return;
                }
                
                this.homeworkNotes[studentId].push({
                    name: homeworkName,
                    date: new Date().toLocaleDateString('zh-TW')
                });
                
                input.value = '';
                this.renderHomeworkList();
            }

            removeHomework(index) {
                if (!this.currentSettingsStudent) return;
                
                const studentId = this.currentSettingsStudent.id;
                const homeworkList = this.homeworkNotes[studentId] || [];
                
                if (index >= 0 && index < homeworkList.length) {
                    const homeworkName = homeworkList[index].name;
                    homeworkList.splice(index, 1);
                    
                    // å¦‚æœæ¸…å–®ç‚ºç©ºï¼Œåˆªé™¤æ•´å€‹è¨˜éŒ„
                    if (homeworkList.length === 0) {
                        delete this.homeworkNotes[studentId];
                    }
                    
                    this.renderHomeworkList();
                    
                    // é¡¯ç¤ºç¢ºèªè¨Šæ¯
                    alert(`å·²æ¨™è¨˜ã€Œ${homeworkName}ã€ç‚ºå·²äº¤ä½œæ¥­`);
                }
            }

            saveHomeworkNotes() {
                this.saveData();
                this.renderSeats(); // æ›´æ–°åº§ä½é¡¯ç¤ºçš„æ˜Ÿæ˜Ÿ
                this.hideHomeworkModal();
                
                const student = this.currentSettingsStudent;
                const homeworkCount = this.getHomeworkCount(student.id);
                
                if (homeworkCount > 0) {
                    alert(`${student.name}ç›®å‰æœ‰${homeworkCount}é …æœªäº¤ä½œæ¥­`);
                } else {
                    alert(`${student.name}ç›®å‰æ²’æœ‰æœªäº¤ä½œæ¥­`);
                }
            }

            // åŒ¯å‡ºå­¸ç”Ÿè³‡æ–™åˆ°Excel
            exportStudentsToExcel() {
                try {
                    // æº–å‚™è³‡æ–™
                    const data = [];
                    
                    // æ¨™é¡Œè¡Œ
                    data.push(['åº§è™Ÿ', 'å§“å', 'æ€§åˆ¥', 'ç©åˆ†']);
                    
                    // æŒ‰åº§è™Ÿæ’åºå­¸ç”Ÿ
                    const sortedStudents = [...this.students].sort((a, b) => a.seatNumber - b.seatNumber);
                    
                    // å­¸ç”Ÿè³‡æ–™
                    sortedStudents.forEach(student => {
                        const score = this.scores[student.id] || 0;
                        const gender = student.gender === 'male' ? 'ç”·' : 'å¥³';
                        data.push([student.seatNumber, student.name, gender, score]);
                    });
                    
                    // è½‰æ›ç‚ºCSVæ ¼å¼
                    const csvContent = data.map(row => 
                        row.map(cell => `"${cell}"`).join(',')
                    ).join('\n');
                    
                    // æ·»åŠ BOMä»¥æ”¯æ´ä¸­æ–‡
                    const BOM = '\uFEFF';
                    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                    
                    // å‰µå»ºä¸‹è¼‰é€£çµ
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    
                    // ç”Ÿæˆæª”æ¡ˆåç¨±ï¼ˆåŒ…å«æ—¥æœŸæ™‚é–“ï¼‰
                    const now = new Date();
                    const dateStr = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
                    
                    link.setAttribute('download', `å­¸ç”Ÿåå–®_${dateStr}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('å­¸ç”Ÿåå–®å·²åŒ¯å‡ºï¼æª”æ¡ˆæ ¼å¼ç‚ºCSVï¼Œå¯ç”¨Excelé–‹å•Ÿã€‚');
                    
                } catch (error) {
                    console.error('åŒ¯å‡ºå¤±æ•—:', error);
                    alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            }

            // åŒ¯å…¥å­¸ç”Ÿè³‡æ–™
            importStudentsFromExcel() {
                const fileInput = document.getElementById('fileInput');
                fileInput.click();
            }

            // è™•ç†æª”æ¡ˆé¸æ“‡
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        this.parseImportFile(content, file.name);
                    } catch (error) {
                        console.error('è®€å–æª”æ¡ˆå¤±æ•—:', error);
                        alert('è®€å–æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
                    }
                };
                
                // æ ¹æ“šæª”æ¡ˆé¡å‹é¸æ“‡è®€å–æ–¹å¼
                if (file.name.toLowerCase().endsWith('.csv')) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    alert('ç›®å‰åƒ…æ”¯æ´CSVæ ¼å¼æª”æ¡ˆã€‚è«‹å°‡Excelæª”æ¡ˆå¦å­˜ç‚ºCSVæ ¼å¼å¾Œå†åŒ¯å…¥ã€‚');
                }
                
                // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œå…è¨±é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
                event.target.value = '';
            }

            // è§£æåŒ¯å…¥æª”æ¡ˆ
            parseImportFile(content, fileName) {
                try {
                    // è§£æCSVå…§å®¹
                    const lines = content.split('\n').filter(line => line.trim());
                    if (lines.length < 2) {
                        alert('æª”æ¡ˆå…§å®¹ä¸è¶³ï¼Œè«‹ç¢ºèªæª”æ¡ˆåŒ…å«æ¨™é¡Œè¡Œå’Œè³‡æ–™è¡Œã€‚');
                        return;
                    }
                    
                    // è§£ææ¨™é¡Œè¡Œ
                    const headers = this.parseCSVLine(lines[0]);
                    
                    // æª¢æŸ¥å¿…è¦æ¬„ä½
                    const requiredFields = ['åº§è™Ÿ', 'å§“å'];
                    const missingFields = requiredFields.filter(field => 
                        !headers.some(header => header.includes(field))
                    );
                    
                    if (missingFields.length > 0) {
                        alert(`æª”æ¡ˆç¼ºå°‘å¿…è¦æ¬„ä½ï¼š${missingFields.join('ã€')}\nè«‹ç¢ºèªæª”æ¡ˆåŒ…å«ï¼šåº§è™Ÿã€å§“åã€æ€§åˆ¥ï¼ˆå¯é¸ï¼‰`);
                        return;
                    }
                    
                    // æ‰¾å‡ºæ¬„ä½ç´¢å¼•
                    const seatNumberIndex = headers.findIndex(h => h.includes('åº§è™Ÿ'));
                    const nameIndex = headers.findIndex(h => h.includes('å§“å'));
                    const genderIndex = headers.findIndex(h => h.includes('æ€§åˆ¥'));
                    const scoreIndex = headers.findIndex(h => h.includes('ç©åˆ†'));
                    
                    // è§£æå­¸ç”Ÿè³‡æ–™
                    const importedStudents = [];
                    const importedScores = {};
                    
                    for (let i = 1; i < lines.length; i++) {
                        const cells = this.parseCSVLine(lines[i]);
                        if (cells.length < 2) continue; // è·³éç©ºè¡Œæˆ–ä¸å®Œæ•´çš„è¡Œ
                        
                        const seatNumber = parseInt(cells[seatNumberIndex]);
                        const name = cells[nameIndex]?.trim();
                        
                        if (!seatNumber || !name) continue; // è·³éç„¡æ•ˆè³‡æ–™
                        
                        // æ€§åˆ¥è™•ç†
                        let gender = 'male'; // é è¨­ç”·ç”Ÿ
                        if (genderIndex >= 0 && cells[genderIndex]) {
                            const genderText = cells[genderIndex].trim();
                            if (genderText.includes('å¥³') || genderText.toLowerCase().includes('female')) {
                                gender = 'female';
                            }
                        }
                        
                        const student = {
                            seatNumber: seatNumber,
                            name: name,
                            gender: gender
                        };
                        
                        importedStudents.push(student);
                        
                        // ç©åˆ†è™•ç†
                        if (scoreIndex >= 0 && cells[scoreIndex]) {
                            const score = parseInt(cells[scoreIndex]) || 0;
                            importedScores[seatNumber] = score; // æš«æ™‚ç”¨åº§è™Ÿä½œç‚ºkey
                        }
                    }
                    
                    if (importedStudents.length === 0) {
                        alert('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å­¸ç”Ÿè³‡æ–™ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ã€‚');
                        return;
                    }
                    
                    // é¡¯ç¤ºé è¦½
                    this.showImportPreview(importedStudents, importedScores);
                    
                } catch (error) {
                    console.error('è§£ææª”æ¡ˆå¤±æ•—:', error);
                    alert('è§£ææª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
                }
            }

            // è§£æCSVè¡Œï¼ˆè™•ç†å¼•è™Ÿå’Œé€—è™Ÿï¼‰
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            // é›™å¼•è™Ÿè½‰ç¾©
                            current += '"';
                            i++; // è·³éä¸‹ä¸€å€‹å¼•è™Ÿ
                        } else {
                            // åˆ‡æ›å¼•è™Ÿç‹€æ…‹
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // æ¬„ä½åˆ†éš”ç¬¦
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // æ·»åŠ æœ€å¾Œä¸€å€‹æ¬„ä½
                result.push(current.trim());
                
                return result;
            }

            // é¡¯ç¤ºåŒ¯å…¥é è¦½
            showImportPreview(students, scores) {
                this.importData = { students, scores };
                
                const modal = document.getElementById('importModal');
                const preview = document.getElementById('importPreview');
                
                let previewHTML = `
                    <div class="text-sm">
                        <div class="mb-2 font-semibold">å°‡åŒ¯å…¥ ${students.length} ä½å­¸ç”Ÿï¼š</div>
                        <div class="grid grid-cols-4 gap-2 font-semibold text-gray-700 mb-2">
                            <div>åº§è™Ÿ</div>
                            <div>å§“å</div>
                            <div>æ€§åˆ¥</div>
                            <div>ç©åˆ†</div>
                        </div>
                `;
                
                students.slice(0, 10).forEach(student => { // åªé¡¯ç¤ºå‰10å€‹
                    const score = scores[student.seatNumber] || 0;
                    const genderText = student.gender === 'male' ? 'ç”·' : 'å¥³';
                    previewHTML += `
                        <div class="grid grid-cols-4 gap-2 py-1 border-b border-gray-200">
                            <div>${student.seatNumber}</div>
                            <div>${student.name}</div>
                            <div>${genderText}</div>
                            <div>${score}</div>
                        </div>
                    `;
                });
                
                if (students.length > 10) {
                    previewHTML += `<div class="text-center text-gray-500 mt-2">...é‚„æœ‰ ${students.length - 10} ä½å­¸ç”Ÿ</div>`;
                }
                
                previewHTML += '</div>';
                preview.innerHTML = previewHTML;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            // éš±è—åŒ¯å…¥æ¨¡æ…‹æ¡†
            hideImportModal() {
                document.getElementById('importModal').classList.add('hidden');
                document.getElementById('importModal').classList.remove('flex');
                this.importData = null;
            }

            // åˆå§‹åŒ–éŸ¿æ‡‰å¼è¨­è¨ˆ
            initializeResponsiveDesign() {
                // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
                window.addEventListener('resize', () => {
                    this.handleResponsiveResize();
                });
                
                // ç›£è½è£ç½®æ–¹å‘è®ŠåŒ–
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        this.handleResponsiveResize();
                    }, 100);
                });
                
                // åˆå§‹åŒ–æ™‚åŸ·è¡Œä¸€æ¬¡
                this.handleResponsiveResize();
                
                // æ·»åŠ è§¸æ§æ”¯æ´
                this.initializeTouchSupport();
            }

            // è™•ç†éŸ¿æ‡‰å¼èª¿æ•´
            handleResponsiveResize() {
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                // æ ¹æ“šè¢å¹•å¤§å°èª¿æ•´åº§ä½å€åŸŸ
                const seatingArea = document.getElementById('seatingArea');
                if (seatingArea) {
                    if (width <= 768) {
                        // æ‰‹æ©Ÿç‰ˆï¼šèª¿æ•´åº§ä½é–“è·
                        seatingArea.style.padding = '0.5rem';
                    } else if (width <= 1024) {
                        // å¹³æ¿ç‰ˆï¼šèª¿æ•´åº§ä½é–“è·
                        seatingArea.style.padding = '1rem';
                    } else {
                        // æ¡Œé¢ç‰ˆï¼šæ¢å¾©é è¨­é–“è·
                        seatingArea.style.padding = '1.5rem';
                    }
                }
                
                // èª¿æ•´å­¸ç”Ÿåå–®ç¶²æ ¼
                const studentList = document.getElementById('studentList');
                if (studentList) {
                    if (width <= 480) {
                        studentList.className = 'grid grid-cols-4 gap-2';
                    } else if (width <= 768) {
                        studentList.className = 'grid grid-cols-6 gap-2';
                    } else if (width <= 1024) {
                        studentList.className = 'grid grid-cols-5 gap-3';
                    } else {
                        studentList.className = 'grid grid-cols-5 gap-3';
                    }
                }
                
                // é‡æ–°æ¸²æŸ“åº§ä½ä»¥æ‡‰ç”¨æ–°çš„æ¨£å¼
                this.renderSeats();
            }

            // åˆå§‹åŒ–è§¸æ§æ”¯æ´
            initializeTouchSupport() {
                // ç‚ºè§¸æ§è£ç½®å„ªåŒ–æ‹–æ‹½é«”é©—
                let touchStartX, touchStartY;
                let isDragging = false;
                let dragElement = null;
                
                document.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                    
                    // æª¢æŸ¥æ˜¯å¦é»æ“Šåœ¨å¯æ‹–æ‹½å…ƒç´ ä¸Š
                    const element = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (element && (element.draggable || element.closest('[draggable="true"]'))) {
                        dragElement = element.closest('[draggable="true"]') || element;
                        isDragging = true;
                        e.preventDefault();
                    }
                }, { passive: false });
                
                document.addEventListener('touchmove', (e) => {
                    if (isDragging && dragElement) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        
                        // è¦–è¦ºåŒ–æ‹–æ‹½æ•ˆæœ
                        dragElement.style.opacity = '0.7';
                        dragElement.style.transform = 'scale(1.1)';
                    }
                }, { passive: false });
                
                document.addEventListener('touchend', (e) => {
                    if (isDragging && dragElement) {
                        const touch = e.changedTouches[0];
                        const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
                        
                        // æ¢å¾©å…ƒç´ æ¨£å¼
                        dragElement.style.opacity = '';
                        dragElement.style.transform = '';
                        
                        // è™•ç†æ”¾ç½®é‚è¼¯
                        if (dropTarget && dropTarget !== dragElement) {
                            this.handleTouchDrop(dragElement, dropTarget);
                        }
                        
                        isDragging = false;
                        dragElement = null;
                    }
                });
            }

            // è™•ç†è§¸æ§æ”¾ç½®
            handleTouchDrop(dragElement, dropTarget) {
                // æ‰¾åˆ°æœ€è¿‘çš„åº§ä½å…ƒç´ 
                const seatElement = dropTarget.closest('[data-position]') || 
                                  (dropTarget.dataset.position !== undefined ? dropTarget : null);
                
                if (seatElement && dragElement.dataset.studentId) {
                    // å­¸ç”Ÿæ‹–æ‹½åˆ°åº§ä½
                    const studentId = parseInt(dragElement.dataset.studentId);
                    const position = parseInt(seatElement.dataset.position);
                    this.assignStudentToSeat(studentId, position);
                } else if (seatElement && dragElement.dataset.position) {
                    // åº§ä½ä¹‹é–“çš„æ‹–æ‹½
                    const fromPosition = parseInt(dragElement.dataset.position);
                    const toPosition = parseInt(seatElement.dataset.position);
                    if (fromPosition !== toPosition) {
                        this.swapSeats(fromPosition, toPosition);
                    }
                }
            }

            // ç¢ºèªåŒ¯å…¥å­¸ç”Ÿè³‡æ–™
            confirmImportStudents() {
                if (!this.importData) return;
                
                const replaceAll = document.getElementById('replaceAllStudents').checked;
                const { students: importedStudents, scores: importedScores } = this.importData;
                
                try {
                    if (replaceAll) {
                        // æ›¿æ›æ¨¡å¼ï¼šæ¸…ç©ºç¾æœ‰è³‡æ–™
                        this.students = [];
                        this.scores = {};
                        this.scoreHistory = {};
                        
                        // æ¸…ç©ºæ‰€æœ‰åº§ä½
                        this.normalSeats = {};
                        this.groupSeats = {};
                        this.examSeats = {};
                        this.freeSeats = {};
                    }
                    
                    // æ·»åŠ åŒ¯å…¥çš„å­¸ç”Ÿ
                    let addedCount = 0;
                    let updatedCount = 0;
                    
                    importedStudents.forEach(importedStudent => {
                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåº§è™Ÿçš„å­¸ç”Ÿ
                        const existingIndex = this.students.findIndex(s => s.seatNumber === importedStudent.seatNumber);
                        
                        if (existingIndex >= 0) {
                            // æ›´æ–°ç¾æœ‰å­¸ç”Ÿ
                            const existingStudent = this.students[existingIndex];
                            existingStudent.name = importedStudent.name;
                            existingStudent.gender = importedStudent.gender;
                            
                            // æ›´æ–°ç©åˆ†
                            if (importedScores[importedStudent.seatNumber] !== undefined) {
                                this.scores[existingStudent.id] = importedScores[importedStudent.seatNumber];
                            }
                            
                            updatedCount++;
                        } else {
                            // æ–°å¢å­¸ç”Ÿ
                            const newId = Math.max(...this.students.map(s => s.id), 0) + 1;
                            const newStudent = {
                                id: newId,
                                seatNumber: importedStudent.seatNumber,
                                name: importedStudent.name,
                                gender: importedStudent.gender
                            };
                            
                            // æ’å…¥åˆ°æ­£ç¢ºä½ç½®ï¼ˆæŒ‰åº§è™Ÿæ’åºï¼‰
                            let insertIndex = this.students.length;
                            for (let i = 0; i < this.students.length; i++) {
                                if (this.students[i].seatNumber > importedStudent.seatNumber) {
                                    insertIndex = i;
                                    break;
                                }
                            }
                            this.students.splice(insertIndex, 0, newStudent);
                            
                            // è¨­å®šç©åˆ†
                            if (importedScores[importedStudent.seatNumber] !== undefined) {
                                this.scores[newId] = importedScores[importedStudent.seatNumber];
                            }
                            
                            addedCount++;
                        }
                    });
                    
                    // ä¿å­˜è³‡æ–™ä¸¦æ›´æ–°é¡¯ç¤º
                    this.saveData();
                    this.renderStudentList();
                    this.renderSeats();
                    this.hideImportModal();
                    
                    // é¡¯ç¤ºçµæœ
                    let message = 'åŒ¯å…¥å®Œæˆï¼\n';
                    if (replaceAll) {
                        message += `å·²æ›¿æ›æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œå…±åŒ¯å…¥ ${importedStudents.length} ä½å­¸ç”Ÿã€‚`;
                    } else {
                        message += `æ–°å¢ ${addedCount} ä½å­¸ç”Ÿï¼Œæ›´æ–° ${updatedCount} ä½å­¸ç”Ÿè³‡æ–™ã€‚`;
                    }
                    
                    alert(message);
                    
                } catch (error) {
                    console.error('åŒ¯å…¥å¤±æ•—:', error);
                    alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            }
        }

        // åˆå§‹åŒ–ç³»çµ±
        const classroom = new ClassroomManager();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98c6bd24d03cf20d',t:'MTc2MDEwNTgyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
