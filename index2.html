<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å®¤åº§ä½å®‰æ’ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .drop-zone {
            border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .seat {
            transition: all 0.3s ease;
        }
        .seat:hover {
            transform: scale(1.05);
        }
        .score-popup {
            animation: scoreUp 1s ease-out;
        }
        @keyframes scoreUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.2); opacity: 0; }
        }
        .lottery-flash {
            animation: lotteryFlash 0.3s ease-in-out infinite;
        }
        @keyframes lotteryFlash {
            0%, 100% { background-color: #fbbf24; border-color: #f59e0b; }
            50% { background-color: #f97316; border-color: #ea580c; }
        }
        .lottery-selected {
            background-color: rgba(239, 68, 68, 0.8) !important;
            border: 2px solid #ef4444 !important;
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7) !important;
        }
        .timer-warning {
            animation: timerWarning 1s ease-in-out infinite;
        }
        @keyframes timerWarning {
            0%, 100% { color: #ef4444; }
            50% { color: #dc2626; }
        }
        .timer-critical {
            animation: timerCritical 0.5s ease-in-out infinite;
        }
        @keyframes timerCritical {
            0%, 100% { 
                color: #dc2626; 
                transform: scale(1);
            }
            50% { 
                color: #b91c1c; 
                transform: scale(1.05);
            }
        }
        .free-seat {
            position: absolute;
            cursor: move;
            user-select: none;
            z-index: 10;
        }
        .free-seat:hover {
            transform: scale(1.05);
            z-index: 20;
        }
        .free-seat.dragging {
            opacity: 0.7;
            transform: rotate(5deg) scale(1.1);
            z-index: 30;
        }
        .free-mode-area {
            position: relative;
            min-height: 500px;
            background: linear-gradient(45deg, #f8fafc 25%, transparent 25%), 
                        linear-gradient(-45deg, #f8fafc 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f8fafc 75%), 
                        linear-gradient(-45deg, transparent 75%, #f8fafc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto p-3 sm:p-4 lg:p-6">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-4 lg:mb-8">
            <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 mb-3 lg:mb-4">
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-800">æ•™å®¤åº§ä½å®‰æ’ç³»çµ±</h1>
                <div class="flex items-center gap-2">
                    <div class="relative">
                        <button id="classSelector" class="px-3 sm:px-4 py-1 sm:py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 shadow-lg text-sm sm:text-base">
                            <span id="currentClassName">101</span>
                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="classDropdown" class="absolute top-full left-0 mt-2 w-40 sm:w-48 bg-white rounded-lg shadow-xl border border-gray-200 z-50 hidden max-h-64 overflow-y-auto">
                            <!-- ç­ç´šåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    <button id="manageClasses" class="px-2 sm:px-3 py-1 sm:py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-xs sm:text-sm">
                        ç­ç´šç®¡ç†
                    </button>
                </div>
            </div>
            <p class="text-sm sm:text-base text-gray-600">ç·¨è¼¯å­¸ç”Ÿè³‡æ–™ã€å®‰æ’åº§ä½ã€ç®¡ç†çå‹µç©åˆ†</p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-white rounded-lg shadow-lg p-3 lg:p-6 mb-4 lg:mb-6">
            <div class="flex flex-col lg:flex-row gap-3 lg:gap-4 items-start lg:items-center lg:justify-between">
                <!-- æ¨¡å¼é¸æ“‡ -->
                <div class="flex flex-wrap gap-1 sm:gap-2 w-full lg:w-auto">
                    <button id="normalMode" class="px-2 sm:px-4 py-1 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-xs sm:text-sm">
                        ä¸€èˆ¬åº§ä½
                    </button>
                    <button id="groupMode" class="px-2 sm:px-4 py-1 sm:py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors text-xs sm:text-sm">
                        å°çµ„åº§ä½
                    </button>
                    <button id="examMode" class="px-2 sm:px-4 py-1 sm:py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors text-xs sm:text-sm">
                        è€ƒè©¦åº§ä½
                    </button>
                    <button id="freeMode" class="px-2 sm:px-4 py-1 sm:py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors text-xs sm:text-sm">
                        ç©ºç™½åº§ä½
                    </button>
                </div>
                
                <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
                <div class="flex flex-wrap gap-1 sm:gap-2 items-center w-full lg:w-auto">
                    <button id="studentView" class="px-2 sm:px-4 py-1 sm:py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors text-xs sm:text-sm">
                        å­¸ç”Ÿè¦–è§’
                    </button>
                    <button id="showScores" class="px-2 sm:px-4 py-1 sm:py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-xs sm:text-sm">
                        æŸ¥çœ‹ç©åˆ†
                    </button>
                    <button id="showTimer" class="px-2 sm:px-4 py-1 sm:py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors text-xs sm:text-sm">
                        è¨ˆæ™‚å™¨
                    </button>
                    
                    <!-- åˆ†éš”ç·š -->
                    <div class="hidden sm:block h-6 w-px bg-gray-300 mx-1"></div>
                    
                    <!-- æŠ½ç±¤åŠŸèƒ½å€ -->
                    <div class="flex gap-1 flex-wrap">
                        <button id="drawAll" class="px-2 sm:px-3 py-1 sm:py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors text-xs">
                            å…¨éƒ¨æŠ½ç±¤
                        </button>
                        <button id="drawMale" class="px-2 sm:px-3 py-1 sm:py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-xs">
                            ç”·ç”ŸæŠ½ç±¤
                        </button>
                        <button id="drawFemale" class="px-2 sm:px-3 py-1 sm:py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-colors text-xs">
                            å¥³ç”ŸæŠ½ç±¤
                        </button>
                        <button id="clearSelection" class="px-2 sm:px-3 py-1 sm:py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-xs hidden">
                            å–æ¶ˆæ¨™è¨˜
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="grid grid-cols-1 xl:grid-cols-5 gap-4 lg:gap-6">
            <!-- å­¸ç”Ÿåå–® -->
            <div class="xl:col-span-1 order-2 xl:order-1">
                <div class="bg-white rounded-lg shadow-lg p-3 lg:p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm lg:text-base font-semibold text-gray-800">å­¸ç”Ÿåå–®</h3>
                        <div class="flex gap-1">
                            <button id="batchSetup" class="px-2 py-1 bg-teal-500 text-white rounded text-xs hover:bg-teal-600 transition-colors">
                                æ‰¹é‡è¨­å®š
                            </button>
                            <button id="editStudents" class="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors">
                                ç·¨è¼¯å­¸ç”Ÿ
                            </button>
                        </div>
                    </div>
                    <div id="studentList" class="space-y-1 max-h-[20rem] xl:max-h-[28rem] overflow-y-auto">
                        <!-- å­¸ç”Ÿåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æ•™å®¤åº§ä½å€åŸŸ -->
            <div class="xl:col-span-4 order-1 xl:order-2">
                <div class="bg-white rounded-lg shadow-lg p-3 lg:p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3">
                            <h3 class="text-base lg:text-lg font-semibold text-gray-800">æ•™å®¤åº§ä½åœ–</h3>
                            <button id="resetSeats" class="px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-xs sm:text-sm">
                                é‡ç½®åº§ä½
                            </button>
                        </div>
                        <div class="text-xs sm:text-sm text-gray-600">
                            <span id="currentMode">ä¸€èˆ¬åº§ä½æ¨¡å¼</span>
                        </div>
                    </div>
                    
                    <!-- è¬›å°ï¼ˆå­¸ç”Ÿè¦–è§’æ™‚åœ¨ä¸Šæ–¹ï¼‰ -->
                    <div id="podiumTop" class="bg-gray-800 text-white text-center py-2 lg:py-3 rounded-lg mb-4 lg:mb-6 hidden">
                        <span class="text-sm lg:text-lg font-semibold">è¬›å°</span>
                    </div>

                    <!-- åº§ä½å€åŸŸ -->
                    <div id="seatingArea" class="min-h-[20rem] sm:min-h-[24rem] lg:min-h-96 border-2 border-dashed border-gray-300 rounded-lg p-2 lg:p-4 mb-4 lg:mb-6">
                        <!-- åº§ä½å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </div>

                    <!-- è¬›å°ï¼ˆè€å¸«è¦–è§’æ™‚åœ¨ä¸‹æ–¹ï¼‰ -->
                    <div id="podiumBottom" class="bg-gray-800 text-white text-center py-2 lg:py-3 rounded-lg">
                        <span class="text-sm lg:text-lg font-semibold">è¬›å°</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å­¸ç”Ÿæ¨¡æ…‹æ¡† -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">ç·¨è¼¯å­¸ç”Ÿè³‡æ–™</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åº§è™Ÿ</label>
                    <input id="editSeatNumber" type="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å§“å</label>
                    <input id="editStudentName" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                    <select id="editStudentGender" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="male">ç”·ç”Ÿ ğŸ”µ</option>
                        <option value="female">å¥³ç”Ÿ ğŸ”´</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button id="saveStudent" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ä¿å­˜
                    </button>
                    <button id="deleteStudent" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        åˆªé™¤
                    </button>
                    <button id="cancelEdit" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ æ¸›åˆ†æ¨¡æ…‹æ¡† -->
    <div id="scoreModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">èª¿æ•´ç©åˆ†</h3>
            <div class="text-center mb-4">
                <span id="scoreStudentName" class="text-xl font-bold text-gray-800"></span>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2 justify-center">
                    <button id="addScoreBtn" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 text-lg font-semibold">
                        +1 åŠ åˆ†
                    </button>
                    <button id="subtractScoreBtn" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 text-lg font-semibold">
                        -1 æ‰£åˆ†
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åŸå› èªªæ˜</label>
                    <div class="mb-3">
                        <div class="text-xs text-gray-600 mb-2">å¿«é€Ÿé¸æ“‡ï¼š</div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors border border-green-300">
                                å›ç­”å•é¡Œ
                            </button>
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors border border-green-300">
                                å¹«è€å¸«å¿™
                            </button>
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors border border-red-300">
                                ä¸Šèª²èŠå¤©
                            </button>
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors border border-red-300">
                                ç½µé«’è©±
                            </button>
                            <button type="button" class="reason-btn px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors border border-red-300">
                                ä½œæ¥­æ²’å¯«
                            </button>
                        </div>
                    </div>
                    <textarea id="scoreReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="3" placeholder="è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button id="confirmScore" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ç¢ºèª
                    </button>
                    <button id="cancelScore" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç©åˆ†æŸ¥çœ‹æ¨¡æ…‹æ¡† -->
    <div id="scoresModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold mb-4">å­¸ç”Ÿç©åˆ†æ’è¡Œ</h3>
            <div id="scoresList" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- ç©åˆ†åˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
            <div class="mt-4 flex gap-2">
                <button id="resetScores" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    é‡ç½®æ‰€æœ‰ç©åˆ†
                </button>
                <button id="closeScores" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- ç©åˆ†æ­·å²æ¨¡æ…‹æ¡† -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold mb-4">ç©åˆ†æ­·å²è¨˜éŒ„</h3>
            <div class="text-center mb-4">
                <span id="historyStudentName" class="text-xl font-bold text-gray-800"></span>
                <span id="historyTotalScore" class="ml-2 text-lg text-blue-600 font-semibold"></span>
            </div>
            <div id="historyList" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- æ­·å²è¨˜éŒ„å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
            <div class="mt-4 flex gap-2">
                <button id="closeHistory" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿè¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="studentSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">å­¸ç”Ÿè¨­å®š</h3>
            <div class="text-center mb-4">
                <span id="settingsStudentName" class="text-xl font-bold text-gray-800"></span>
                <span id="settingsStudentScore" class="ml-2 text-lg text-blue-600 font-semibold"></span>
            </div>
            
            <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
            <div class="space-y-3">
                <!-- åŠ æ¸›åˆ†å€åŸŸ -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">ç©åˆ†èª¿æ•´</h4>
                    <div class="flex gap-2 justify-center mb-3">
                        <button id="settingsAddScore" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm font-semibold">
                            +1 åŠ åˆ†
                        </button>
                        <button id="settingsSubtractScore" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-semibold">
                            -1 æ‰£åˆ†
                        </button>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">åŸå› èªªæ˜</label>
                        <textarea id="settingsScoreReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm" rows="2" placeholder="è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ..."></textarea>
                    </div>
                </div>
                
                <!-- å…¶ä»–åŠŸèƒ½ -->
                <div class="flex gap-2">
                    <button id="settingsViewHistory" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                        çæ‡²ç´€éŒ„
                    </button>
                    <button id="settingsEditStudent" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm">
                        ç·¨è¼¯è³‡æ–™
                    </button>
                </div>
                
                <!-- é—œé–‰æŒ‰éˆ• -->
                <div class="flex gap-2 pt-2">
                    <button id="settingsConfirmScore" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm hidden">
                        ç¢ºèªç©åˆ†
                    </button>
                    <button id="closeStudentSettings" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 text-sm">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­ç´šç®¡ç†æ¨¡æ…‹æ¡† -->
    <div id="classModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-lg font-semibold mb-4">ç­ç´šç®¡ç†</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-medium text-gray-700">ç­ç´šåˆ—è¡¨</label>
                        <button id="addNewClass" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors">
                            + æ–°å¢ç­ç´š
                        </button>
                    </div>
                    <div id="classManageList" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3">
                        <!-- ç­ç´šç®¡ç†åˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="text-sm text-blue-800">
                        <strong>æç¤ºï¼š</strong>æ¯å€‹ç­ç´šçš„è³‡æ–™éƒ½æ˜¯ç¨ç«‹ä¿å­˜çš„ï¼Œåˆ‡æ›ç­ç´šä¸æœƒå½±éŸ¿å…¶ä»–ç­ç´šçš„è³‡æ–™ã€‚
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="closeClassModal" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯ç­ç´šæ¨¡æ…‹æ¡† -->
    <div id="classEditModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 id="classEditTitle" class="text-lg font-semibold mb-4">æ–°å¢ç­ç´š</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç­ç´šåç¨±</label>
                    <input id="classNameInput" type="text" placeholder="ä¾‹å¦‚ï¼š106" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-2">
                    <button id="saveClass" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ä¿å­˜
                    </button>
                    <button id="cancelClassEdit" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡è¨­å®šæ¨¡æ…‹æ¡† -->
    <div id="batchModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">æ‰¹é‡è¨­å®šå­¸ç”Ÿ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç¸½å­¸ç”Ÿæ•¸é‡</label>
                    <input id="totalStudents" type="number" min="1" max="50" value="35" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”·ç”Ÿåº§è™Ÿç¯„åœ</label>
                    <div class="flex gap-2 items-center">
                        <input id="maleStart" type="number" min="1" value="1" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-500">åˆ°</span>
                        <input id="maleEnd" type="number" min="1" value="15" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm text-gray-600">è™Ÿ</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¥³ç”Ÿåº§è™Ÿç¯„åœ</label>
                    <div class="flex gap-2 items-center">
                        <input id="femaleStart" type="number" min="1" value="21" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-500">åˆ°</span>
                        <input id="femaleEnd" type="number" min="1" value="35" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm text-gray-600">è™Ÿ</span>
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div class="text-sm text-yellow-800">
                        <strong>æ³¨æ„ï¼š</strong>æ­¤æ“ä½œæœƒé‡ç½®æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ã€åº§ä½å®‰æ’å’Œç©åˆ†è¨˜éŒ„ï¼
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="confirmBatch" class="flex-1 px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600">
                        ç¢ºèªè¨­å®š
                    </button>
                    <button id="cancelBatch" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨ˆæ™‚å™¨æ¨¡æ…‹æ¡† -->
    <div id="timerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">å€’æ•¸è¨ˆæ™‚å™¨</h3>
            <div class="space-y-4">
                <!-- è¨ˆæ™‚å™¨é¡¯ç¤º -->
                <div class="text-center">
                    <div id="timerDisplay" class="text-6xl font-mono font-bold text-gray-800 mb-4">00:00</div>
                    <div id="timerStatus" class="text-lg text-gray-600 mb-4">è¨ˆæ™‚å™¨å·²åœæ­¢</div>
                </div>
                
                <!-- æ™‚é–“è¨­å®š -->
                <div id="timerSettings" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å®šæ™‚é–“</label>
                        <div class="flex gap-2 items-center justify-center">
                            <input id="timerMinutes" type="number" min="0" max="59" value="5" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">åˆ†</span>
                            <input id="timerSeconds" type="number" min="0" max="59" value="0" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-600">ç§’</span>
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿè¨­å®šæŒ‰éˆ• -->
                    <div class="grid grid-cols-4 gap-2">
                        <button class="quick-time-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm" data-minutes="1" data-seconds="0">1åˆ†</button>
                        <button class="quick-time-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm" data-minutes="3" data-seconds="0">3åˆ†</button>
                        <button class="quick-time-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm" data-minutes="5" data-seconds="0">5åˆ†</button>
                        <button class="quick-time-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm" data-minutes="10" data-seconds="0">10åˆ†</button>
                        <button class="quick-time-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm" data-minutes="15" data-seconds="0">15åˆ†</button>
                        <button class="quick-time-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm" data-minutes="20" data-seconds="0">20åˆ†</button>
                        <button class="quick-time-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm" data-minutes="30" data-seconds="0">30åˆ†</button>
                        <button class="quick-time-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm" data-minutes="45" data-seconds="0">45åˆ†</button>
                    </div>
                </div>
                
                <!-- æ§åˆ¶æŒ‰éˆ• -->
                <div class="flex gap-2">
                    <button id="startTimer" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        é–‹å§‹
                    </button>
                    <button id="pauseTimer" class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors hidden">
                        æš«åœ
                    </button>
                    <button id="resumeTimer" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors hidden">
                        ç¹¼çºŒ
                    </button>
                    <button id="stopTimer" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        åœæ­¢
                    </button>
                    <button id="closeTimer" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                        é—œé–‰
                    </button>
                </div>
                
                <!-- æç¤ºè¨Šæ¯ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="text-sm text-blue-800">
                        <strong>æç¤ºï¼š</strong>æ™‚é–“åˆ°æ™‚æœƒæ’­æ”¾éŸ¿éˆ´æé†’ï¼Œä¸¦é¡¯ç¤ºæ™‚é–“åˆ°çš„é€šçŸ¥ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ClassroomManager {
            constructor() {
                this.classes = this.loadClasses();
                this.currentClass = this.loadCurrentClass();
                this.students = this.loadStudents();
                this.currentMode = 'normal'; // 'normal', 'group', or 'exam'
                this.normalSeats = this.loadSeats('normal');
                this.groupSeats = this.loadSeats('group');
                this.examSeats = this.loadSeats('exam');
                this.freeSeats = this.loadSeats('free');
                this.scores = this.loadScores();
                this.scoreHistory = this.loadScoreHistory();
                this.editingStudent = null;
                this.currentScoreStudent = null;
                this.currentSettingsStudent = null; // å­¸ç”Ÿè¨­å®šæ¨¡æ…‹æ¡†ä¸­çš„å­¸ç”Ÿ
                this.selectedSettingsScoreType = null; // å­¸ç”Ÿè¨­å®šä¸­é¸æ“‡çš„åŠ æ¸›åˆ†é¡å‹
                this.isStudentView = false;
                this.selectedStudent = null; // æŠ½ç±¤é¸ä¸­çš„å­¸ç”Ÿ
                this.isLotteryRunning = false; // æŠ½ç±¤å‹•ç•«é€²è¡Œä¸­
                this.editingClass = null; // æ­£åœ¨ç·¨è¼¯çš„ç­ç´š
                
                // è¨ˆæ™‚å™¨ç›¸é—œè®Šæ•¸
                this.timerInterval = null;
                this.timerRemaining = 0; // å‰©é¤˜ç§’æ•¸
                this.timerRunning = false;
                this.timerPaused = false;
                
                this.initializeEventListeners();
                this.renderClassSelector();
                this.renderStudentList();
                this.renderSeats();
            }

            loadClasses() {
                const saved = localStorage.getItem('classroom_classes');
                if (saved) {
                    return JSON.parse(saved);
                }
                // é è¨­ç­ç´š
                return [
                    { id: 'class_1', name: '101' },
                    { id: 'class_2', name: '102' },
                    { id: 'class_3', name: '103' },
                    { id: 'class_4', name: '104' },
                    { id: 'class_5', name: '105' }
                ];
            }

            loadCurrentClass() {
                const saved = localStorage.getItem('classroom_current_class');
                return saved || 'class_1';
            }

            loadStudents() {
                const saved = localStorage.getItem(`classroom_students_${this.currentClass}`);
                if (saved) {
                    return JSON.parse(saved);
                }
                // é è¨­å­¸ç”Ÿè³‡æ–™ï¼šç”·ç”Ÿ1-15è™Ÿï¼Œå¥³ç”Ÿ20-35è™Ÿ
                const defaultStudents = [];
                
                // ç”·ç”Ÿ 1-15è™Ÿ
                for (let i = 1; i <= 15; i++) {
                    defaultStudents.push({
                        id: i,
                        seatNumber: i,
                        name: `å­¸ç”Ÿ${i}`,
                        gender: 'male'
                    });
                }
                
                // å¥³ç”Ÿ 21-35è™Ÿ
                for (let i = 21; i <= 35; i++) {
                    defaultStudents.push({
                        id: i,
                        seatNumber: i,
                        name: `å­¸ç”Ÿ${i}`,
                        gender: 'female'
                    });
                }
                
                return defaultStudents;
            }

            loadSeats(mode) {
                const saved = localStorage.getItem(`classroom_seats_${mode}_${this.currentClass}`);
                return saved ? JSON.parse(saved) : {};
            }

            loadScores() {
                const saved = localStorage.getItem(`classroom_scores_${this.currentClass}`);
                return saved ? JSON.parse(saved) : {};
            }

            loadScoreHistory() {
                const saved = localStorage.getItem(`classroom_score_history_${this.currentClass}`);
                return saved ? JSON.parse(saved) : {};
            }

            saveData() {
                localStorage.setItem('classroom_classes', JSON.stringify(this.classes));
                localStorage.setItem('classroom_current_class', this.currentClass);
                localStorage.setItem(`classroom_students_${this.currentClass}`, JSON.stringify(this.students));
                localStorage.setItem(`classroom_seats_${this.currentMode}_${this.currentClass}`, JSON.stringify(this.getCurrentSeats()));
                localStorage.setItem(`classroom_scores_${this.currentClass}`, JSON.stringify(this.scores));
                localStorage.setItem(`classroom_score_history_${this.currentClass}`, JSON.stringify(this.scoreHistory));
            }

            getCurrentSeats() {
                if (this.currentMode === 'normal') return this.normalSeats;
                if (this.currentMode === 'group') return this.groupSeats;
                if (this.currentMode === 'exam') return this.examSeats;
                return this.freeSeats;
            }

            initializeEventListeners() {
                // ç­ç´šé¸æ“‡å™¨
                document.getElementById('classSelector').addEventListener('click', () => this.toggleClassDropdown());
                
                // æ¨¡å¼åˆ‡æ›
                document.getElementById('normalMode').addEventListener('click', () => this.switchMode('normal'));
                document.getElementById('groupMode').addEventListener('click', () => this.switchMode('group'));
                document.getElementById('examMode').addEventListener('click', () => this.switchMode('exam'));
                document.getElementById('freeMode').addEventListener('click', () => this.switchMode('free'));

                // æ§åˆ¶æŒ‰éˆ•
                document.getElementById('studentView').addEventListener('click', () => this.toggleStudentView());
                document.getElementById('editStudents').addEventListener('click', () => this.showEditModal());
                document.getElementById('resetSeats').addEventListener('click', () => this.resetSeats());
                document.getElementById('showScores').addEventListener('click', () => this.showScoresModal());
                document.getElementById('manageClasses').addEventListener('click', () => this.showClassModal());

                // æŠ½ç±¤æŒ‰éˆ•
                document.getElementById('drawAll').addEventListener('click', () => this.startLottery('all'));
                document.getElementById('drawMale').addEventListener('click', () => this.startLottery('male'));
                document.getElementById('drawFemale').addEventListener('click', () => this.startLottery('female'));
                document.getElementById('clearSelection').addEventListener('click', () => this.clearSelection());

                // ç·¨è¼¯æ¨¡æ…‹æ¡†
                document.getElementById('saveStudent').addEventListener('click', () => this.saveStudent());
                document.getElementById('deleteStudent').addEventListener('click', () => this.deleteStudent());
                document.getElementById('cancelEdit').addEventListener('click', () => this.hideEditModal());

                // ç©åˆ†æ¨¡æ…‹æ¡†
                document.getElementById('resetScores').addEventListener('click', () => this.resetAllScores());
                document.getElementById('closeScores').addEventListener('click', () => this.hideScoresModal());

                // åŠ æ¸›åˆ†æ¨¡æ…‹æ¡†
                document.getElementById('addScoreBtn').addEventListener('click', () => this.selectScoreType(1));
                document.getElementById('subtractScoreBtn').addEventListener('click', () => this.selectScoreType(-1));
                document.getElementById('confirmScore').addEventListener('click', () => this.confirmScore());
                document.getElementById('cancelScore').addEventListener('click', () => this.hideScoreModal());

                // ç©åˆ†æ­·å²æ¨¡æ…‹æ¡†
                document.getElementById('closeHistory').addEventListener('click', () => this.hideHistoryModal());

                // å­¸ç”Ÿè¨­å®šæ¨¡æ…‹æ¡†
                document.getElementById('settingsAddScore').addEventListener('click', () => this.selectSettingsScoreType(1));
                document.getElementById('settingsSubtractScore').addEventListener('click', () => this.selectSettingsScoreType(-1));
                document.getElementById('settingsConfirmScore').addEventListener('click', () => this.confirmSettingsScore());
                document.getElementById('settingsViewHistory').addEventListener('click', () => this.viewHistoryFromSettings());
                document.getElementById('settingsEditStudent').addEventListener('click', () => this.editStudentFromSettings());
                document.getElementById('closeStudentSettings').addEventListener('click', () => this.hideStudentSettingsModal());

                // ç­ç´šç®¡ç†æ¨¡æ…‹æ¡†
                document.getElementById('closeClassModal').addEventListener('click', () => this.hideClassModal());
                document.getElementById('addNewClass').addEventListener('click', () => this.showClassEditModal());
                document.getElementById('saveClass').addEventListener('click', () => this.saveClass());
                document.getElementById('cancelClassEdit').addEventListener('click', () => this.hideClassEditModal());

                // æ‰¹é‡è¨­å®šæ¨¡æ…‹æ¡†
                document.getElementById('batchSetup').addEventListener('click', () => this.showBatchModal());
                document.getElementById('confirmBatch').addEventListener('click', () => this.confirmBatchSetup());
                document.getElementById('cancelBatch').addEventListener('click', () => this.hideBatchModal());

                // è¨ˆæ™‚å™¨æ¨¡æ…‹æ¡†
                document.getElementById('showTimer').addEventListener('click', () => this.showTimerModal());
                document.getElementById('startTimer').addEventListener('click', () => this.startTimer());
                document.getElementById('pauseTimer').addEventListener('click', () => this.pauseTimer());
                document.getElementById('resumeTimer').addEventListener('click', () => this.resumeTimer());
                document.getElementById('stopTimer').addEventListener('click', () => this.stopTimer());
                document.getElementById('closeTimer').addEventListener('click', () => this.hideTimerModal());

                // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
                document.getElementById('editModal').addEventListener('click', (e) => {
                    if (e.target.id === 'editModal') this.hideEditModal();
                });
                document.getElementById('scoresModal').addEventListener('click', (e) => {
                    if (e.target.id === 'scoresModal') this.hideScoresModal();
                });
                document.getElementById('scoreModal').addEventListener('click', (e) => {
                    if (e.target.id === 'scoreModal') this.hideScoreModal();
                });
                document.getElementById('historyModal').addEventListener('click', (e) => {
                    if (e.target.id === 'historyModal') this.hideHistoryModal();
                });
                document.getElementById('batchModal').addEventListener('click', (e) => {
                    if (e.target.id === 'batchModal') this.hideBatchModal();
                });
                document.getElementById('classModal').addEventListener('click', (e) => {
                    if (e.target.id === 'classModal') this.hideClassModal();
                });
                document.getElementById('classEditModal').addEventListener('click', (e) => {
                    if (e.target.id === 'classEditModal') this.hideClassEditModal();
                });
                document.getElementById('timerModal').addEventListener('click', (e) => {
                    if (e.target.id === 'timerModal') this.hideTimerModal();
                });
                document.getElementById('studentSettingsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'studentSettingsModal') this.hideStudentSettingsModal();
                });

                // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰ä¸‹æ‹‰é¸å–®
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#classSelector') && !e.target.closest('#classDropdown')) {
                        this.hideClassDropdown();
                    }
                });
            }

            toggleStudentView() {
                this.isStudentView = !this.isStudentView;
                
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼å’Œæ–‡å­—
                const button = document.getElementById('studentView');
                const podiumTop = document.getElementById('podiumTop');
                const podiumBottom = document.getElementById('podiumBottom');
                
                if (this.isStudentView) {
                    button.className = 'px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors';
                    button.textContent = 'è€å¸«è¦–è§’';
                    // å­¸ç”Ÿè¦–è§’ï¼šè¬›å°åœ¨ä¸Šæ–¹
                    podiumTop.classList.remove('hidden');
                    podiumBottom.classList.add('hidden');
                } else {
                    button.className = 'px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors';
                    button.textContent = 'å­¸ç”Ÿè¦–è§’';
                    // è€å¸«è¦–è§’ï¼šè¬›å°åœ¨ä¸‹æ–¹
                    podiumTop.classList.add('hidden');
                    podiumBottom.classList.remove('hidden');
                }
                
                this.renderSeats();
            }

            switchMode(mode) {
                this.saveData(); // ä¿å­˜ç•¶å‰æ¨¡å¼çš„åº§ä½
                this.currentMode = mode;
                
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼
                const activeClass = 'px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors';
                const inactiveClass = 'px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors';
                
                document.getElementById('normalMode').className = mode === 'normal' ? activeClass : inactiveClass;
                document.getElementById('groupMode').className = mode === 'group' ? activeClass : inactiveClass;
                document.getElementById('examMode').className = mode === 'exam' ? activeClass : inactiveClass;
                document.getElementById('freeMode').className = mode === 'free' ? activeClass : inactiveClass;

                const modeNames = {
                    'normal': 'ä¸€èˆ¬åº§ä½æ¨¡å¼',
                    'group': 'å°çµ„åº§ä½æ¨¡å¼',
                    'exam': 'è€ƒè©¦åº§ä½æ¨¡å¼',
                    'free': 'ç©ºç™½åº§ä½æ¨¡å¼'
                };
                document.getElementById('currentMode').textContent = modeNames[mode];
                
                this.renderSeats();
            }

            renderStudentList() {
                const container = document.getElementById('studentList');
                container.innerHTML = '';

                // å‰µå»ºå­¸ç”Ÿç¶²æ ¼å®¹å™¨
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid grid-cols-5 gap-2 mb-3';

                // æŒ‰åº§è™Ÿæ’åºå­¸ç”Ÿ
                const sortedStudents = [...this.students].sort((a, b) => a.seatNumber - b.seatNumber);

                // å‰µå»º40å€‹ä½ç½®çš„ç¶²æ ¼
                for (let i = 1; i <= 40; i++) {
                    const student = sortedStudents.find(s => s.seatNumber === i);
                    
                    if (student) {
                        // æœ‰å­¸ç”Ÿçš„ä½ç½®
                        const div = document.createElement('div');
                        div.className = 'w-16 h-16 border border-gray-300 rounded flex flex-col items-center justify-center text-xs cursor-move hover:border-blue-400 transition-colors bg-gray-50 hover:bg-gray-100';
                        div.draggable = true;
                        div.dataset.studentId = student.id;
                        
                        const genderDot = student.gender === 'male' ? 'ğŸ”µ' : 'ğŸ”´';
                        
                        div.innerHTML = `
                            <div class="font-semibold text-xs">${student.seatNumber}</div>
                            <div class="text-xs truncate w-full text-center px-1">${student.name.substring(0, 2)}</div>
                            <div class="text-xs">${genderDot}</div>
                        `;
                        
                        // æ‹–æ‹½äº‹ä»¶
                        div.addEventListener('dragstart', (e) => {
                            e.dataTransfer.setData('text/plain', `student:${student.id}`);
                            div.classList.add('dragging');
                        });
                        
                        div.addEventListener('dragend', (e) => {
                            div.classList.remove('dragging');
                        });
                        
                        // é›™æ“Šäº‹ä»¶é–‹å•Ÿå­¸ç”Ÿè¨­å®š
                        div.addEventListener('dblclick', (e) => {
                            e.stopPropagation();
                            this.showStudentSettingsModal(student);
                        });
                        
                        gridContainer.appendChild(div);
                    } else {
                        // ç©ºä½ç½®
                        const div = document.createElement('div');
                        div.className = 'w-16 h-16 border border-dashed border-gray-200 rounded flex flex-col items-center justify-center text-xs text-gray-400 cursor-pointer hover:border-gray-400 transition-colors';
                        div.innerHTML = `
                            <div class="font-semibold text-xs">${i}</div>
                            <div class="text-xs">ç©º</div>
                        `;
                        
                        // é»æ“Šç©ºä½å¯ä»¥æ–°å¢å­¸ç”Ÿ
                        div.addEventListener('click', () => {
                            this.addNewStudentAtSeat(i);
                        });
                        
                        gridContainer.appendChild(div);
                    }
                }

                container.appendChild(gridContainer);

                // æ–°å¢å­¸ç”ŸæŒ‰éˆ•
                const addButton = document.createElement('button');
                addButton.className = 'w-full p-2 border border-dashed border-gray-300 rounded text-xs text-gray-500 hover:border-blue-400 hover:text-blue-600 transition-colors';
                addButton.textContent = '+ æ–°å¢å­¸ç”Ÿ';
                addButton.addEventListener('click', () => this.addNewStudent());
                container.appendChild(addButton);
            }

            renderSeats() {
                const container = document.getElementById('seatingArea');
                container.innerHTML = '';

                if (this.currentMode === 'normal') {
                    this.renderNormalSeats(container);
                } else if (this.currentMode === 'group') {
                    this.renderGroupSeats(container);
                } else if (this.currentMode === 'exam') {
                    this.renderExamSeats(container);
                } else {
                    this.renderFreeSeats(container);
                }
            }

            renderNormalSeats(container) {
                container.className = 'min-h-96 border-2 border-dashed border-gray-300 rounded-lg p-4 mb-6';
                container.innerHTML = '';
                
                const seats = this.getCurrentSeats();
                
                // æ±ºå®šæ’åˆ—é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚é¡›å€’ï¼‰
                const rows = this.isStudentView ? [4, 3, 2, 1, 0] : [0, 1, 2, 3, 4];
                
                // å‰µå»º5æ’åº§ä½ï¼Œæ¯æ’2-2-2çš„æ’åˆ—
                rows.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'flex justify-between items-center px-1 sm:px-2 md:px-4 lg:px-6 xl:px-8 mb-1 sm:mb-2 md:mb-3';
                    
                    // æ±ºå®šåº§ä½é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚å·¦å³ä¹Ÿé¡›å€’ï¼‰
                    const seatOrder = this.isStudentView ? [5, 4, 3, 2, 1, 0] : [0, 1, 2, 3, 4, 5];
                    
                    // å·¦é‚Š2å€‹åº§ä½
                    const leftGroup = document.createElement('div');
                    leftGroup.className = 'flex gap-1 sm:gap-2 md:gap-3 lg:gap-4';
                    
                    for (let i = 0; i < 2; i++) {
                        const col = seatOrder[i];
                        const position = row * 6 + col;
                        const seatDiv = this.createSeatElement(position, seats);
                        leftGroup.appendChild(seatDiv);
                    }
                    
                    // ä¸­é–“2å€‹åº§ä½
                    const middleGroup = document.createElement('div');
                    middleGroup.className = 'flex gap-1 sm:gap-2 md:gap-3 lg:gap-4';
                    
                    for (let i = 2; i < 4; i++) {
                        const col = seatOrder[i];
                        const position = row * 6 + col;
                        const seatDiv = this.createSeatElement(position, seats);
                        middleGroup.appendChild(seatDiv);
                    }
                    
                    // å³é‚Š2å€‹åº§ä½
                    const rightGroup = document.createElement('div');
                    rightGroup.className = 'flex gap-1 sm:gap-2 md:gap-3 lg:gap-4';
                    
                    for (let i = 4; i < 6; i++) {
                        const col = seatOrder[i];
                        const position = row * 6 + col;
                        const seatDiv = this.createSeatElement(position, seats);
                        rightGroup.appendChild(seatDiv);
                    }
                    
                    rowDiv.appendChild(leftGroup);
                    rowDiv.appendChild(middleGroup);
                    rowDiv.appendChild(rightGroup);
                    container.appendChild(rowDiv);
                });
            }

            createSeatElement(position, seats) {
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat w-12 h-10 sm:w-16 sm:h-12 md:w-20 md:h-14 lg:w-24 lg:h-16 xl:w-28 xl:h-18 border-2 border-gray-300 rounded-lg flex flex-col items-center justify-center text-xs sm:text-sm cursor-pointer hover:border-blue-400 transition-colors';
                seatDiv.dataset.position = position;

                const studentId = seats[position];
                if (studentId) {
                    const student = this.students.find(s => s.id === studentId);
                    if (student) {
                        let bgColor = 'bg-blue-100 border-blue-400';
                        if (this.currentMode === 'group') bgColor = 'bg-green-100 border-green-400';
                        if (this.currentMode === 'exam') bgColor = 'bg-red-100 border-red-400';
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºé¸ä¸­çš„å­¸ç”Ÿ
                        if (this.selectedStudent && this.selectedStudent.id === student.id) {
                            seatDiv.className += ' lottery-selected';
                        } else {
                            seatDiv.className += ` ${bgColor}`;
                        }
                        
                        const genderDot = student.gender === 'male' ? 
                            '<span class="inline-block w-2 h-2 bg-blue-500 rounded-full ml-1"></span>' : 
                            '<span class="inline-block w-2 h-2 bg-red-500 rounded-full ml-1"></span>';
                        seatDiv.innerHTML = `
                            <div class="font-semibold text-sm sm:text-base lg:text-lg">${student.seatNumber}</div>
                            <div class="text-xs sm:text-sm truncate w-full text-center px-1 flex items-center justify-center">${student.name}${genderDot}</div>
                        `;
                        seatDiv.addEventListener('click', () => {
                            if (!this.isLotteryRunning) {
                                this.showScoreModal(student);
                            }
                        });
                    }
                } else {
                    seatDiv.innerHTML = '<div class="text-gray-400">ç©ºä½</div>';
                }

                this.makeDraggable(seatDiv);
                this.makeDroppable(seatDiv);
                return seatDiv;
            }

            makeFreeSeatDraggable(seatDiv) {
                let isDragging = false;
                let startX, startY, initialX, initialY;
                
                seatDiv.addEventListener('mousedown', (e) => {
                    if (e.detail === 2) return; // å¿½ç•¥é›™æ“Š
                    
                    isDragging = true;
                    seatDiv.classList.add('dragging');
                    
                    startX = e.clientX;
                    startY = e.clientY;
                    initialX = parseInt(seatDiv.style.left) || 0;
                    initialY = parseInt(seatDiv.style.top) || 0;
                    
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging || seatDiv.dataset.studentId !== seatDiv.dataset.studentId) return;
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    const newX = Math.max(0, initialX + deltaX);
                    const newY = Math.max(0, initialY + deltaY);
                    
                    seatDiv.style.left = newX + 'px';
                    seatDiv.style.top = newY + 'px';
                });
                
                document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    seatDiv.classList.remove('dragging');
                    
                    // ä¿å­˜æ–°ä½ç½®
                    const studentId = parseInt(seatDiv.dataset.studentId);
                    const newX = parseInt(seatDiv.style.left);
                    const newY = parseInt(seatDiv.style.top);
                    
                    this.freeSeats[studentId] = { x: newX, y: newY };
                    this.saveData();
                });
            }

            makeFreeAreaDroppable(container) {
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    
                    const dragData = e.dataTransfer.getData('text/plain');
                    
                    if (dragData.startsWith('student:')) {
                        const studentId = parseInt(dragData.replace('student:', ''));
                        const rect = container.getBoundingClientRect();
                        const x = e.clientX - rect.left - 48; // æ¸›å»åº§ä½å¯¬åº¦çš„ä¸€åŠ
                        const y = e.clientY - rect.top - 32;  // æ¸›å»åº§ä½é«˜åº¦çš„ä¸€åŠ
                        
                        // ç¢ºä¿åº§ä½ä¸æœƒè¶…å‡ºé‚Šç•Œ
                        const maxX = container.clientWidth - 96;
                        const maxY = container.clientHeight - 64;
                        
                        const finalX = Math.max(0, Math.min(x, maxX));
                        const finalY = Math.max(0, Math.min(y, maxY));
                        
                        this.assignStudentToFreeSeat(studentId, { x: finalX, y: finalY });
                    }
                });
            }

            assignStudentToFreeSeat(studentId, position) {
                // å°‡å­¸ç”Ÿåˆ†é…åˆ°ç©ºç™½åº§ä½çš„æŒ‡å®šä½ç½®
                this.freeSeats[studentId] = position;
                
                this.saveData();
                this.renderSeats();
            }

            renderGroupSeats(container) {
                container.className = 'min-h-96 border-2 border-dashed border-gray-300 rounded-lg p-6 mb-6';
                container.innerHTML = '';
                
                const seats = this.getCurrentSeats();
                
                // å‰µå»ºæ•™å®¤é¢¨æ ¼çš„å°çµ„åº§ä½å€åŸŸ
                const groupsContainer = document.createElement('div');
                groupsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-4 lg:gap-6 h-full';
                
                // æ±ºå®šå°çµ„é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚é¡›å€’ï¼‰
                const groupOrder = this.isStudentView ? [5, 4, 3, 2, 1, 0] : [0, 1, 2, 3, 4, 5];
                
                groupOrder.forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'border-2 border-dashed border-gray-400 rounded-lg p-4 min-h-52 relative bg-gray-50';
                    
                    const groupLabel = document.createElement('div');
                    groupLabel.className = 'absolute -top-3 left-4 bg-white px-3 py-1 text-sm font-semibold text-gray-700 rounded border';
                    groupLabel.textContent = `ç¬¬${group + 1}çµ„`;
                    groupDiv.appendChild(groupLabel);
                    
                    const groupSeats = document.createElement('div');
                    groupSeats.className = 'flex flex-col items-center justify-center h-full pt-4';
                    
                    // ä¸Šæ’1å€‹åº§ä½ï¼ˆä¸­å¤®ï¼‰
                    const topRow = document.createElement('div');
                    topRow.className = 'flex justify-center mb-3';
                    
                    const position1 = group * 5;
                    const seatDiv1 = this.createSeatElement(position1, seats);
                    topRow.appendChild(seatDiv1);
                    
                    // ä¸­æ’2å€‹åº§ä½
                    const middleRow = document.createElement('div');
                    middleRow.className = 'flex gap-1 sm:gap-2 lg:gap-3 mb-2 sm:mb-3';
                    
                    for (let seat = 1; seat < 3; seat++) {
                        const position = group * 5 + seat;
                        const seatDiv = this.createSeatElement(position, seats);
                        middleRow.appendChild(seatDiv);
                    }
                    
                    // ä¸‹æ’2å€‹åº§ä½
                    const bottomRow = document.createElement('div');
                    bottomRow.className = 'flex gap-1 sm:gap-2 lg:gap-3';
                    
                    for (let seat = 3; seat < 5; seat++) {
                        const position = group * 5 + seat;
                        const seatDiv = this.createSeatElement(position, seats);
                        bottomRow.appendChild(seatDiv);
                    }
                    
                    groupSeats.appendChild(topRow);
                    groupSeats.appendChild(middleRow);
                    groupSeats.appendChild(bottomRow);
                    groupDiv.appendChild(groupSeats);
                    groupsContainer.appendChild(groupDiv);
                });
                
                container.appendChild(groupsContainer);
            }

            renderFreeSeats(container) {
                container.className = 'free-mode-area min-h-96 border-2 border-dashed border-gray-300 rounded-lg p-4 mb-6';
                container.innerHTML = '';
                
                const seats = this.getCurrentSeats();
                
                // æ·»åŠ èªªæ˜æ–‡å­—
                const instructionDiv = document.createElement('div');
                instructionDiv.className = 'absolute top-2 left-2 bg-white bg-opacity-90 rounded-lg p-3 text-sm text-gray-600 shadow-md z-5';
                instructionDiv.innerHTML = `
                    <div class="font-semibold text-gray-800 mb-1">ğŸ¯ ç©ºç™½åº§ä½æ¨¡å¼</div>
                    <div>â€¢ å¾å·¦å´å­¸ç”Ÿåå–®æ‹–æ‹½å­¸ç”Ÿåˆ°æ•™å®¤ä»»æ„ä½ç½®</div>
                    <div>â€¢ å¯è‡ªç”±ç§»å‹•åº§ä½ï¼Œé©åˆæ´»å‹•ã€éŠæˆ²å®‰æ’</div>
                    <div>â€¢ é›™æ“Šåº§ä½å¯é€²è¡ŒåŠ æ¸›åˆ†</div>
                `;
                container.appendChild(instructionDiv);
                
                // æ¸²æŸ“å·²æ”¾ç½®çš„åº§ä½
                Object.entries(seats).forEach(([studentId, position]) => {
                    const student = this.students.find(s => s.id === parseInt(studentId));
                    if (student && position) {
                        const seatDiv = this.createFreeSeat(student, position);
                        container.appendChild(seatDiv);
                    }
                });
                
                // è®“æ•´å€‹å®¹å™¨å¯ä»¥æ¥æ”¶æ‹–æ‹½
                this.makeFreeAreaDroppable(container);
            }

            createFreeSeat(student, position) {
                const seatDiv = document.createElement('div');
                seatDiv.className = 'free-seat w-24 h-16 bg-purple-100 border-2 border-purple-400 rounded-lg flex flex-col items-center justify-center text-sm cursor-move shadow-md hover:shadow-lg transition-all';
                seatDiv.dataset.studentId = student.id;
                seatDiv.style.left = position.x + 'px';
                seatDiv.style.top = position.y + 'px';
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºé¸ä¸­çš„å­¸ç”Ÿ
                if (this.selectedStudent && this.selectedStudent.id === student.id) {
                    seatDiv.className += ' lottery-selected';
                }
                
                const genderDot = student.gender === 'male' ? 
                    '<span class="inline-block w-2 h-2 bg-blue-500 rounded-full ml-1"></span>' : 
                    '<span class="inline-block w-2 h-2 bg-red-500 rounded-full ml-1"></span>';
                
                seatDiv.innerHTML = `
                    <div class="font-semibold text-base">${student.seatNumber}</div>
                    <div class="text-xs truncate w-full text-center px-1 flex items-center justify-center">${student.name}${genderDot}</div>
                `;
                
                // é›™æ“Šäº‹ä»¶ï¼ˆåŠ æ¸›åˆ†ï¼‰
                seatDiv.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    if (!this.isLotteryRunning) {
                        this.showScoreModal(student);
                    }
                });
                
                // æ‹–æ‹½äº‹ä»¶
                this.makeFreeSeatDraggable(seatDiv);
                
                return seatDiv;
            }

            makeFreeSeatDraggable(seatDiv) {
                let isDragging = false;
                let startX, startY, initialX, initialY;
                
                seatDiv.addEventListener('mousedown', (e) => {
                    if (e.detail === 2) return; // å¿½ç•¥é›™æ“Š
                    
                    isDragging = true;
                    seatDiv.classList.add('dragging');
                    
                    startX = e.clientX;
                    startY = e.clientY;
                    initialX = parseInt(seatDiv.style.left) || 0;
                    initialY = parseInt(seatDiv.style.top) || 0;
                    
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging || seatDiv.dataset.studentId !== seatDiv.dataset.studentId) return;
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    const newX = Math.max(0, initialX + deltaX);
                    const newY = Math.max(0, initialY + deltaY);
                    
                    seatDiv.style.left = newX + 'px';
                    seatDiv.style.top = newY + 'px';
                });
                
                document.addEventListener('mouseup', (e) => {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    seatDiv.classList.remove('dragging');
                    
                    // ä¿å­˜æ–°ä½ç½®
                    const studentId = parseInt(seatDiv.dataset.studentId);
                    const newX = parseInt(seatDiv.style.left);
                    const newY = parseInt(seatDiv.style.top);
                    
                    this.freeSeats[studentId] = { x: newX, y: newY };
                    this.saveData();
                });
            }

            makeFreeAreaDroppable(container) {
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    
                    const dragData = e.dataTransfer.getData('text/plain');
                    
                    if (dragData.startsWith('student:')) {
                        const studentId = parseInt(dragData.replace('student:', ''));
                        const rect = container.getBoundingClientRect();
                        const x = e.clientX - rect.left - 48; // æ¸›å»åº§ä½å¯¬åº¦çš„ä¸€åŠ
                        const y = e.clientY - rect.top - 32;  // æ¸›å»åº§ä½é«˜åº¦çš„ä¸€åŠ
                        
                        // ç¢ºä¿åº§ä½ä¸æœƒè¶…å‡ºé‚Šç•Œ
                        const maxX = container.clientWidth - 96;
                        const maxY = container.clientHeight - 64;
                        
                        const finalX = Math.max(0, Math.min(x, maxX));
                        const finalY = Math.max(0, Math.min(y, maxY));
                        
                        this.assignStudentToFreeSeat(studentId, { x: finalX, y: finalY });
                    }
                });
            }

            assignStudentToFreeSeat(studentId, position) {
                // å°‡å­¸ç”Ÿåˆ†é…åˆ°ç©ºç™½åº§ä½çš„æŒ‡å®šä½ç½®
                this.freeSeats[studentId] = position;
                
                this.saveData();
                this.renderSeats();
            }

            renderExamSeats(container) {
                container.className = 'min-h-96 border-2 border-dashed border-gray-300 rounded-lg p-4 mb-6';
                container.innerHTML = '';
                
                const seats = this.getCurrentSeats();
                
                // æ±ºå®šæ’åˆ—é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚é¡›å€’ï¼‰
                const rows = this.isStudentView ? [5, 4, 3, 2, 1, 0] : [0, 1, 2, 3, 4, 5];
                
                // å‰µå»º6æ’åº§ä½ï¼Œæ¯æ’5å€‹åº§ä½
                rows.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'flex justify-between items-center px-1 sm:px-4 lg:px-12 mb-2 sm:mb-3';
                    
                    // æ±ºå®šåº§ä½é †åºï¼ˆå­¸ç”Ÿè¦–è§’æ™‚å·¦å³ä¹Ÿé¡›å€’ï¼‰
                    const seatOrder = this.isStudentView ? [4, 3, 2, 1, 0] : [0, 1, 2, 3, 4];
                    
                    seatOrder.forEach(col => {
                        const position = row * 5 + col;
                        const seatDiv = this.createSeatElement(position, seats);
                        rowDiv.appendChild(seatDiv);
                    });
                    
                    container.appendChild(rowDiv);
                });
            }

            makeDraggable(element) {
                element.draggable = true;
                element.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.position);
                    e.target.classList.add('dragging');
                });
                element.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            }

            makeDroppable(element) {
                element.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    element.classList.add('drop-zone');
                });
                element.addEventListener('dragleave', () => {
                    element.classList.remove('drop-zone');
                });
                element.addEventListener('drop', (e) => {
                    e.preventDefault();
                    element.classList.remove('drop-zone');
                    
                    const dragData = e.dataTransfer.getData('text/plain');
                    const toPosition = parseInt(element.dataset.position);
                    
                    if (dragData.startsWith('student:')) {
                        // å¾å­¸ç”Ÿåˆ—è¡¨æ‹–æ‹½åˆ°åº§ä½
                        const studentId = parseInt(dragData.replace('student:', ''));
                        this.assignStudentToSeat(studentId, toPosition);
                    } else {
                        // åº§ä½ä¹‹é–“çš„æ‹–æ‹½
                        const fromPosition = parseInt(dragData);
                        if (fromPosition !== toPosition) {
                            this.swapSeats(fromPosition, toPosition);
                        }
                    }
                });
            }

            assignStudentToSeat(studentId, position) {
                const seats = this.getCurrentSeats();
                
                // æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²ç¶“æœ‰åº§ä½ï¼Œå¦‚æœæœ‰å°±æ¸…é™¤åŸåº§ä½
                Object.keys(seats).forEach(pos => {
                    if (seats[pos] === studentId) {
                        delete seats[pos];
                    }
                });
                
                // å°‡å­¸ç”Ÿåˆ†é…åˆ°æ–°åº§ä½
                seats[position] = studentId;
                
                this.saveData();
                this.renderSeats();
            }

            swapSeats(pos1, pos2) {
                const seats = this.getCurrentSeats();
                const temp = seats[pos1];
                seats[pos1] = seats[pos2];
                seats[pos2] = temp;
                
                this.saveData();
                this.renderSeats();
            }

            showScoreModal(student) {
                this.currentScoreStudent = student;
                this.selectedScoreType = null; // é‡ç½®é¸æ“‡ç‹€æ…‹
                const modal = document.getElementById('scoreModal');
                const studentName = document.getElementById('scoreStudentName');
                const reasonInput = document.getElementById('scoreReason');
                
                studentName.textContent = `${student.seatNumber}è™Ÿ ${student.name}`;
                reasonInput.value = '';
                
                // ç‚ºå¿«é€ŸåŸå› æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                const reasonButtons = modal.querySelectorAll('.reason-btn');
                reasonButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        reasonInput.value = btn.textContent.trim();
                        reasonInput.focus();
                    });
                });
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideScoreModal() {
                document.getElementById('scoreModal').classList.add('hidden');
                document.getElementById('scoreModal').classList.remove('flex');
                this.currentScoreStudent = null;
                this.selectedScoreType = null;
            }

            selectScoreType(type) {
                this.selectedScoreType = type;
                const reasonInput = document.getElementById('scoreReason');
                
                // è¨­å®šé è¨­å…§å®¹
                if (type === 1) {
                    reasonInput.value = 'è¡¨ç¾å„ªè‰¯';
                } else {
                    reasonInput.value = 'è¡¨ç¾ä¸å¥½';
                }
                
                reasonInput.focus();
                reasonInput.select(); // é¸ä¸­æ–‡å­—ï¼Œæ–¹ä¾¿ä¿®æ”¹
            }

            confirmScore() {
                if (!this.selectedScoreType) {
                    alert('è«‹å…ˆé¸æ“‡åŠ åˆ†æˆ–æ‰£åˆ†');
                    return;
                }
                
                this.adjustScore(this.selectedScoreType);
            }

            adjustScore(change) {
                if (!this.currentScoreStudent) return;
                
                const reason = document.getElementById('scoreReason').value.trim();
                if (!reason) {
                    alert('è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ');
                    return;
                }

                const student = this.currentScoreStudent;
                
                // æ›´æ–°ç©åˆ†
                if (!this.scores[student.id]) {
                    this.scores[student.id] = 0;
                }
                this.scores[student.id] += change;
                
                // è¨˜éŒ„æ­·å²
                if (!this.scoreHistory[student.id]) {
                    this.scoreHistory[student.id] = [];
                }
                
                this.scoreHistory[student.id].push({
                    date: new Date().toLocaleString('zh-TW'),
                    change: change,
                    reason: reason,
                    total: this.scores[student.id]
                });
                
                this.saveData();
                this.renderStudentList();
                this.renderSeats();
                this.hideScoreModal();
                
                // é¡¯ç¤ºå‹•ç•«
                const changeText = change > 0 ? `+${change}` : `${change}`;
                // é€™è£¡å¯ä»¥æ·»åŠ å‹•ç•«æ•ˆæœ
            }

            showScoreAnimation(element, text) {
                const popup = document.createElement('div');
                popup.className = 'score-popup absolute text-green-600 font-bold text-lg pointer-events-none z-50';
                popup.textContent = text;
                popup.style.left = element.offsetLeft + 'px';
                popup.style.top = element.offsetTop + 'px';
                
                element.parentElement.appendChild(popup);
                
                setTimeout(() => {
                    popup.remove();
                }, 1000);
            }

            showEditModal(student = null) {
                this.editingStudent = student;
                const modal = document.getElementById('editModal');
                const seatNumberInput = document.getElementById('editSeatNumber');
                const nameInput = document.getElementById('editStudentName');
                const genderSelect = document.getElementById('editStudentGender');
                
                if (student) {
                    seatNumberInput.value = student.seatNumber;
                    nameInput.value = student.name;
                    genderSelect.value = student.gender || 'male';
                } else {
                    seatNumberInput.value = this.students.length + 1;
                    nameInput.value = '';
                    genderSelect.value = 'male';
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                nameInput.focus();
            }

            hideEditModal() {
                document.getElementById('editModal').classList.add('hidden');
                document.getElementById('editModal').classList.remove('flex');
                this.editingStudent = null;
            }

            editStudent(student) {
                this.showEditModal(student);
            }

            addNewStudent() {
                this.showEditModal();
            }

            addNewStudentAtSeat(seatNumber) {
                // åœ¨æŒ‡å®šåº§è™Ÿæ–°å¢å­¸ç”Ÿ
                const newId = Math.max(...this.students.map(s => s.id), 0) + 1;
                const newStudent = {
                    id: newId,
                    seatNumber: seatNumber,
                    name: `å­¸ç”Ÿ${seatNumber}`,
                    gender: 'male'
                };
                this.students.push(newStudent);
                this.saveData();
                this.renderStudentList();
                this.showStudentSettingsModal(newStudent);
            }

            // å­¸ç”Ÿè¨­å®šæ¨¡æ…‹æ¡†ç›¸é—œæ–¹æ³•
            showStudentSettingsModal(student) {
                this.currentSettingsStudent = student;
                this.selectedSettingsScoreType = null;
                
                const modal = document.getElementById('studentSettingsModal');
                const studentName = document.getElementById('settingsStudentName');
                const studentScore = document.getElementById('settingsStudentScore');
                const reasonInput = document.getElementById('settingsScoreReason');
                const confirmBtn = document.getElementById('settingsConfirmScore');
                
                studentName.textContent = `${student.seatNumber}è™Ÿ ${student.name}`;
                studentScore.textContent = `ç¸½ç©åˆ†ï¼š${this.scores[student.id] || 0}åˆ†`;
                reasonInput.value = '';
                confirmBtn.classList.add('hidden');
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideStudentSettingsModal() {
                document.getElementById('studentSettingsModal').classList.add('hidden');
                document.getElementById('studentSettingsModal').classList.remove('flex');
                this.currentSettingsStudent = null;
                this.selectedSettingsScoreType = null;
            }

            selectSettingsScoreType(type) {
                this.selectedSettingsScoreType = type;
                const reasonInput = document.getElementById('settingsScoreReason');
                const confirmBtn = document.getElementById('settingsConfirmScore');
                
                // è¨­å®šé è¨­å…§å®¹
                if (type === 1) {
                    reasonInput.value = 'è¡¨ç¾å„ªè‰¯';
                } else {
                    reasonInput.value = 'è¡¨ç¾ä¸å¥½';
                }
                
                confirmBtn.classList.remove('hidden');
                reasonInput.focus();
                reasonInput.select();
            }

            confirmSettingsScore() {
                if (!this.selectedSettingsScoreType || !this.currentSettingsStudent) return;
                
                const reason = document.getElementById('settingsScoreReason').value.trim();
                if (!reason) {
                    alert('è«‹è¼¸å…¥åŠ æ¸›åˆ†åŸå› ');
                    return;
                }

                const student = this.currentSettingsStudent;
                
                // æ›´æ–°ç©åˆ†
                if (!this.scores[student.id]) {
                    this.scores[student.id] = 0;
                }
                this.scores[student.id] += this.selectedSettingsScoreType;
                
                // è¨˜éŒ„æ­·å²
                if (!this.scoreHistory[student.id]) {
                    this.scoreHistory[student.id] = [];
                }
                
                this.scoreHistory[student.id].push({
                    date: new Date().toLocaleString('zh-TW'),
                    change: this.selectedSettingsScoreType,
                    reason: reason,
                    total: this.scores[student.id]
                });
                
                this.saveData();
                this.renderStudentList();
                this.renderSeats();
                
                // æ›´æ–°æ¨¡æ…‹æ¡†é¡¯ç¤º
                const studentScore = document.getElementById('settingsStudentScore');
                studentScore.textContent = `ç¸½ç©åˆ†ï¼š${this.scores[student.id]}åˆ†`;
                
                // é‡ç½®ç‹€æ…‹
                this.selectedSettingsScoreType = null;
                document.getElementById('settingsScoreReason').value = '';
                document.getElementById('settingsConfirmScore').classList.add('hidden');
                
                const changeText = this.selectedSettingsScoreType > 0 ? `+${this.selectedSettingsScoreType}` : `${this.selectedSettingsScoreType}`;
                // å¯ä»¥åœ¨é€™è£¡æ·»åŠ æˆåŠŸæç¤º
            }

            viewHistoryFromSettings() {
                if (this.currentSettingsStudent) {
                    this.hideStudentSettingsModal();
                    this.showHistoryModal(this.currentSettingsStudent);
                }
            }

            editStudentFromSettings() {
                if (this.currentSettingsStudent) {
                    this.hideStudentSettingsModal();
                    this.showEditModal(this.currentSettingsStudent);
                }
            }

            saveStudent() {
                const seatNumber = parseInt(document.getElementById('editSeatNumber').value);
                const name = document.getElementById('editStudentName').value.trim();
                const gender = document.getElementById('editStudentGender').value;
                
                if (!name) {
                    alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“å');
                    return;
                }

                if (this.editingStudent) {
                    // ç·¨è¼¯ç¾æœ‰å­¸ç”Ÿ
                    this.editingStudent.seatNumber = seatNumber;
                    this.editingStudent.name = name;
                    this.editingStudent.gender = gender;
                } else {
                    // æ–°å¢å­¸ç”Ÿ
                    const newId = Math.max(...this.students.map(s => s.id), 0) + 1;
                    this.students.push({
                        id: newId,
                        seatNumber: seatNumber,
                        name: name,
                        gender: gender
                    });
                }

                this.saveData();
                this.renderStudentList();
                this.renderSeats(); // åŒæ­¥æ›´æ–°åº§ä½é¡¯ç¤º
                this.hideEditModal();
            }

            deleteStudent() {
                if (this.editingStudent && confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ')) {
                    // å¾åº§ä½ä¸­ç§»é™¤
                    Object.keys(this.normalSeats).forEach(pos => {
                        if (this.normalSeats[pos] === this.editingStudent.id) {
                            delete this.normalSeats[pos];
                        }
                    });
                    Object.keys(this.groupSeats).forEach(pos => {
                        if (this.groupSeats[pos] === this.editingStudent.id) {
                            delete this.groupSeats[pos];
                        }
                    });
                    Object.keys(this.examSeats).forEach(pos => {
                        if (this.examSeats[pos] === this.editingStudent.id) {
                            delete this.examSeats[pos];
                        }
                    });
                    // å¾ç©ºç™½åº§ä½ä¸­ç§»é™¤
                    delete this.freeSeats[this.editingStudent.id];

                    // å¾å­¸ç”Ÿåˆ—è¡¨ä¸­ç§»é™¤
                    this.students = this.students.filter(s => s.id !== this.editingStudent.id);
                    
                    // ç§»é™¤ç©åˆ†
                    delete this.scores[this.editingStudent.id];

                    this.saveData();
                    this.renderStudentList();
                    this.renderSeats();
                    this.hideEditModal();
                }
            }

            resetSeats() {
                if (confirm('ç¢ºå®šè¦é‡ç½®ç•¶å‰æ¨¡å¼çš„åº§ä½å®‰æ’å—ï¼Ÿ')) {
                    if (this.currentMode === 'normal') {
                        this.normalSeats = {};
                    } else if (this.currentMode === 'group') {
                        this.groupSeats = {};
                    } else if (this.currentMode === 'exam') {
                        this.examSeats = {};
                    } else {
                        this.freeSeats = {};
                    }
                    this.saveData();
                    this.renderSeats();
                }
            }

            showScoresModal() {
                const modal = document.getElementById('scoresModal');
                const container = document.getElementById('scoresList');
                
                // æŒ‰ç©åˆ†æ’åº
                const sortedStudents = this.students
                    .map(student => ({
                        ...student,
                        score: this.scores[student.id] || 0
                    }))
                    .sort((a, b) => b.score - a.score);

                container.innerHTML = '';
                sortedStudents.forEach((student, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </span>
                            <span>${student.seatNumber}è™Ÿ ${student.name}</span>
                        </div>
                        <span class="text-lg font-bold text-blue-600">${student.score}åˆ†</span>
                    `;
                    container.appendChild(div);
                });

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideScoresModal() {
                document.getElementById('scoresModal').classList.add('hidden');
                document.getElementById('scoresModal').classList.remove('flex');
            }

            showHistoryModal(student) {
                const modal = document.getElementById('historyModal');
                const studentName = document.getElementById('historyStudentName');
                const totalScore = document.getElementById('historyTotalScore');
                const container = document.getElementById('historyList');
                
                studentName.textContent = `${student.seatNumber}è™Ÿ ${student.name}`;
                totalScore.textContent = `ç¸½ç©åˆ†ï¼š${this.scores[student.id] || 0}åˆ†`;
                
                container.innerHTML = '';
                
                const history = this.scoreHistory[student.id] || [];
                if (history.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">æš«ç„¡ç©åˆ†è¨˜éŒ„</div>';
                } else {
                    // æŒ‰æ™‚é–“å€’åºé¡¯ç¤º
                    history.slice().reverse().forEach(record => {
                        const div = document.createElement('div');
                        div.className = 'p-3 bg-gray-50 rounded-lg border-l-4 ' + 
                            (record.change > 0 ? 'border-green-500' : 'border-red-500');
                        
                        const changeColor = record.change > 0 ? 'text-green-600' : 'text-red-600';
                        const changeText = record.change > 0 ? `+${record.change}` : `${record.change}`;
                        
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-sm text-gray-600">${record.date}</span>
                                <span class="font-bold ${changeColor}">${changeText}åˆ†</span>
                            </div>
                            <div class="text-sm text-gray-800 mb-1">${record.reason}</div>
                            <div class="text-xs text-gray-500">ç©åˆ†è®Šç‚ºï¼š${record.total}åˆ†</div>
                        `;
                        container.appendChild(div);
                    });
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideHistoryModal() {
                document.getElementById('historyModal').classList.add('hidden');
                document.getElementById('historyModal').classList.remove('flex');
            }

            resetAllScores() {
                if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç”Ÿçš„ç©åˆ†å—ï¼Ÿ')) {
                    this.scores = {};
                    this.scoreHistory = {};
                    this.saveData();
                    this.renderStudentList();
                    this.hideScoresModal();
                }
            }

            // æŠ½ç±¤ç³»çµ±
            startLottery(type) {
                if (this.isLotteryRunning) return;
                
                // ç²å–æœ‰åº§ä½çš„å­¸ç”Ÿ
                const seats = this.getCurrentSeats();
                const seatedStudents = [];
                
                Object.values(seats).forEach(studentId => {
                    const student = this.students.find(s => s.id === studentId);
                    if (student) {
                        if (type === 'all' || 
                            (type === 'male' && student.gender === 'male') ||
                            (type === 'female' && student.gender === 'female')) {
                            seatedStudents.push(student);
                        }
                    }
                });
                
                if (seatedStudents.length === 0) {
                    const typeText = type === 'male' ? 'ç”·ç”Ÿ' : type === 'female' ? 'å¥³ç”Ÿ' : 'å­¸ç”Ÿ';
                    alert(`æ•™å®¤å…§æ²’æœ‰${typeText}å¯ä»¥æŠ½ç±¤ï¼`);
                    return;
                }
                
                this.isLotteryRunning = true;
                this.runLotteryAnimation(seatedStudents);
            }

            runLotteryAnimation(candidates) {
                // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡
                this.selectedStudent = null;
                this.renderSeats();
                
                let flashCount = 0;
                const maxFlashes = 10; // é–ƒçˆæ¬¡æ•¸
                const flashInterval = 300; // æ¯æ¬¡é–ƒçˆé–“éš”
                
                const flashAnimation = setInterval(() => {
                    // ç§»é™¤æ‰€æœ‰é–ƒçˆæ•ˆæœ
                    document.querySelectorAll('.lottery-flash').forEach(seat => {
                        seat.classList.remove('lottery-flash');
                    });
                    
                    if (flashCount >= maxFlashes) {
                        clearInterval(flashAnimation);
                        this.selectFinalWinner(candidates);
                        return;
                    }
                    
                    // éš¨æ©Ÿé¸æ“‡ä¸€å€‹å€™é¸äººé€²è¡Œé–ƒçˆ
                    const randomStudent = candidates[Math.floor(Math.random() * candidates.length)];
                    const seatElement = this.findSeatElement(randomStudent.id);
                    
                    if (seatElement) {
                        seatElement.classList.add('lottery-flash');
                    }
                    
                    flashCount++;
                }, flashInterval);
            }

            selectFinalWinner(candidates) {
                // é¸æ“‡æœ€çµ‚ç²å‹è€…
                const winner = candidates[Math.floor(Math.random() * candidates.length)];
                this.selectedStudent = winner;
                
                // ç§»é™¤æ‰€æœ‰é–ƒçˆæ•ˆæœ
                document.querySelectorAll('.lottery-flash').forEach(seat => {
                    seat.classList.remove('lottery-flash');
                });
                
                // é‡æ–°æ¸²æŸ“åº§ä½ä»¥é¡¯ç¤ºé¸ä¸­æ•ˆæœ
                this.renderSeats();
                
                // é¡¯ç¤ºå–æ¶ˆæ¨™è¨˜æŒ‰éˆ•
                document.getElementById('clearSelection').classList.remove('hidden');
                
                this.isLotteryRunning = false;
                
                // é¡¯ç¤ºçµæœ
                const genderText = winner.gender === 'male' ? '(ç”·ç”Ÿ)' : '(å¥³ç”Ÿ)';
                alert(`ğŸ‰ æŠ½ç±¤çµæœï¼š${winner.seatNumber}è™Ÿ ${winner.name} ${genderText}`);
            }

            findSeatElement(studentId) {
                const seats = this.getCurrentSeats();
                for (const [position, seatStudentId] of Object.entries(seats)) {
                    if (seatStudentId === studentId) {
                        return document.querySelector(`[data-position="${position}"]`);
                    }
                }
                return null;
            }

            clearSelection() {
                this.selectedStudent = null;
                this.renderSeats();
                document.getElementById('clearSelection').classList.add('hidden');
            }

            // ç­ç´šç®¡ç†ç›¸é—œæ–¹æ³•
            renderClassSelector() {
                const currentClass = this.classes.find(c => c.id === this.currentClass);
                document.getElementById('currentClassName').textContent = currentClass ? currentClass.name : '101';
                this.renderClassDropdown();
            }

            renderClassDropdown() {
                const dropdown = document.getElementById('classDropdown');
                dropdown.innerHTML = '';

                this.classes.forEach(classItem => {
                    const div = document.createElement('div');
                    div.className = `px-4 py-2 hover:bg-gray-100 cursor-pointer flex items-center justify-between ${
                        classItem.id === this.currentClass ? 'bg-blue-50 text-blue-600' : ''
                    }`;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = classItem.name;
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'flex gap-1';
                    
                    if (classItem.id === this.currentClass) {
                        const currentBadge = document.createElement('span');
                        currentBadge.className = 'text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded';
                        currentBadge.textContent = 'ç›®å‰';
                        actionsDiv.appendChild(currentBadge);
                    }
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'text-xs text-gray-500 hover:text-gray-700 px-1';
                    editBtn.innerHTML = 'âœï¸';
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.editClass(classItem);
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-xs text-red-500 hover:text-red-700 px-1';
                    deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteClass(classItem);
                    });
                    
                    actionsDiv.appendChild(editBtn);
                    if (this.classes.length > 1) { // è‡³å°‘ä¿ç•™ä¸€å€‹ç­ç´š
                        actionsDiv.appendChild(deleteBtn);
                    }
                    
                    div.appendChild(nameSpan);
                    div.appendChild(actionsDiv);
                    
                    div.addEventListener('click', () => {
                        if (classItem.id !== this.currentClass) {
                            this.switchClass(classItem.id);
                        }
                        this.hideClassDropdown();
                    });
                    
                    dropdown.appendChild(div);
                });
            }

            toggleClassDropdown() {
                const dropdown = document.getElementById('classDropdown');
                dropdown.classList.toggle('hidden');
            }

            hideClassDropdown() {
                document.getElementById('classDropdown').classList.add('hidden');
            }

            switchClass(classId) {
                // ä¿å­˜ç•¶å‰ç­ç´šè³‡æ–™
                this.saveData();
                
                // åˆ‡æ›åˆ°æ–°ç­ç´š
                this.currentClass = classId;
                
                // é‡æ–°è¼‰å…¥æ–°ç­ç´šçš„è³‡æ–™
                this.students = this.loadStudents();
                this.normalSeats = this.loadSeats('normal');
                this.groupSeats = this.loadSeats('group');
                this.examSeats = this.loadSeats('exam');
                this.freeSeats = this.loadSeats('free');
                this.scores = this.loadScores();
                this.scoreHistory = this.loadScoreHistory();
                this.selectedStudent = null;
                
                // æ›´æ–°é¡¯ç¤º
                this.renderClassSelector();
                this.renderStudentList();
                this.renderSeats();
                
                // ä¿å­˜æ–°çš„ç•¶å‰ç­ç´š
                this.saveData();
            }

            showClassModal() {
                this.renderClassManageList();
                const modal = document.getElementById('classModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideClassModal() {
                document.getElementById('classModal').classList.add('hidden');
                document.getElementById('classModal').classList.remove('flex');
            }

            renderClassManageList() {
                const container = document.getElementById('classManageList');
                container.innerHTML = '';

                this.classes.forEach(classItem => {
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-3 bg-gray-50 rounded-lg ${
                        classItem.id === this.currentClass ? 'border-2 border-blue-400' : 'border border-gray-200'
                    }`;
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.className = 'flex items-center gap-3';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'font-medium';
                    nameSpan.textContent = classItem.name;
                    
                    if (classItem.id === this.currentClass) {
                        const badge = document.createElement('span');
                        badge.className = 'text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded';
                        badge.textContent = 'ç›®å‰ç­ç´š';
                        leftDiv.appendChild(nameSpan);
                        leftDiv.appendChild(badge);
                    } else {
                        leftDiv.appendChild(nameSpan);
                    }
                    
                    const rightDiv = document.createElement('div');
                    rightDiv.className = 'flex gap-2';
                    
                    if (classItem.id !== this.currentClass) {
                        const switchBtn = document.createElement('button');
                        switchBtn.className = 'px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors';
                        switchBtn.textContent = 'åˆ‡æ›';
                        switchBtn.addEventListener('click', () => {
                            this.switchClass(classItem.id);
                            this.hideClassModal();
                        });
                        rightDiv.appendChild(switchBtn);
                    }
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600 transition-colors';
                    editBtn.textContent = 'ç·¨è¼¯';
                    editBtn.addEventListener('click', () => {
                        this.editClass(classItem);
                    });
                    rightDiv.appendChild(editBtn);
                    
                    if (this.classes.length > 1) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors';
                        deleteBtn.textContent = 'åˆªé™¤';
                        deleteBtn.addEventListener('click', () => {
                            this.deleteClass(classItem);
                        });
                        rightDiv.appendChild(deleteBtn);
                    }
                    
                    div.appendChild(leftDiv);
                    div.appendChild(rightDiv);
                    container.appendChild(div);
                });
            }

            showClassEditModal(classItem = null) {
                this.editingClass = classItem;
                const modal = document.getElementById('classEditModal');
                const title = document.getElementById('classEditTitle');
                const input = document.getElementById('classNameInput');
                
                if (classItem) {
                    title.textContent = 'ç·¨è¼¯ç­ç´š';
                    input.value = classItem.name;
                } else {
                    title.textContent = 'æ–°å¢ç­ç´š';
                    input.value = '';
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                input.focus();
            }

            hideClassEditModal() {
                document.getElementById('classEditModal').classList.add('hidden');
                document.getElementById('classEditModal').classList.remove('flex');
                this.editingClass = null;
            }

            editClass(classItem) {
                this.hideClassModal();
                this.showClassEditModal(classItem);
            }

            saveClass() {
                const name = document.getElementById('classNameInput').value.trim();
                if (!name) {
                    alert('è«‹è¼¸å…¥ç­ç´šåç¨±');
                    return;
                }

                if (this.editingClass) {
                    // ç·¨è¼¯ç¾æœ‰ç­ç´š
                    this.editingClass.name = name;
                } else {
                    // æ–°å¢ç­ç´š
                    const newId = 'class_' + Date.now();
                    this.classes.push({
                        id: newId,
                        name: name
                    });
                }

                this.saveData();
                this.renderClassSelector();
                this.hideClassEditModal();
                
                if (!this.editingClass) {
                    // å¦‚æœæ˜¯æ–°å¢ç­ç´šï¼Œè©¢å•æ˜¯å¦åˆ‡æ›
                    if (confirm(`ç­ç´šã€Œ${name}ã€å·²å»ºç«‹ï¼æ˜¯å¦ç«‹å³åˆ‡æ›åˆ°æ­¤ç­ç´šï¼Ÿ`)) {
                        const newClass = this.classes[this.classes.length - 1];
                        this.switchClass(newClass.id);
                    }
                }
            }

            deleteClass(classItem) {
                if (this.classes.length <= 1) {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç­ç´šï¼');
                    return;
                }

                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç­ç´šã€Œ${classItem.name}ã€å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼šé€™å°‡æ°¸ä¹…åˆªé™¤è©²ç­ç´šçš„æ‰€æœ‰è³‡æ–™ï¼ŒåŒ…æ‹¬å­¸ç”Ÿè³‡æ–™ã€åº§ä½å®‰æ’å’Œç©åˆ†è¨˜éŒ„ï¼`)) {
                    return;
                }

                // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰ç­ç´šï¼Œåˆ‡æ›åˆ°ç¬¬ä¸€å€‹å…¶ä»–ç­ç´š
                if (classItem.id === this.currentClass) {
                    const otherClass = this.classes.find(c => c.id !== classItem.id);
                    if (otherClass) {
                        this.switchClass(otherClass.id);
                    }
                }

                // åˆªé™¤ç­ç´šè³‡æ–™
                this.classes = this.classes.filter(c => c.id !== classItem.id);
                
                // æ¸…é™¤è©²ç­ç´šçš„æ‰€æœ‰æœ¬åœ°å­˜å„²è³‡æ–™
                localStorage.removeItem(`classroom_students_${classItem.id}`);
                localStorage.removeItem(`classroom_seats_normal_${classItem.id}`);
                localStorage.removeItem(`classroom_seats_group_${classItem.id}`);
                localStorage.removeItem(`classroom_seats_exam_${classItem.id}`);
                localStorage.removeItem(`classroom_seats_free_${classItem.id}`);
                localStorage.removeItem(`classroom_scores_${classItem.id}`);
                localStorage.removeItem(`classroom_score_history_${classItem.id}`);

                this.saveData();
                this.renderClassSelector();
                this.renderClassManageList();
            }

            // æ‰¹é‡è¨­å®šç›¸é—œæ–¹æ³•
            showBatchModal() {
                const modal = document.getElementById('batchModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideBatchModal() {
                document.getElementById('batchModal').classList.add('hidden');
                document.getElementById('batchModal').classList.remove('flex');
            }

            confirmBatchSetup() {
                const totalStudents = parseInt(document.getElementById('totalStudents').value);
                const maleStart = parseInt(document.getElementById('maleStart').value);
                const maleEnd = parseInt(document.getElementById('maleEnd').value);
                const femaleStart = parseInt(document.getElementById('femaleStart').value);
                const femaleEnd = parseInt(document.getElementById('femaleEnd').value);

                // é©—è­‰è¼¸å…¥
                if (maleStart > maleEnd || femaleStart > femaleEnd) {
                    alert('åº§è™Ÿç¯„åœè¨­å®šéŒ¯èª¤ï¼èµ·å§‹è™Ÿç¢¼ä¸èƒ½å¤§æ–¼çµæŸè™Ÿç¢¼');
                    return;
                }

                if (maleEnd >= femaleStart && maleStart <= femaleEnd) {
                    alert('ç”·ç”Ÿå’Œå¥³ç”Ÿçš„åº§è™Ÿç¯„åœä¸èƒ½é‡ç–Šï¼');
                    return;
                }

                const maxSeatNumber = Math.max(maleEnd, femaleEnd);
                if (totalStudents < maxSeatNumber) {
                    alert(`ç¸½å­¸ç”Ÿæ•¸é‡ä¸èƒ½å°‘æ–¼æœ€å¤§åº§è™Ÿ ${maxSeatNumber}ï¼`);
                    return;
                }

                if (!confirm('ç¢ºå®šè¦é‡æ–°è¨­å®šæ‰€æœ‰å­¸ç”Ÿè³‡æ–™å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰ç¾æœ‰è³‡æ–™ï¼')) {
                    return;
                }

                // é‡ç½®æ‰€æœ‰è³‡æ–™
                this.students = [];
                this.normalSeats = {};
                this.groupSeats = {};
                this.examSeats = {};
                this.freeSeats = {};
                this.scores = {};
                this.scoreHistory = {};
                this.selectedStudent = null;

                // å‰µå»ºæ–°çš„å­¸ç”Ÿè³‡æ–™
                for (let i = 1; i <= totalStudents; i++) {
                    let gender = 'male'; // é è¨­ç”·ç”Ÿ
                    
                    // åˆ¤æ–·æ€§åˆ¥
                    if (i >= maleStart && i <= maleEnd) {
                        gender = 'male';
                    } else if (i >= femaleStart && i <= femaleEnd) {
                        gender = 'female';
                    } else {
                        // å¦‚æœåº§è™Ÿä¸åœ¨æŒ‡å®šç¯„åœå…§ï¼Œæ ¹æ“šèˆ‡ç”·ç”Ÿ/å¥³ç”Ÿç¯„åœçš„è·é›¢ä¾†åˆ¤æ–·
                        const distanceToMale = Math.min(Math.abs(i - maleStart), Math.abs(i - maleEnd));
                        const distanceToFemale = Math.min(Math.abs(i - femaleStart), Math.abs(i - femaleEnd));
                        gender = distanceToMale <= distanceToFemale ? 'male' : 'female';
                    }

                    this.students.push({
                        id: i,
                        seatNumber: i,
                        name: `å­¸ç”Ÿ${i}`,
                        gender: gender
                    });
                }

                this.saveData();
                this.renderStudentList();
                this.renderSeats();
                this.hideBatchModal();
                
                alert(`æˆåŠŸè¨­å®š ${totalStudents} ä½å­¸ç”Ÿï¼\nç”·ç”Ÿï¼š${maleStart}-${maleEnd}è™Ÿ\nå¥³ç”Ÿï¼š${femaleStart}-${femaleEnd}è™Ÿ`);
            }

            // è¨ˆæ™‚å™¨ç›¸é—œæ–¹æ³•
            showTimerModal() {
                const modal = document.getElementById('timerModal');
                this.updateTimerDisplay();
                this.setupQuickTimeButtons();
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            hideTimerModal() {
                document.getElementById('timerModal').classList.add('hidden');
                document.getElementById('timerModal').classList.remove('flex');
            }

            setupQuickTimeButtons() {
                const quickButtons = document.querySelectorAll('.quick-time-btn');
                quickButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (!this.timerRunning) {
                            const minutes = parseInt(btn.dataset.minutes);
                            const seconds = parseInt(btn.dataset.seconds);
                            document.getElementById('timerMinutes').value = minutes;
                            document.getElementById('timerSeconds').value = seconds;
                            this.timerRemaining = minutes * 60 + seconds;
                            this.updateTimerDisplay();
                        }
                    });
                });
            }

            startTimer() {
                if (this.timerRunning && !this.timerPaused) return;

                if (!this.timerPaused) {
                    // æ–°é–‹å§‹è¨ˆæ™‚
                    const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
                    const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
                    this.timerRemaining = minutes * 60 + seconds;
                    
                    if (this.timerRemaining <= 0) {
                        alert('è«‹è¨­å®šè¨ˆæ™‚æ™‚é–“ï¼');
                        return;
                    }
                }

                this.timerRunning = true;
                this.timerPaused = false;
                
                this.updateTimerButtons();
                this.updateTimerStatus('è¨ˆæ™‚é€²è¡Œä¸­...');
                
                this.timerInterval = setInterval(() => {
                    this.timerRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.timerRemaining <= 0) {
                        this.timerFinished();
                    }
                }, 1000);
            }

            pauseTimer() {
                if (!this.timerRunning) return;
                
                this.timerPaused = true;
                clearInterval(this.timerInterval);
                this.updateTimerButtons();
                this.updateTimerStatus('è¨ˆæ™‚å·²æš«åœ');
            }

            resumeTimer() {
                if (!this.timerPaused) return;
                
                this.timerPaused = false;
                this.updateTimerButtons();
                this.updateTimerStatus('è¨ˆæ™‚é€²è¡Œä¸­...');
                
                this.timerInterval = setInterval(() => {
                    this.timerRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.timerRemaining <= 0) {
                        this.timerFinished();
                    }
                }, 1000);
            }

            stopTimer() {
                this.timerRunning = false;
                this.timerPaused = false;
                clearInterval(this.timerInterval);
                
                // é‡ç½®æ™‚é–“
                const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
                const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
                this.timerRemaining = minutes * 60 + seconds;
                
                this.updateTimerDisplay();
                this.updateTimerButtons();
                this.updateTimerStatus('è¨ˆæ™‚å™¨å·²åœæ­¢');
            }

            timerFinished() {
                this.timerRunning = false;
                this.timerPaused = false;
                clearInterval(this.timerInterval);
                
                this.updateTimerButtons();
                this.updateTimerStatus('â° æ™‚é–“åˆ°ï¼');
                
                // æ’­æ”¾éŸ¿éˆ´éŸ³æ•ˆ
                this.playAlarmSound();
                
                // é¡¯ç¤ºé€šçŸ¥
                this.showTimeUpNotification();
            }

            playAlarmSound() {
                // å‰µå»ºéŸ³é »ä¸Šä¸‹æ–‡ä¾†ç”ŸæˆéŸ¿éˆ´éŸ³æ•ˆ
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // æ’­æ”¾äº”æ¬¡éŸ¿éˆ´
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            // å‰µå»ºæŒ¯ç›ªå™¨
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            // é€£æ¥ç¯€é»
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            // è¨­å®šéŸ³é »åƒæ•¸
                            oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz éŸ¿éˆ´éŸ³
                            oscillator.type = 'sine';
                            
                            // è¨­å®šéŸ³é‡åŒ…çµ¡
                            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                            
                            // æ’­æ”¾éŸ³æ•ˆ
                            oscillator.start(audioContext.currentTime);
                            oscillator.stop(audioContext.currentTime + 0.5);
                        }, i * 600); // æ¯æ¬¡é–“éš”600æ¯«ç§’
                    }
                } catch (error) {
                    console.log('ç„¡æ³•æ’­æ”¾éŸ³æ•ˆ:', error);
                }
            }

            showTimeUpNotification() {
                // é¡¯ç¤ºç€è¦½å™¨é€šçŸ¥ï¼ˆå¦‚æœç”¨æˆ¶å…è¨±ï¼‰
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        new Notification('â° è¨ˆæ™‚å™¨æé†’', {
                            body: 'è¨­å®šçš„æ™‚é–“å·²åˆ°ï¼',
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>'
                        });
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                new Notification('â° è¨ˆæ™‚å™¨æé†’', {
                                    body: 'è¨­å®šçš„æ™‚é–“å·²åˆ°ï¼'
                                });
                            }
                        });
                    }
                }
                
                // é¡¯ç¤ºå½ˆçª—æé†’
                alert('â° æ™‚é–“åˆ°ï¼\n\nè¨­å®šçš„è¨ˆæ™‚æ™‚é–“å·²çµæŸã€‚');
            }

            updateTimerDisplay() {
                const display = document.getElementById('timerDisplay');
                const minutes = Math.floor(this.timerRemaining / 60);
                const seconds = this.timerRemaining % 60;
                
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                display.textContent = timeString;
                
                // æ ¹æ“šå‰©é¤˜æ™‚é–“æ·»åŠ è¦–è¦ºæ•ˆæœ
                display.classList.remove('timer-warning', 'timer-critical');
                
                if (this.timerRunning && !this.timerPaused) {
                    if (this.timerRemaining <= 10 && this.timerRemaining > 0) {
                        display.classList.add('timer-critical');
                    } else if (this.timerRemaining <= 60 && this.timerRemaining > 10) {
                        display.classList.add('timer-warning');
                    }
                }
            }

            updateTimerButtons() {
                const startBtn = document.getElementById('startTimer');
                const pauseBtn = document.getElementById('pauseTimer');
                const resumeBtn = document.getElementById('resumeTimer');
                const stopBtn = document.getElementById('stopTimer');
                const settings = document.getElementById('timerSettings');
                
                if (this.timerRunning && !this.timerPaused) {
                    // è¨ˆæ™‚é€²è¡Œä¸­
                    startBtn.classList.add('hidden');
                    pauseBtn.classList.remove('hidden');
                    resumeBtn.classList.add('hidden');
                    settings.style.opacity = '0.5';
                    settings.style.pointerEvents = 'none';
                } else if (this.timerPaused) {
                    // è¨ˆæ™‚æš«åœä¸­
                    startBtn.classList.add('hidden');
                    pauseBtn.classList.add('hidden');
                    resumeBtn.classList.remove('hidden');
                    settings.style.opacity = '0.5';
                    settings.style.pointerEvents = 'none';
                } else {
                    // è¨ˆæ™‚åœæ­¢
                    startBtn.classList.remove('hidden');
                    pauseBtn.classList.add('hidden');
                    resumeBtn.classList.add('hidden');
                    settings.style.opacity = '1';
                    settings.style.pointerEvents = 'auto';
                }
            }

            updateTimerStatus(status) {
                document.getElementById('timerStatus').textContent = status;
            }
        }

        // åˆå§‹åŒ–ç³»çµ±
        const classroom = new ClassroomManager();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98c33f56c585f20d',t:'MTc2MDA2OTIxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
